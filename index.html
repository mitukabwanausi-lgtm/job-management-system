<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Dashboard - Job Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'system-ui', '-apple-system', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .editable-cell {
            cursor: pointer;
            padding: 8px;
            min-height: 40px;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .editable-cell:hover {
            background-color: #f3f4f6;
            border-color: #3b82f6;
        }

        .editing {
            background-color: #fff;
            border-color: #3b82f6;
        }

        /* Table borders for all devices */
        table {
            border-collapse: collapse;
        }

        table th,
        table td {
            border: 1px solid #d1d5db;
        }

        @media (max-width: 768px) {
            .editable-cell {
                cursor: pointer;
                min-width: 100px;
                font-size: 13px;
            }

            /* Ensure date column is never truncated */
            td:first-child {
                min-width: 140px !important;
                white-space: nowrap !important;
            }

            .editable-cell:hover {
                background-color: #f3f4f6;
                border-color: #3b82f6;
            }

            /* Make table text smaller on mobile for better fit */
            table {
                font-size: 13px;
                border-collapse: collapse;
            }

            th {
                font-size: 11px;
                padding: 4px 8px !important;
                border: 1px solid #9ca3af;
            }

            td {
                padding: 4px 8px !important;
                border: 1px solid #9ca3af;
            }
        }

        #mobileMenu {
            transition: transform 0.3s ease-in-out;
        }

        .job-card {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .job-card:active {
            transform: scale(0.98);
        }

        .date-header {
            position: sticky;
            top: 64px;
            z-index: 20;
            background: linear-gradient(to bottom, #f9fafb 0%, #f3f4f6 100%);
        }

        .material-icons {
            vertical-align: middle;
            font-size: 20px;
        }

        .material-icons.md-18 {
            font-size: 18px;
        }

        .material-icons.md-24 {
            font-size: 24px;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .spin {
            animation: spin 1s linear infinite;
        }

        /* Mobile table improvements */
        @media (max-width: 768px) {
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
            }

            .overflow-x-auto::-webkit-scrollbar {
                height: 6px;
            }

            .overflow-x-auto::-webkit-scrollbar-track {
                background: #f1f1f1;
            }

            .overflow-x-auto::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 3px;
            }

            /* Better tap targets on mobile */
            .editable-cell {
                touch-action: manipulation;
            }

            /* Make action buttons more mobile-friendly */
            td button {
                padding: 6px 12px;
                font-size: 13px;
            }
        }

        .in-progress-row {
            background-color: #ff9966 !important;
        }

        /* Sticky first column */
        table thead th:first-child,
        table tbody td:first-child {
            position: sticky;
            left: 0;
            background: white;
            z-index: 10;
            box-shadow: 2px 0 4px rgba(0, 0, 0, 0.1);
        }

        table thead th:first-child {
            z-index: 20;
            background: #f9fafb;
            /* matches thead bg-gray-50 */
        }

        /* Keep background color for in-progress rows on sticky column */
        .in-progress-row td:first-child {
            background-color: #ff9966 !important;
        }

        /* Sticky table header */
        table thead {
            position: sticky;
            top: 0;
            z-index: 30;
            background: #f9fafb;
        }

        table thead th {
            background: #f9fafb;
        }
    </style>
</head>

<body class="bg-gray-50">
    <div id="app"></div>
    <div id="mobileMenuOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40" onclick="toggleMobileMenu()">
    </div>
    <div id="mobileMenu" class="fixed top-0 left-0 h-full w-64 bg-white shadow-xl z-50 transform -translate-x-full">
        <div class="p-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold text-gray-900">Menu</h2>
                <button onclick="toggleMobileMenu()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <nav class="space-y-2">
                <button onclick="changeView('dashboard'); toggleMobileMenu();"
                    class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 text-gray-700 font-medium flex items-center gap-3">
                    <span class="material-icons md-18">dashboard</span> Dashboard
                </button>
                <button onclick="changeView('create-job'); toggleMobileMenu();"
                    class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 text-gray-700 font-medium flex items-center gap-3">
                    <span class="material-icons md-18">add_circle</span> Create Job
                </button>
                <button onclick="changeView('all-jobs'); toggleMobileMenu();"
                    class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 text-gray-700 font-medium flex items-center gap-3">
                    <span class="material-icons md-18">assignment</span> Active Jobs
                </button>
                <button onclick="changeView('completed-jobs'); toggleMobileMenu();"
                    class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 text-gray-700 font-medium flex items-center gap-3">
                    <span class="material-icons md-18">check_circle</span> Completed Jobs
                </button>
                <button onclick="changeView('staff-management'); toggleMobileMenu();"
                    class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 text-gray-700 font-medium flex items-center gap-3">
                    <span class="material-icons md-18">group</span> Staff
                </button>
                <hr class="my-4">
                <button onclick="logout(); toggleMobileMenu();"
                    class="w-full text-left px-4 py-3 rounded-lg hover:bg-red-50 text-red-600 font-medium flex items-center gap-3">
                    <span class="material-icons md-18">logout</span> Logout
                </button>
            </nav>
        </div>
    </div>
    <div id="mobileJobModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg my-8">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-900">Job Details</h2>
                    <button onclick="closeMobileJobModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="mobileJobContent" class="space-y-4"></div>
                <div class="flex gap-3 mt-6">
                    <button onclick="editJobFromMobile()"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg">Edit</button>
                    <button onclick="closeMobileJobModal()"
                        class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-medium py-3 px-6 rounded-lg">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    <div id="editJobModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 overflow-y-auto">
        <div class="flex min-h-screen items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl my-8 max-h-[90vh] flex flex-col">
                <div class="p-6 border-b flex-shrink-0">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900">Edit Job</h2>
                        <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="p-6 overflow-y-auto flex-1">
                    <form id="editJobForm" onsubmit="handleEditSubmit(event)" class="space-y-4">
                        <input type="hidden" id="edit_job_id">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Date *</label><input
                                    type="date" id="edit_date" required class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Start Time *</label><select
                                    id="edit_start_time" required class="w-full px-4 py-2 border rounded-lg"></select>
                            </div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">End Time *</label><select
                                    id="edit_end_time" required class="w-full px-4 py-2 border rounded-lg"></select>
                            </div>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Assign To</label><select
                                id="edit_assigned_to" class="w-full px-4 py-2 border rounded-lg"></select></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                            <select id="edit_status" class="w-full px-4 py-2 border rounded-lg">
                                <option value="Unassigned">Unassigned</option>
                                <option value="Assigned">Assigned</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Reschedule">Reschedule</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Client Name *</label><input
                                type="text" id="edit_client_name" required class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Address *</label><textarea
                                id="edit_address" required rows="2"
                                class="w-full px-4 py-2 border rounded-lg"></textarea>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Suburb *</label><input
                                type="text" id="edit_suburb" list="suburbList" required
                                class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Phone *</label><input
                                type="tel" id="edit_client_phone" required class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Job Description
                                *</label><textarea id="edit_job_description" required rows="4"
                                class="w-full px-4 py-2 border rounded-lg"></textarea></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Price ($) *</label><input
                                type="number" step="0.01" id="edit_price" required
                                class="w-full px-4 py-2 border rounded-lg"></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">GST</label>
                            <div class="space-y-2">
                                <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                    <input type="radio" name="edit_price_includes_gst" value="false"
                                        class="w-4 h-4 text-green-600">
                                    <span class="ml-3">Price +GST</span>
                                </label>
                                <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                    <input type="radio" name="edit_price_includes_gst" value="true"
                                        class="w-4 h-4 text-gray-600">
                                    <span class="ml-3">Price excl GST</span>
                                </label>
                            </div>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Email</label><input
                                type="email" id="edit_client_email" class="w-full px-4 py-2 border rounded-lg"></div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Amount Paid
                                    ($)</label><input type="number" step="0.01" id="edit_amount_paid"
                                    class="w-full px-4 py-2 border rounded-lg"></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Payment
                                    Method</label><select id="edit_payment_method"
                                    class="w-full px-4 py-2 border rounded-lg">
                                    <option value="">Not specified</option>
                                    <option value="Cash">Cash</option>
                                    <option value="Bank Transfer/Check">Bank Transfer/Check</option>
                                </select></div>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Photo URL (Google Photos
                                Album)</label><input type="url" id="edit_photo_urls"
                                placeholder="https://photos.google.com/share/..."
                                class="w-full px-4 py-2 border rounded-lg">
                            <p class="text-xs text-gray-500 mt-1">Paste one Google Photos album link</p>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Priority</label><select
                                id="edit_priority" class="w-full px-4 py-2 border rounded-lg">
                                <option value="Normal">Normal</option>
                                <option value="High">High</option>
                                <option value="Urgent">Urgent</option>
                            </select></div>
                    </form>
                </div>
                <div class="p-6 border-t flex-shrink-0">
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button type="submit" form="editJobForm"
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg">Save
                            Changes</button>
                        <button type="button"
                            onclick="deleteJob(document.getElementById('edit_job_id').value); closeEditModal();"
                            class="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-6 rounded-lg">Delete</button>
                        <button type="button" onclick="closeEditModal()"
                            class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-3 px-6 rounded-lg">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="advancedExportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 overflow-y-auto">
        <div class="flex min-h-screen items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl my-8">
                <div class="p-6 border-b">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900">Advanced Export</h2>
                        <button onclick="closeAdvancedExportModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="p-6 max-h-[70vh] overflow-y-auto">
                    <form id="advancedExportForm" class="space-y-6">
                        <!-- Date Range -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Date Range</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">From Date</label>
                                    <input type="date" id="export_from_date" class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">To Date</label>
                                    <input type="date" id="export_to_date" class="w-full px-4 py-2 border rounded-lg">
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">Leave blank to export all dates</p>
                        </div>

                        <!-- Status Filter -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Status</h3>
                            <select id="export_status" class="w-full px-4 py-2 border rounded-lg">
                                <option value="all">All Statuses</option>
                                <option value="Unassigned">Unassigned</option>
                                <option value="Assigned">Assigned</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Reschedule">Reschedule</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>

                        <!-- Staff Filter -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Staff Member</h3>
                            <select id="export_staff" class="w-full px-4 py-2 border rounded-lg">
                                <option value="all">All Staff</option>
                            </select>
                        </div>

                        <!-- Column Selection -->
                        <div>
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-lg font-semibold text-gray-900">Select Columns</h3>
                                <div class="flex gap-2">
                                    <button type="button" onclick="selectAllExportColumns()"
                                        class="text-sm text-blue-600 hover:text-blue-800">Select All</button>
                                    <button type="button" onclick="deselectAllExportColumns()"
                                        class="text-sm text-gray-600 hover:text-gray-800">Deselect All</button>
                                </div>
                            </div>
                            <div
                                class="grid grid-cols-2 gap-3 max-h-60 overflow-y-auto border border-gray-200 rounded-lg p-4">
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_job_number" checked
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Job Number</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_date" checked
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Date</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_day" checked
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Day</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_start_time" checked
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Start Time</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_end_time" checked
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">End Time</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_client_name" checked
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Client Name</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_phone" checked
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Phone</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_email" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Email</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_address" checked
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Address</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_suburb" checked
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Suburb</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_description" checked
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Description</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_assigned_to" checked
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Assigned To</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_status" checked
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Status</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_priority"
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Priority</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_price" checked
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Price</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_gst" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">GST</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_amount_paid"
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Amount Paid</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_payment_method"
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Payment Method</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_actual_start"
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Actual Start</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_actual_end"
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Actual End</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_photo_url"
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Photo URL</span>
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="p-6 border-t">
                    <div class="flex gap-3">
                        <button onclick="executeAdvancedExport()"
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-lg">
                            Export CSV
                        </button>
                        <button onclick="closeAdvancedExportModal()"
                            class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-3 px-6 rounded-lg">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const SUPABASE_URL = 'https://ssxcjsdoxtgddnkugntl.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzeGNqc2RveHRnZGRua3VnbnRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NDEwODgsImV4cCI6MjA3NzMxNzA4OH0.C-lkPRJtFYa7YAgPavXRIGvV1LPkCXOJQYoVrZ4nCMw';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = null;
        let currentView = 'dashboard';
        let jobs = [];
        let staff = [];
        let selectedMobileJob = null;
        let currentStaffFilter = '';
        let showAllColumns = false;
        let visibleColumns = {
            date: true,
            start_time: true,
            end_time: true,
            assigned_to: true,
            status: true,
            client_name: true,
            address: true,
            suburb: true,
            phone: true,
            description: true,
            price: true,
            email: false,
            amount_paid: false,
            payment_method: false,
            photos: false
        };
        let columnSelectorOpen = false;

        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const overlay = document.getElementById('mobileMenuOverlay');
            if (menu.classList.contains('-translate-x-full')) {
                menu.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                menu.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        async function login(username, password) {
            try {
                const {data, error} = await supabase.from('manager_users').select('*').eq('username', username).eq('password', password).single();
                if (error || !data) {alert('Invalid username or password'); return false;}
                currentUser = data;
                localStorage.setItem('manager_user', JSON.stringify(data));
                await loadStaff();
                await loadJobs();
                renderApp();
                return true;
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed');
                return false;
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('manager_user');
            renderApp();
        }

        function checkAuth() {
            const stored = localStorage.getItem('manager_user');
            if (stored) currentUser = JSON.parse(stored);
        }

        async function loadJobs() {
            try {
                const {data, error} = await supabase.from('jobs').select('*, staff:assigned_to (full_name, color_code)').order('date', {ascending: true}).order('start_time', {ascending: true});
                if (error) throw error;
                jobs = data || [];
                populateSuburbList();
                return jobs;
            } catch (error) {
                console.error('Error loading jobs:', error);
                return [];
            }
        }

        function populateSuburbList() {
            const suburbs = [...new Set(jobs.map(j => j.suburb).filter(s => s))];
            const datalist = document.getElementById('suburbList');
            if (datalist) {
                datalist.innerHTML = suburbs.map(s => '<option value="' + s + '">').join('');
            }
        }

        async function loadStaff() {
            try {
                const {data, error} = await supabase.from('staff').select('*').eq('active', true).order('full_name');
                if (error) throw error;
                staff = data || [];
                return staff;
            } catch (error) {
                console.error('Error loading staff:', error);
                return [];
            }
        }

        function toggleColumns() {
            showAllColumns = !showAllColumns;
            renderApp();
        }

        function toggleColumnSelector() {
            columnSelectorOpen = !columnSelectorOpen;
            renderApp();
        }

        function toggleColumn(columnKey) {
            visibleColumns[columnKey] = !visibleColumns[columnKey];
            renderApp();
        }

        function selectAllColumns() {
            Object.keys(visibleColumns).forEach(key => {
                visibleColumns[key] = true;
            });
            renderApp();
        }

        function deselectAllColumns() {
            Object.keys(visibleColumns).forEach(key => {
                visibleColumns[key] = false;
            });
            // Keep essential columns visible
            visibleColumns.date = true;
            visibleColumns.status = true;
            visibleColumns.client_name = true;
            renderApp();
        }

        function generateCSV(jobsData, filterType) {
            // CSV Headers
            const headers = [
                'Job Number',
                'Date',
                'Day',
                'Start Time',
                'End Time',
                'Client Name',
                'Phone',
                'Email',
                'Address',
                'Suburb',
                'Job Description',
                'Assigned To',
                'Status',
                'Priority',
                'Price',
                'GST',
                'Amount Paid',
                'Payment Method',
                'Actual Start',
                'Actual End',
                'Photo URL'
            ];

            // Convert jobs to CSV rows
            const rows = jobsData.map(job => {
                const jobDate = new Date(job.date);
                const dayName = jobDate.toLocaleDateString('en-US', {weekday: 'long'});

                return [
                    job.job_number || '',
                    job.date || '',
                    dayName,
                    job.start_time ? formatTime12Hour(job.start_time) : '',
                    job.end_time ? formatTime12Hour(job.end_time) : '',
                    job.client_name || '',
                    job.client_phone || '',
                    job.client_email || '',
                    job.address || '',
                    job.suburb || '',
                    job.job_description || '',
                    job.staff ? job.staff.full_name : 'Unassigned',
                    job.status || '',
                    job.priority || '',
                    job.price || '',
                    job.price_includes_gst ? 'Excl GST' : '+GST',
                    job.amount_paid || '',
                    job.payment_method || '',
                    job.actual_start_time ? new Date(job.actual_start_time).toLocaleString() : '',
                    job.actual_end_time ? new Date(job.actual_end_time).toLocaleString() : '',
                    job.photo_urls && job.photo_urls.length > 0 ? job.photo_urls[0] : ''
                ];
            });

            // Escape CSV values (handle commas and quotes)
            const escapeCSV = (value) => {
                if (value === null || value === undefined) return '';
                const stringValue = String(value);
                if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
                    return '"' + stringValue.replace(/"/g, '""') + '"';
                }
                return stringValue;
            };

            // Build CSV content
            let csv = headers.map(escapeCSV).join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(escapeCSV).join(',') + '\n';
            });

            // Create download
            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            const timestamp = new Date().toISOString().split('T')[0];
            const filename = `jobs_export_${filterType}_${timestamp}.csv`;

            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function openAdvancedExportModal() {
            // Populate staff dropdown
            const staffSelect = document.getElementById('export_staff');
            if (staffSelect) {
                const staffOptions = staff.map(s => '<option value="' + s.id + '">' + s.full_name + '</option>').join('');
                staffSelect.innerHTML = '<option value="all">All Staff</option>' + staffOptions;
            }

            // Set default dates (last 30 days to today)
            const today = new Date();
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(today.getDate() - 30);

            document.getElementById('export_to_date').value = today.toISOString().split('T')[0];
            document.getElementById('export_from_date').value = thirtyDaysAgo.toISOString().split('T')[0];

            document.getElementById('advancedExportModal').classList.remove('hidden');
        }

        function closeAdvancedExportModal() {
            document.getElementById('advancedExportModal').classList.add('hidden');
        }

        function selectAllExportColumns() {
            document.querySelectorAll('[id^="export_col_"]').forEach(checkbox => {
                checkbox.checked = true;
            });
        }

        function deselectAllExportColumns() {
            document.querySelectorAll('[id^="export_col_"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        function executeAdvancedExport() {
            // Get filter values
            const fromDate = document.getElementById('export_from_date').value;
            const toDate = document.getElementById('export_to_date').value;
            const status = document.getElementById('export_status').value;
            const staffId = document.getElementById('export_staff').value;

            // Get selected columns
            const selectedColumns = {
                job_number: document.getElementById('export_col_job_number').checked,
                date: document.getElementById('export_col_date').checked,
                day: document.getElementById('export_col_day').checked,
                start_time: document.getElementById('export_col_start_time').checked,
                end_time: document.getElementById('export_col_end_time').checked,
                client_name: document.getElementById('export_col_client_name').checked,
                phone: document.getElementById('export_col_phone').checked,
                email: document.getElementById('export_col_email').checked,
                address: document.getElementById('export_col_address').checked,
                suburb: document.getElementById('export_col_suburb').checked,
                description: document.getElementById('export_col_description').checked,
                assigned_to: document.getElementById('export_col_assigned_to').checked,
                status: document.getElementById('export_col_status').checked,
                priority: document.getElementById('export_col_priority').checked,
                price: document.getElementById('export_col_price').checked,
                gst: document.getElementById('export_col_gst').checked,
                amount_paid: document.getElementById('export_col_amount_paid').checked,
                payment_method: document.getElementById('export_col_payment_method').checked,
                actual_start: document.getElementById('export_col_actual_start').checked,
                actual_end: document.getElementById('export_col_actual_end').checked,
                photo_url: document.getElementById('export_col_photo_url').checked
            };

            // Filter jobs
            let filteredJobs = jobs;

            // Filter by date range
            if (fromDate) {
                filteredJobs = filteredJobs.filter(j => j.date >= fromDate);
            }
            if (toDate) {
                filteredJobs = filteredJobs.filter(j => j.date <= toDate);
            }

            // Filter by status
            if (status !== 'all') {
                filteredJobs = filteredJobs.filter(j => j.status === status);
            }

            // Filter by staff
            if (staffId !== 'all') {
                filteredJobs = filteredJobs.filter(j => j.assigned_to === staffId);
            }

            if (filteredJobs.length === 0) {
                alert('No jobs match your selected filters.');
                return;
            }

            // Generate CSV with selected columns
            generateAdvancedCSV(filteredJobs, selectedColumns);
            closeAdvancedExportModal();
        }

        function generateAdvancedCSV(jobsData, selectedColumns) {
            // Build headers based on selected columns
            const headers = [];
            if (selectedColumns.job_number) headers.push('Job Number');
            if (selectedColumns.date) headers.push('Date');
            if (selectedColumns.day) headers.push('Day');
            if (selectedColumns.start_time) headers.push('Start Time');
            if (selectedColumns.end_time) headers.push('End Time');
            if (selectedColumns.client_name) headers.push('Client Name');
            if (selectedColumns.phone) headers.push('Phone');
            if (selectedColumns.email) headers.push('Email');
            if (selectedColumns.address) headers.push('Address');
            if (selectedColumns.suburb) headers.push('Suburb');
            if (selectedColumns.description) headers.push('Job Description');
            if (selectedColumns.assigned_to) headers.push('Assigned To');
            if (selectedColumns.status) headers.push('Status');
            if (selectedColumns.priority) headers.push('Priority');
            if (selectedColumns.price) headers.push('Price');
            if (selectedColumns.gst) headers.push('GST');
            if (selectedColumns.amount_paid) headers.push('Amount Paid');
            if (selectedColumns.payment_method) headers.push('Payment Method');
            if (selectedColumns.actual_start) headers.push('Actual Start');
            if (selectedColumns.actual_end) headers.push('Actual End');
            if (selectedColumns.photo_url) headers.push('Photo URL');

            // Build rows based on selected columns
            const rows = jobsData.map(job => {
                const row = [];
                const jobDate = new Date(job.date);
                const dayName = jobDate.toLocaleDateString('en-US', {weekday: 'long'});

                if (selectedColumns.job_number) row.push(job.job_number || '');
                if (selectedColumns.date) row.push(job.date || '');
                if (selectedColumns.day) row.push(dayName);
                if (selectedColumns.start_time) row.push(job.start_time ? formatTime12Hour(job.start_time) : '');
                if (selectedColumns.end_time) row.push(job.end_time ? formatTime12Hour(job.end_time) : '');
                if (selectedColumns.client_name) row.push(job.client_name || '');
                if (selectedColumns.phone) row.push(job.client_phone || '');
                if (selectedColumns.email) row.push(job.client_email || '');
                if (selectedColumns.address) row.push(job.address || '');
                if (selectedColumns.suburb) row.push(job.suburb || '');
                if (selectedColumns.description) row.push(job.job_description || '');
                if (selectedColumns.assigned_to) row.push(job.staff ? job.staff.full_name : 'Unassigned');
                if (selectedColumns.status) row.push(job.status || '');
                if (selectedColumns.priority) row.push(job.priority || '');
                if (selectedColumns.price) row.push(job.price || '');
                if (selectedColumns.gst) row.push(job.price_includes_gst ? 'Excl GST' : '+GST');
                if (selectedColumns.amount_paid) row.push(job.amount_paid || '');
                if (selectedColumns.payment_method) row.push(job.payment_method || '');
                if (selectedColumns.actual_start) row.push(job.actual_start_time ? new Date(job.actual_start_time).toLocaleString() : '');
                if (selectedColumns.actual_end) row.push(job.actual_end_time ? new Date(job.actual_end_time).toLocaleString() : '');
                if (selectedColumns.photo_url) row.push(job.photo_urls && job.photo_urls.length > 0 ? job.photo_urls[0] : '');

                return row;
            });

            // Escape CSV values
            const escapeCSV = (value) => {
                if (value === null || value === undefined) return '';
                const stringValue = String(value);
                if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
                    return '"' + stringValue.replace(/"/g, '""') + '"';
                }
                return stringValue;
            };

            // Build CSV content
            let csv = headers.map(escapeCSV).join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(escapeCSV).join(',') + '\n';
            });

            // Add summary rows if amount_paid column is selected
            if (selectedColumns.amount_paid) {
                // Add blank row for separation
                csv += '\n';

                // Calculate totals
                const totalJobs = jobsData.length;
                const totalRevenue = jobsData.reduce((sum, j) => sum + (parseFloat(j.amount_paid) || 0), 0);
                const cashTotal = jobsData.filter(j => j.payment_method === 'Cash').reduce((sum, j) => sum + (parseFloat(j.amount_paid) || 0), 0);
                const bankTotal = jobsData.filter(j => j.payment_method === 'Bank Transfer/Check').reduce((sum, j) => sum + (parseFloat(j.amount_paid) || 0), 0);

                // Find which column index has amount_paid
                let amountPaidIndex = 0;
                let currentIndex = 0;
                if (selectedColumns.job_number) currentIndex++;
                if (selectedColumns.date) currentIndex++;
                if (selectedColumns.day) currentIndex++;
                if (selectedColumns.start_time) currentIndex++;
                if (selectedColumns.end_time) currentIndex++;
                if (selectedColumns.client_name) currentIndex++;
                if (selectedColumns.phone) currentIndex++;
                if (selectedColumns.email) currentIndex++;
                if (selectedColumns.address) currentIndex++;
                if (selectedColumns.suburb) currentIndex++;
                if (selectedColumns.description) currentIndex++;
                if (selectedColumns.assigned_to) currentIndex++;
                if (selectedColumns.status) currentIndex++;
                if (selectedColumns.priority) currentIndex++;
                if (selectedColumns.price) currentIndex++;
                if (selectedColumns.gst) currentIndex++;
                amountPaidIndex = currentIndex;

                // Create summary rows
                const emptyColumns = new Array(amountPaidIndex).fill('');

                // Total Jobs row
                csv += [...emptyColumns, 'TOTAL JOBS:', totalJobs].map(escapeCSV).join(',') + '\n';

                // Total Revenue row
                csv += [...emptyColumns, 'TOTAL REVENUE:', '$' + totalRevenue.toFixed(2)].map(escapeCSV).join(',') + '\n';

                // Cash Total row
                csv += [...emptyColumns, 'CASH TOTAL:', '$' + cashTotal.toFixed(2)].map(escapeCSV).join(',') + '\n';

                // Bank Total row
                csv += [...emptyColumns, 'BANK TOTAL:', '$' + bankTotal.toFixed(2)].map(escapeCSV).join(',') + '\n';
            }

            // Create download
            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            const timestamp = new Date().toISOString().split('T')[0];
            const filename = `jobs_export_advanced_${timestamp}.csv`;

            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function formatDateWithDay(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const options = {weekday: 'short', day: 'numeric', month: 'short', year: 'numeric'};
            return date.toLocaleDateString('en-US', options);
        }

        function getDateColor(dateString) {
            if (!dateString) return '#f3f4f6';

            // Generate a consistent color based on the date string
            // This ensures same dates always get the same color
            const colors = [
                '#dbeafe', // blue-100
                '#fce7f3', // pink-100
                '#ddd6fe', // violet-100
                '#fbcfe8', // fuchsia-100
                '#e9d5ff', // purple-100
                '#fef3c7', // amber-100
                '#fed7aa', // orange-100
                '#d1fae5', // emerald-100
                '#a7f3d0', // green-100
                '#fecaca', // red-100
                '#bfdbfe', // blue-200
                '#f9a8d4', // pink-200
                '#c4b5fd', // violet-200
                '#f5d0fe', // fuchsia-200
                '#e9d5ff', // purple-200
                '#fde68a', // amber-200
                '#fed7aa', // orange-200
                '#6ee7b7', // emerald-200
            ];

            // Create a hash from the date string
            let hash = 0;
            for (let i = 0; i < dateString.length; i++) {
                hash = dateString.charCodeAt(i) + ((hash << 5) - hash);
            }

            // Use the hash to pick a color consistently
            const index = Math.abs(hash) % colors.length;
            return colors[index];
        }

        function getDateTextColor(dateString) {
            if (!dateString) return '#374151';

            // Corresponding darker text colors for readability
            const textColors = [
                '#1e40af', // blue-800
                '#be185d', // pink-800
                '#5b21b6', // violet-800
                '#a21caf', // fuchsia-800
                '#6b21a8', // purple-800
                '#b45309', // amber-800
                '#c2410c', // orange-800
                '#065f46', // emerald-800
                '#047857', // green-800
                '#991b1b', // red-800
                '#1e3a8a', // blue-900
                '#831843', // pink-900
                '#4c1d95', // violet-900
                '#701a75', // fuchsia-900
                '#581c87', // purple-900
                '#78350f', // amber-900
                '#7c2d12', // orange-900
                '#064e3b', // emerald-900
            ];

            // Same hash logic to match the background color
            let hash = 0;
            for (let i = 0; i < dateString.length; i++) {
                hash = dateString.charCodeAt(i) + ((hash << 5) - hash);
            }

            const index = Math.abs(hash) % textColors.length;
            return textColors[index];
        }

        async function updateJobField(jobId, field, value) {
            //if (window.innerWidth <= 768) return;
            try {
                const job = jobs.find(j => j.id === jobId);
                if (!job) throw new Error('Job not found');

                const {error} = await supabase.from('jobs').update({[field]: value}).eq('id', jobId);
                if (error) throw error;

                // Save scroll position before reload
                const scrollPosition = window.scrollY;

                await loadJobs();
                renderApp();

                // Restore scroll position after render
                setTimeout(() => {
                    window.scrollTo(0, scrollPosition);
                }, 0);

                return true;
            } catch (error) {
                console.error('Error updating job:', error);
                alert('Failed to update: ' + error.message);
                return false;
            }
        }

        function formatTime12Hour(time24) {
            if (!time24) return '';
            const parts = time24.split(':');
            const hour = parseInt(parts[0]);
            const minutes = parts[1];
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const hour12 = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
            return hour12 + ':' + minutes + ' ' + ampm;
        }

        function makeEditable(jobId, field, currentValue, type) {
            const cellId = 'cell-' + jobId + '-' + field;
            const cell = document.getElementById(cellId);
            if (!cell || cell.classList.contains('editing')) return;
            cell.classList.add('editing');
            const originalContent = cell.innerHTML;
            let input;
            if (type === 'date') {
                input = document.createElement('input');
                input.type = 'date';
                input.value = currentValue || '';
                input.className = 'w-full px-2 py-1 border border-blue-500 rounded focus:outline-none';
            } else if (type === 'time') {
                input = document.createElement('select');
                input.className = 'w-full px-2 py-1 border border-blue-500 rounded focus:outline-none';
                input.innerHTML = '<option value="">Select...</option>' + generateTimeOptions(currentValue);
            } else if (type === 'select-status') {
                input = document.createElement('select');
                input.className = 'w-full px-2 py-1 border border-blue-500 rounded focus:outline-none';
                const statuses = ['Unassigned', 'Assigned', 'In Progress', 'Reschedule', 'Completed'];
                input.innerHTML = statuses.map(s => '<option value="' + s + '"' + (currentValue === s ? ' selected' : '') + '>' + s + '</option>').join('');
            } else if (type === 'select-staff') {
                input = document.createElement('select');
                input.className = 'w-full px-2 py-1 border border-blue-500 rounded focus:outline-none';
                input.innerHTML = '<option value="">Unassigned</option>' + staff.map(s => '<option value="' + s.id + '"' + (currentValue === s.id ? ' selected' : '') + '>' + s.full_name + '</option>').join('');
            } else if (type === 'select-payment') {
                input = document.createElement('select');
                input.className = 'w-full px-2 py-1 border border-blue-500 rounded focus:outline-none';
                const methods = ['', 'Cash', 'Bank Transfer/Check'];
                input.innerHTML = methods.map(m => '<option value="' + m + '"' + (currentValue === m ? ' selected' : '') + '>' + (m || 'Not specified') + '</option>').join('');
            } else if (type === 'number') {
                input = document.createElement('input');
                input.type = 'number';
                input.step = '0.01';
                input.value = currentValue || '';
                input.className = 'w-full px-2 py-1 border border-blue-500 rounded focus:outline-none';
            } else if (type === 'url') {
                input = document.createElement('input');
                input.type = 'url';
                input.value = currentValue || '';
                input.placeholder = 'https://...';
                input.className = 'w-full px-2 py-1 border border-blue-500 rounded focus:outline-none';
            } else if (type === 'textarea') {
                input = document.createElement('textarea');
                input.value = currentValue || '';
                input.rows = 3;
                input.className = 'w-full px-2 py-1 border border-blue-500 rounded focus:outline-none';
            } else {
                input = document.createElement('input');
                input.type = 'text';
                input.value = currentValue || '';
                input.className = 'w-full px-2 py-1 border border-blue-500 rounded focus:outline-none';
            }
            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            const save = async () => {
                const newValue = input.value;
                if (newValue !== currentValue) {
                    const success = await updateJobField(jobId, field, newValue || null);
                    if (!success) {
                        cell.innerHTML = originalContent;
                        cell.classList.remove('editing');
                    }
                } else {
                    cell.innerHTML = originalContent;
                    cell.classList.remove('editing');
                }
            };
            const cancel = () => {
                cell.innerHTML = originalContent;
                cell.classList.remove('editing');
            };
            input.addEventListener('blur', save);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {e.preventDefault(); save();}
                else if (e.key === 'Escape') {e.preventDefault(); cancel();}
            });
            if (type.startsWith('select-') || type === 'time') {
                input.addEventListener('change', save);
            }
        }

        function openMobileJobModal(jobId) {
            const job = jobs.find(j => j.id === jobId);
            if (!job) return;
            selectedMobileJob = job;
            const modal = document.getElementById('mobileJobModal');
            const content = document.getElementById('mobileJobContent');
            const gstBadge = job.price_includes_gst ? '<span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded">incl. GST</span>' : '<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded font-medium">+GST</span>';
            content.innerHTML = '<div class="space-y-3 text-sm">' +
                '<div class="flex justify-between py-2 border-b"><span class="font-semibold text-gray-600">Date:</span><span class="text-gray-900">' + new Date(job.date).toLocaleDateString() + '</span></div>' +
                '<div class="flex justify-between py-2 border-b"><span class="font-semibold text-gray-600">Start Time:</span><span class="text-gray-900">' + formatTime12Hour(job.start_time) + '</span></div>' +
                '<div class="flex justify-between py-2 border-b"><span class="font-semibold text-gray-600">End Time:</span><span class="text-gray-900">' + formatTime12Hour(job.end_time) + '</span></div>' +
                '<div class="flex justify-between py-2 border-b"><span class="font-semibold text-gray-600">Assigned To:</span><span class="text-gray-900">' + (job.staff ? job.staff.full_name : 'Unassigned') + '</span></div>' +
                '<div class="flex justify-between py-2 border-b"><span class="font-semibold text-gray-600">Status:</span><span class="px-2 py-1 rounded-full text-xs font-medium ' + getStatusClass(job.status) + '">' + job.status + '</span></div>' +
                '<div class="flex justify-between py-2 border-b"><span class="font-semibold text-gray-600">Client Name:</span><span class="text-gray-900">' + escapeHtml(job.client_name) + '</span></div>' +
                '<div class="py-2 border-b"><span class="font-semibold text-gray-600 block mb-1">Address:</span><span class="text-gray-900">' + escapeHtml(job.address) + '</span></div>' +
                '<div class="flex justify-between py-2 border-b"><span class="font-semibold text-gray-600">Phone:</span><span class="text-gray-900">' + escapeHtml(job.client_phone) + '</span></div>' +
                '<div class="py-2 border-b"><span class="font-semibold text-gray-600 block mb-1">Description:</span><span class="text-gray-900 whitespace-pre-wrap">' + escapeHtml(job.job_description) + '</span></div>' +
                '<div class="flex justify-between items-center py-2 border-b"><span class="font-semibold text-gray-600">Price:</span><span class="text-gray-900 flex items-center gap-2">$' + parseFloat(job.price).toFixed(2) + ' ' + gstBadge + '</span></div>' +
                '<div class="flex justify-between py-2 border-b"><span class="font-semibold text-gray-600">Email:</span><span class="text-gray-900">' + (job.client_email || 'N/A') + '</span></div>' +
                '<div class="flex justify-between py-2 border-b"><span class="font-semibold text-gray-600">Amount Paid:</span><span class="text-gray-900">' + (job.amount_paid ? '$' + parseFloat(job.amount_paid).toFixed(2) : 'N/A') + '</span></div>' +
                '<div class="flex justify-between py-2 border-b"><span class="font-semibold text-gray-600">Payment Method:</span><span class="text-gray-900">' + (job.payment_method || 'N/A') + '</span></div>' +
                '<div class="flex justify-between py-2"><span class="font-semibold text-gray-600">Photos:</span><span class="text-gray-900">' + (job.photo_urls && job.photo_urls.length > 0 ? '<a href="' + job.photo_urls[0] + '" target="_blank" class="text-blue-600">View</a>' : 'None') + '</span></div>' +
                '</div>';
            modal.classList.remove('hidden');
        }

        function closeMobileJobModal() {
            document.getElementById('mobileJobModal').classList.add('hidden');
            selectedMobileJob = null;
        }

        function editJobFromMobile() {
            if (selectedMobileJob) {
                const jobToEdit = selectedMobileJob;
                closeMobileJobModal();
                // Add small delay to ensure modal closes before opening edit modal
                setTimeout(() => {
                    openEditModal(jobToEdit);
                }, 100);
            } else {
                console.error('No job selected for editing');
                alert('No job selected for editing');
            }
        }

        function openEditModal(job) {
            if (!job) {
                console.error('No job provided to openEditModal');
                alert('Error: Could not load job data');
                return;
            }

            if (!staff || staff.length === 0) {
                console.error('Staff array is empty');
                alert('Error: Staff data not loaded. Please refresh the page.');
                return;
            }

            // Show modal first
            document.getElementById('editJobModal').classList.remove('hidden');

            // Set basic fields
            document.getElementById('edit_job_id').value = job.id || '';
            document.getElementById('edit_date').value = job.date || '';

            // Set time dropdowns
            const startTimeSelect = document.getElementById('edit_start_time');
            const endTimeSelect = document.getElementById('edit_end_time');

            if (startTimeSelect && endTimeSelect) {
                startTimeSelect.innerHTML = '<option value="">Select...</option>' + generateTimeOptions(job.start_time);
                endTimeSelect.innerHTML = '<option value="">Select...</option>' + generateTimeOptions(job.end_time);
            }

            // Set other fields
            document.getElementById('edit_status').value = job.status || 'Unassigned';
            document.getElementById('edit_client_name').value = job.client_name || '';
            document.getElementById('edit_client_phone').value = job.client_phone || '';
            document.getElementById('edit_client_email').value = job.client_email || '';
            document.getElementById('edit_address').value = job.address || '';
            document.getElementById('edit_suburb').value = job.suburb || '';
            document.getElementById('edit_job_description').value = job.job_description || '';
            document.getElementById('edit_price').value = job.price || '';

            // Set GST radio buttons
            const gstRadios = document.getElementsByName('edit_price_includes_gst');
            if (gstRadios && gstRadios.length > 0) {
                gstRadios.forEach(radio => {
                    radio.checked = (radio.value === String(job.price_includes_gst));
                });
            }

            document.getElementById('edit_priority').value = job.priority || 'Normal';
            document.getElementById('edit_amount_paid').value = job.amount_paid || '';
            document.getElementById('edit_payment_method').value = job.payment_method || '';
            document.getElementById('edit_photo_urls').value = (job.photo_urls && job.photo_urls.length > 0) ? job.photo_urls[0] : '';

            // Set assigned to dropdown
            const assignedToSelect = document.getElementById('edit_assigned_to');
            if (assignedToSelect) {
                const staffOptions = staff.map(s =>
                    '<option value="' + s.id + '"' + (job.assigned_to === s.id ? ' selected' : '') + '>' +
                    s.full_name + '</option>'
                ).join('');
                assignedToSelect.innerHTML = '<option value="">Unassigned</option>' + staffOptions;
            }
        }

        function closeEditModal() {
            document.getElementById('editJobModal').classList.add('hidden');
        }

        async function handleEditSubmit(e) {
            e.preventDefault();
            const jobId = document.getElementById('edit_job_id').value;
            const photoUrl = document.getElementById('edit_photo_urls').value.trim();
            const jobData = {
                date: document.getElementById('edit_date').value,
                start_time: document.getElementById('edit_start_time').value,
                end_time: document.getElementById('edit_end_time').value,
                status: document.getElementById('edit_status').value,
                client_name: document.getElementById('edit_client_name').value,
                client_phone: document.getElementById('edit_client_phone').value,
                client_email: document.getElementById('edit_client_email').value || null,
                address: document.getElementById('edit_address').value,
                suburb: document.getElementById('edit_suburb').value,
                job_description: document.getElementById('edit_job_description').value,
                price: parseFloat(document.getElementById('edit_price').value),
                price_includes_gst: document.querySelector('input[name="edit_price_includes_gst"]:checked').value === 'true',
                priority: document.getElementById('edit_priority').value,
                assigned_to: document.getElementById('edit_assigned_to').value || null,
                amount_paid: document.getElementById('edit_amount_paid').value ? parseFloat(document.getElementById('edit_amount_paid').value) : null,
                payment_method: document.getElementById('edit_payment_method').value || null,
                photo_urls: photoUrl ? [photoUrl] : null
            };
            if (jobData.end_time <= jobData.start_time) {alert('End time must be after start time.'); return;}

            try {
                const {error} = await supabase.from('jobs').update(jobData).eq('id', jobId);
                if (error) throw error;
                alert('Job updated successfully!');
                closeEditModal();
                await loadJobs();
                renderApp();
            } catch (error) {
                console.error('Error updating job:', error);
                alert('Failed to update job: ' + error.message);
            }
        }

        function generateTimeOptions(selectedTime) {
            const times = [];
            for (let hour = 0; hour < 24; hour++) {
                // 15-minute increments for 7am-10am (hours 7, 8, 9)
                if (hour >= 7 && hour < 10) {
                    for (let min = 0; min < 60; min += 15) {
                        const timeStr = String(hour).padStart(2, '0') + ':' + String(min).padStart(2, '0') + ':00';
                        const displayTime = formatTime12Hour(timeStr);
                        times.push('<option value="' + timeStr + '"' + (selectedTime === timeStr ? ' selected' : '') + '>' + displayTime + '</option>');
                    }
                } else {
                    // 30-minute increments for all other hours
                    for (let min = 0; min < 60; min += 30) {
                        const timeStr = String(hour).padStart(2, '0') + ':' + String(min).padStart(2, '0') + ':00';
                        const displayTime = formatTime12Hour(timeStr);
                        times.push('<option value="' + timeStr + '"' + (selectedTime === timeStr ? ' selected' : '') + '>' + displayTime + '</option>');
                    }
                }
            }
            return times.join('');
        }

        async function createJob(jobData) {
            try {
                const {data, error} = await supabase.from('jobs').insert([jobData]).select();
                if (error) throw error;
                alert('Job created successfully!');
                await loadJobs();
                currentView = 'dashboard';
                renderApp();
                return true;
            } catch (error) {
                console.error('Error creating job:', error);
                alert('Failed to create job: ' + error.message);
                return false;
            }
        }

        async function deleteJob(jobId) {
            if (!confirm('Are you sure you want to delete this job?')) return;
            try {
                const {error} = await supabase.from('jobs').delete().eq('id', jobId);
                if (error) throw error;
                alert('Job deleted successfully!');
                await loadJobs();
                renderApp();
            } catch (error) {
                console.error('Error deleting job:', error);
                alert('Failed to delete job: ' + error.message);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getStatusClass(status) {
            if (status === 'Completed') return 'bg-green-100 text-green-800';
            if (status === 'In Progress') return 'bg-blue-100 text-blue-800';
            if (status === 'Assigned') return 'bg-purple-100 text-purple-800';
            if (status === 'Reschedule') return 'bg-orange-100 text-orange-800';
            return 'bg-gray-100 text-gray-800';
        }

        function renderApp() {
            const app = document.getElementById('app');
            if (!currentUser) {
                app.innerHTML = renderLogin();
                return;
            }
            app.innerHTML = renderHeader() + '<div class="max-w-full mx-auto px-4 py-6">' + renderContent() + '</div>';
        }

        function renderLogin() {
            return '<div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-purple-600"><div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md"><h1 class="text-3xl font-bold text-gray-900 mb-6 text-center">Manager Login</h1><form onsubmit="handleLogin(event)" class="space-y-4"><div><label class="block text-sm font-medium text-gray-700 mb-2">Username</label><input type="text" id="username" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Password</label><input type="password" id="password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></div><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg">Login</button></form></div></div>';
        }

        function renderHeader() {
            const views = [
                {key: 'dashboard', label: 'Dashboard'},
                {key: 'create-job', label: 'Create'},
                {key: 'all-jobs', label: 'Active'},
                {key: 'completed-jobs', label: 'Completed'},
                {key: 'staff-management', label: 'Staff'}
            ];
            const navButtons = views.map(v => '<button onclick="changeView(\'' + v.key + '\')" class="px-4 py-2 rounded-lg text-sm font-medium transition-colors ' + (currentView === v.key ? 'bg-blue-50 text-blue-700' : 'text-gray-600 hover:bg-gray-50') + '">' + v.label + '</button>').join('');
            return '<nav class="bg-white border-b border-gray-200 sticky top-0 z-30"><div class="max-w-full mx-auto px-4"><div class="flex justify-between items-center h-16"><div class="flex items-center space-x-4"><button onclick="toggleMobileMenu()" class="md:hidden text-gray-600 hover:text-gray-900"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button><div class="flex items-center gap-3"><img src="https://scratchvanish.com.au/wp-content/uploads/2021/11/logo.png" alt="Company Logo" class="h-8 w-auto"><h1 class="text-xl font-semibold text-gray-900">Job Management</h1></div><div class="hidden md:flex space-x-1">' + navButtons + '</div></div><div class="flex items-center space-x-4"><span class="text-sm text-gray-600 hidden sm:inline">Hi, ' + escapeHtml(currentUser.full_name) + '</span><button onclick="logout()" class="text-sm text-red-600 hover:text-red-700 font-medium">Logout</button></div></div></div></nav>';
        }

        function renderContent() {
            if (currentView === 'dashboard') return renderDashboard();
            if (currentView === 'create-job') return renderJobForm();
            if (currentView === 'all-jobs') return renderJobsList(false);
            if (currentView === 'completed-jobs') return renderJobsList(true);
            if (currentView === 'staff-management') return renderStaffManagement();
            return renderDashboard();
        }

        function renderDashboard() {
            const activeJobs = jobs.filter(j => j.status !== 'Completed').length;
            const unassigned = jobs.filter(j => j.status === 'Unassigned').length;
            const assigned = jobs.filter(j => j.status === 'Assigned').length;
            const completedToday = jobs.filter(j => {
                if (j.status !== 'Completed') return false;
                const dateToCheck = j.actual_end_time ? new Date(j.actual_end_time) : new Date(j.date);
                return dateToCheck.toDateString() === new Date().toDateString();
            }).length;

            const todayRevenue = jobs.filter(j => {
                if (j.status !== 'Completed' || !j.amount_paid) return false;
                // Use job date OR actual_end_time (whichever exists)
                const dateToCheck = j.actual_end_time ? new Date(j.actual_end_time) : new Date(j.date);
                return dateToCheck.toDateString() === new Date().toDateString();
            }).reduce((sum, j) => sum + Number(j.amount_paid), 0);

            const cashTotal = jobs.filter(j => {
                if (j.status !== 'Completed' || j.payment_method !== 'Cash' || !j.amount_paid) return false;
                // Use job date OR actual_end_time (whichever exists)
                const dateToCheck = j.actual_end_time ? new Date(j.actual_end_time) : new Date(j.date);
                return dateToCheck.toDateString() === new Date().toDateString();
            }).reduce((sum, j) => sum + Number(j.amount_paid), 0);
            const bankTotal = todayRevenue - cashTotal;
            const workload = staff.map(s => ({
                name: s.full_name,
                color: s.color_code,
                count: jobs.filter(j => j.assigned_to === s.id && j.status !== 'Completed').length
            }));
            const workloadCards = workload.map(w => '<div class="bg-white border border-gray-200 rounded-xl p-4 hover:shadow-sm transition-shadow" style="border-left: 3px solid ' + w.color + '"><div class="text-sm font-medium text-gray-600 mb-1">' + w.name + '</div><div class="text-2xl font-semibold mt-2" style="color: ' + w.color + '">' + w.count + '</div></div>').join('');

            let html = '<div class="space-y-6">';
            html += '<h2 class="text-2xl font-semibold text-gray-900">Dashboard</h2>';
            html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-4">';
            html += '<div onclick="changeView(\'all-jobs\')" class="bg-white rounded-xl border border-gray-200 p-5 hover:shadow-md transition-all cursor-pointer transform hover:scale-105"><div class="text-xs font-medium text-gray-500 uppercase tracking-wide">Active Jobs</div><div class="text-3xl font-semibold text-blue-600 mt-2">' + activeJobs + '</div></div>';
            html += '<div class="bg-white rounded-xl border border-gray-200 p-5 hover:shadow-sm transition-shadow"><div class="text-xs font-medium text-gray-500 uppercase tracking-wide">Unassigned</div><div class="text-3xl font-semibold text-yellow-600 mt-2">' + unassigned + '</div></div>';
            html += '<div class="bg-white rounded-xl border border-gray-200 p-5 hover:shadow-sm transition-shadow"><div class="text-xs font-medium text-gray-500 uppercase tracking-wide">Assigned</div><div class="text-3xl font-semibold text-purple-600 mt-2">' + assigned + '</div></div>';
            html += '<div class="bg-white rounded-xl border border-gray-200 p-5 hover:shadow-sm transition-shadow"><div class="text-xs font-medium text-gray-500 uppercase tracking-wide">Done Today</div><div class="text-3xl font-semibold text-green-600 mt-2">' + completedToday + '</div></div>';
            html += '</div>';
            html += '<div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl p-6 text-white">';
            html += '<h3 class="text-sm font-medium mb-3 opacity-90">Today\'s Revenue</h3>';
            html += '<div class="text-4xl font-semibold mb-4">$' + todayRevenue.toFixed(2) + '</div>';
            html += '<div class="flex space-x-6 text-sm">';
            html += '<div><div class="opacity-80 mb-1">Cash</div><div class="text-xl font-medium">$' + cashTotal.toFixed(2) + '</div></div>';
            html += '<div><div class="opacity-80 mb-1">Bank</div><div class="text-xl font-medium">$' + bankTotal.toFixed(2) + '</div></div>';
            html += '</div></div>';
            html += '<div class="bg-white rounded-xl border border-gray-200 p-6">';
            html += '<h3 class="text-lg font-semibold text-gray-900 mb-4">Staff Workload</h3>';
            html += '<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">' + workloadCards + '</div>';
            html += '</div></div>';
            return html;
        }

        function renderJobForm() {
            const staffOptions = staff.map(s => '<option value="' + s.id + '">' + s.full_name + '</option>').join('');

            let html = '<div class="max-w-3xl mx-auto"><div class="bg-white rounded-lg shadow p-4 md:p-6">';
            html += '<h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-4 md:mb-6">Create New Job</h2>';
            html += '<form onsubmit="handleJobSubmit(event)" class="space-y-4 md:space-y-6">';
            html += '<div class="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4">';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Date *</label><input type="date" name="date" required class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"></div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Start Time *</label><select name="start_time" required class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"><option value="">Select...</option>' + generateTimeOptions() + '</select></div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">End Time *</label><select name="end_time" required class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"><option value="">Select...</option>' + generateTimeOptions() + '</select></div>';
            html += '</div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Assign To</label><select name="assigned_to" class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"><option value="">-- Leave Unassigned --</option>' + staffOptions + '</select></div>';
            html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Client Name *</label><input type="text" name="client_name" required class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"></div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Phone *</label><input type="tel" name="client_phone" required class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"></div>';
            html += '</div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Address *</label><textarea name="address" required rows="2" class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"></textarea></div>' +
                '<div><label class="block text-sm font-medium text-gray-700 mb-2">Suburb *</label><input type="text" name="suburb" list="suburbList" required class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"><datalist id="suburbList"></datalist></div>'
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Job Description *</label><textarea name="job_description" required rows="3" class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"></textarea></div>';
            html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Price ($) *</label><input type="number" step="0.01" name="price" required class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"></div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">GST *</label><div class="space-y-2"><label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50"><input type="radio" name="price_includes_gst" value="false" checked class="w-4 h-4 text-green-600"><span class="ml-3 text-sm md:text-base">Price +GST</span></label><label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50"><input type="radio" name="price_includes_gst" value="true" class="w-4 h-4 text-gray-600"><span class="ml-3 text-sm md:text-base">Price excl GST</span></label></div></div>';
            html += '</div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Email</label><input type="email" name="client_email" class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"></div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Photo URL (Google Photos)</label><input type="url" name="photo_urls" placeholder="https://photos.google.com/share/..." class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"><p class="text-xs text-gray-500 mt-1">Paste one Google Photos album link</p></div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Priority</label><select name="priority" class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"><option value="Normal">Normal</option><option value="High">High</option><option value="Urgent">Urgent</option></select></div>';
            html += '<div class="flex flex-col md:flex-row gap-3 md:gap-4">';
            html += '<button type="submit" class="w-full md:flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg text-sm md:text-base">Create Job</button>';
            html += '<button type="button" onclick="changeView(&#39;dashboard&#39;)" class="w-full md:flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-3 px-6 rounded-lg text-sm md:text-base">Cancel</button>';
            html += '</div></form></div></div>';
            return html;
        }

        function renderJobsList(showCompleted) {
            let filteredJobs = showCompleted ? jobs.filter(j => j.status === 'Completed') : jobs.filter(j => j.status !== 'Completed');
            if (currentStaffFilter) {
                filteredJobs = filteredJobs.filter(j => j.assigned_to === currentStaffFilter);
            }
            const title = showCompleted ? 'Completed Jobs' : 'Active Jobs';
            const emptyMsg = showCompleted ? 'No completed jobs yet.' : 'No active jobs.';
            const staffOptions = staff.map(s => '<option value="' + s.id + '"' + (currentStaffFilter === s.id ? ' selected' : '') + '>' + s.full_name + '</option>').join('');
            const staffFilterDropdown = '<select onchange="currentStaffFilter = this.value; renderApp();" class="px-4 py-2 border rounded-lg text-sm md:text-base"><option value="">All Staff</option>' + staffOptions + '</select>';
            const columnSelector = `
                <div class="relative">
                    <button onclick="toggleColumnSelector()" class="px-4 py-2 border rounded-lg text-sm md:text-base bg-white hover:bg-gray-50 flex items-center gap-2">
                        <span class="material-icons md-18">view_column</span>
                        Columns
                        <span class="material-icons md-18">${columnSelectorOpen ? 'expand_less' : 'expand_more'}</span>
                    </button>
                    ${columnSelectorOpen ? `
                        <div class="absolute right-0 mt-2 w-64 bg-white border border-gray-200 rounded-lg shadow-lg z-50 p-3">
                            <div class="flex justify-between items-center mb-3 pb-2 border-b">
                                <span class="text-sm font-semibold text-gray-700">Select Columns</span>
                                <div class="flex gap-2">
                                    <button onclick="event.stopPropagation(); selectAllColumns();" class="text-xs text-blue-600 hover:text-blue-800">All</button>
                                    <button onclick="event.stopPropagation(); deselectAllColumns();" class="text-xs text-gray-600 hover:text-gray-800">Reset</button>
                                </div>
                            </div>
                            <div class="space-y-2 max-h-80 overflow-y-auto">
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.date ? 'checked' : ''} onchange="toggleColumn('date')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Date</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.start_time ? 'checked' : ''} onchange="toggleColumn('start_time')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Start Time</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.end_time ? 'checked' : ''} onchange="toggleColumn('end_time')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">End Time</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.assigned_to ? 'checked' : ''} onchange="toggleColumn('assigned_to')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Assigned To</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.status ? 'checked' : ''} onchange="toggleColumn('status')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Status</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.client_name ? 'checked' : ''} onchange="toggleColumn('client_name')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Client Name</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.address ? 'checked' : ''} onchange="toggleColumn('address')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Address</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.suburb ? 'checked' : ''} onchange="toggleColumn('suburb')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Suburb</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.phone ? 'checked' : ''} onchange="toggleColumn('phone')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Phone</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.description ? 'checked' : ''} onchange="toggleColumn('description')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Description</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.price ? 'checked' : ''} onchange="toggleColumn('price')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Price</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.email ? 'checked' : ''} onchange="toggleColumn('email')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Email</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.amount_paid ? 'checked' : ''} onchange="toggleColumn('amount_paid')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Amount Paid</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.payment_method ? 'checked' : ''} onchange="toggleColumn('payment_method')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Payment Method</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.photos ? 'checked' : ''} onchange="toggleColumn('photos')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Photos</span>
                                </label>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            const exportButton = `
                <button onclick="openAdvancedExportModal()" class="px-4 py-2 border border-green-600 text-green-600 hover:bg-green-50 rounded-lg text-sm md:text-base font-medium flex items-center gap-2">
                    <span class="material-icons md-18">download</span>
                    Export
                </button>
            `;
            if (filteredJobs.length === 0) {
                return '<div class="space-y-4"><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3"><h2 class="text-xl md:text-2xl font-bold text-gray-900">' + title + '</h2><div class="flex gap-3 flex-wrap">' + staffFilterDropdown + columnSelector + exportButton + '<button onclick="changeView(\'create-job\')" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg text-sm md:text-base">+ Create Job</button></div></div><div class="bg-white rounded-lg shadow p-8 md:p-12 text-center"><p class="text-gray-500">' + emptyMsg + '</p></div></div>';
            }
            const jobsByDate = {};
            filteredJobs.forEach(job => {
                if (!jobsByDate[job.date]) jobsByDate[job.date] = [];
                jobsByDate[job.date].push(job);
            });
            const mobileCards = Object.keys(jobsByDate).sort().map(date => {
                const dateJobs = jobsByDate[date];
                const dateHeader = '<div class="date-header px-4 py-2 border-b border-gray-300"><h3 class="text-sm font-bold text-gray-700">' + new Date(date).toLocaleDateString('en-US', {weekday: 'short', month: 'short', day: 'numeric', year: 'numeric'}) + '</h3></div>';
                const cards = dateJobs.map(job => renderMobileJobCard(job)).join('');
                return dateHeader + cards;
            }).join('');
            return '<div class="space-y-4"><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3"><h2 class="text-xl md:text-2xl font-bold text-gray-900">' + title + '</h2><div class="flex gap-3 w-full sm:w-auto flex-wrap">' + staffFilterDropdown + columnSelector + exportButton + '<button onclick="changeView(\'create-job\')" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg text-sm md:text-base whitespace-nowrap">+ Create Job</button></div></div><div class="bg-white rounded-lg shadow overflow-x-auto">' + renderDesktopTable(filteredJobs) + '</div></div>';
        }

        function renderMobileJobCard(job) {
            const gstBadge = job.price_includes_gst ? '<span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded ml-1">incl. GST</span>' : '<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded font-medium ml-1">+GST</span>';
            const borderColor = job.priority === 'Urgent' ? 'border-red-500' : job.priority === 'High' ? 'border-yellow-500' : 'border-gray-300';
            const statusBg = getStatusClass(job.status);
            const staffDisplay = job.staff ? '<span style="color: ' + job.staff.color_code + '">' + job.staff.full_name + '</span>' : 'Unassigned';
            return '<div class="job-card bg-white border-l-4 ' + borderColor + ' p-4 border-b hover:bg-gray-50" onclick="openMobileJobModal(\'' + job.id + '\')"><div class="flex justify-between items-start mb-2"><div class="flex-1"><div class="font-semibold text-gray-900">' + escapeHtml(job.client_name) + '</div><div class="text-xs text-gray-500 mt-1 flex items-center gap-1"><span class="material-icons md-18">schedule</span>' + formatTime12Hour(job.start_time) + ' - ' + formatTime12Hour(job.end_time) + '</div></div><span class="px-2 py-1 rounded-full text-xs font-medium ' + statusBg + '">' + job.status + '</span></div><div class="space-y-1 text-sm text-gray-600"><div class="flex items-center gap-1"><span class="material-icons md-18">person</span>' + staffDisplay + '</div><div class="flex items-center gap-1"><span class="material-icons md-18">attach_money</span>$' + parseFloat(job.price).toFixed(2) + gstBadge + '</div></div></div>';
        }

        function renderDesktopTable(filteredJobs) {
            const tableRows = filteredJobs.map(job => {
                const gstBadge = job.price_includes_gst
                    ? '<span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded ml-1">excl</span>'
                    : '<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded font-medium ml-1">+GST</span>';
                const photoUrl = (job.photo_urls && job.photo_urls.length > 0) ? job.photo_urls[0] : '';
                const statusBg = getStatusClass(job.status);
                const staffDisplay = job.staff
                    ? '<span style="color: ' + job.staff.color_code + '">' + job.staff.full_name + '</span>'
                    : '<span class="text-gray-400">Unassigned</span>';

                let row = '<tr class="' + (job.status === 'In Progress' ? 'in-progress-row' : 'hover:bg-gray-50') + '">';


                if (visibleColumns.date) {
                    row += '<td id="cell-' + job.id + '-date" class="editable-cell text-sm whitespace-nowrap" onclick="makeEditable(\'' + job.id + '\', \'date\', \'' + job.date + '\', \'date\')"><span class="px-2 py-1 rounded font-medium" style="background-color: ' + getDateColor(job.date) + '; color: ' + getDateTextColor(job.date) + '">' + formatDateWithDay(job.date) + '</span></td>';
                }
                if (visibleColumns.start_time) {
                    row += '<td id="cell-' + job.id + '-start_time" class="editable-cell text-sm whitespace-nowrap" onclick="makeEditable(\'' + job.id + '\', \'start_time\', \'' + job.start_time + '\', \'time\')">' + formatTime12Hour(job.start_time) + '</td>';
                }
                if (visibleColumns.end_time) {
                    row += '<td id="cell-' + job.id + '-end_time" class="editable-cell text-sm whitespace-nowrap" onclick="makeEditable(\'' + job.id + '\', \'end_time\', \'' + job.end_time + '\', \'time\')">' + formatTime12Hour(job.end_time) + '</td>';
                }
                if (visibleColumns.assigned_to) {
                    row += '<td id="cell-' + job.id + '-assigned_to" class="editable-cell text-sm whitespace-nowrap" onclick="makeEditable(\'' + job.id + '\', \'assigned_to\', \'' + (job.assigned_to || '') + '\', \'select-staff\')">' + staffDisplay + '</td>';
                }
                if (visibleColumns.status) {
                    row += '<td id="cell-' + job.id + '-status" class="editable-cell text-sm whitespace-nowrap" onclick="makeEditable(\'' + job.id + '\', \'status\', \'' + job.status + '\', \'select-status\')"><span class="px-2 py-1 rounded-full text-xs font-medium ' + statusBg + '">' + job.status + '</span></td>';
                }
                if (visibleColumns.client_name) {
                    row += '<td id="cell-' + job.id + '-client_name" class="editable-cell text-sm min-w-[120px]" onclick="makeEditable(\'' + job.id + '\', \'client_name\', \'' + escapeHtml(job.client_name).replace(/'/g, "\\'") + '\', \'text\')">' + escapeHtml(job.client_name) + '</td>';
                }
                if (visibleColumns.address) {
                    row += '<td id="cell-' + job.id + '-address" class="editable-cell text-sm min-w-[150px] max-w-[200px] truncate" title="' + escapeHtml(job.address) + '" onclick="makeEditable(\'' + job.id + '\', \'address\', \'' + escapeHtml(job.address).replace(/'/g, "\\'").replace(/\n/g, ' ') + '\', \'textarea\')">' + escapeHtml(job.address) + '</td>';
                }
                if (visibleColumns.suburb) {
                    row += '<td id="cell-' + job.id + '-suburb" class="editable-cell text-sm min-w-[120px]" onclick="makeEditable(\'' + job.id + '\', \'suburb\', \'' + escapeHtml(job.suburb || '').replace(/'/g, "\\'") + '\', \'text\')">' + escapeHtml(job.suburb || 'N/A') + '</td>';
                }
                if (visibleColumns.phone) {
                    row += '<td id="cell-' + job.id + '-client_phone" class="editable-cell text-sm whitespace-nowrap" onclick="makeEditable(\'' + job.id + '\', \'client_phone\', \'' + escapeHtml(job.client_phone).replace(/'/g, "\\'") + '\', \'text\')">' + escapeHtml(job.client_phone) + '</td>';
                }
                if (visibleColumns.description) {
                    row += '<td id="cell-' + job.id + '-job_description" class="editable-cell text-sm min-w-[150px] max-w-[250px] truncate" title="' + escapeHtml(job.job_description) + '" onclick="makeEditable(\'' + job.id + '\', \'job_description\', \'' + escapeHtml(job.job_description).replace(/'/g, "\\'").replace(/\n/g, ' ') + '\', \'textarea\')">' + escapeHtml(job.job_description) + '</td>';
                }
                if (visibleColumns.price) {
                    row += '<td id="cell-' + job.id + '-price" class="editable-cell text-sm whitespace-nowrap" onclick="makeEditable(\'' + job.id + '\', \'price\', \'' + job.price + '\', \'number\')">$' + parseFloat(job.price).toFixed(2) + gstBadge + '</td>';
                }
                if (visibleColumns.email) {
                    row += '<td id="cell-' + job.id + '-client_email" class="editable-cell text-sm min-w-[150px]">' + (job.client_email || '<span class="text-gray-400">N/A</span>') + '</td>';
                }
                if (visibleColumns.amount_paid) {
                    row += '<td id="cell-' + job.id + '-amount_paid" class="editable-cell text-sm whitespace-nowrap" onclick="makeEditable(\'' + job.id + '\', \'amount_paid\', \'' + (job.amount_paid || '') + '\', \'number\')">' + (job.amount_paid ? '$' + parseFloat(job.amount_paid).toFixed(2) : '<span class="text-gray-400">N/A</span>') + '</td>';
                }
                if (visibleColumns.payment_method) {
                    row += '<td id="cell-' + job.id + '-payment_method" class="editable-cell text-sm whitespace-nowrap" onclick="makeEditable(\'' + job.id + '\', \'payment_method\', \'' + (job.payment_method || '') + '\', \'select-payment\')">' + (job.payment_method || '<span class="text-gray-400">N/A</span>') + '</td>';
                }
                if (visibleColumns.photos) {
                    row += '<td id="cell-' + job.id + '-photo_urls" class="editable-cell text-sm whitespace-nowrap">' + (photoUrl ? '<a href="' + photoUrl + '" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800" onclick="event.stopPropagation()">View</a>' : '<span class="text-gray-400">None</span>') + '</td>';
                }

                row += '<td class="px-4 py-2 text-sm whitespace-nowrap"><button onclick="openEditModalById(\'' + job.id + '\')" class="text-blue-600 hover:text-blue-800 mr-2">Edit</button><button onclick="deleteJob(\'' + job.id + '\')" class="text-red-600 hover:text-red-800">Delete</button></td></tr>';

                return row;
            }).join('');

            let headers = '<thead class="bg-gray-50"><tr>';
            if (visibleColumns.date) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="min-width: 140px;">Date</th>';
            if (visibleColumns.start_time) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start</th>';
            if (visibleColumns.end_time) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">End</th>';
            if (visibleColumns.assigned_to) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assigned To</th>';
            if (visibleColumns.status) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>';
            if (visibleColumns.client_name) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client</th>';
            if (visibleColumns.address) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>';
            if (visibleColumns.suburb) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Suburb</th>';
            if (visibleColumns.phone) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>';
            if (visibleColumns.description) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>';
            if (visibleColumns.price) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>';
            if (visibleColumns.email) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>';
            if (visibleColumns.amount_paid) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Paid</th>';
            if (visibleColumns.payment_method) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment</th>';
            if (visibleColumns.photos) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Photos</th>';
            headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th></tr></thead>';

            return '<div class="overflow-x-auto -mx-4 md:mx-0" style="max-height: calc(100vh - 180px); overflow-y: auto;"><table class="min-w-full border-collapse">' +
                headers +
                '<tbody class="bg-white">' + tableRows + '</tbody></table></div>';
        }

        function openEditModalById(jobId) {
            const job = jobs.find(j => j.id === jobId);
            if (job) openEditModal(job);
        }

        function renderStaffManagement() {
            const staffCards = staff.map(s => '<div class="bg-white rounded-lg shadow p-4 md:p-6 border-l-4" style="border-color: ' + s.color_code + '"><div class="flex items-start justify-between mb-3 md:mb-4"><div><h3 class="text-base md:text-lg font-bold text-gray-900">' + s.full_name + '</h3><p class="text-xs md:text-sm text-gray-500">@' + s.username + '</p></div><div class="w-8 h-8 md:w-10 md:h-10 rounded-full" style="background-color: ' + s.color_code + '"></div></div><div class="space-y-2 text-xs md:text-sm"><div><span class="font-medium">Phone:</span> ' + (s.phone || 'Not set') + '</div><div><span class="font-medium">Status:</span> <span class="px-2 py-1 rounded-full text-xs ' + (s.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800') + '">' + (s.active ? 'Active' : 'Inactive') + '</span></div></div></div>').join('');
            return '<div class="space-y-4 md:space-y-6"><h2 class="text-xl md:text-2xl font-bold text-gray-900">Staff Management</h2><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">' + staffCards + '</div><div class="bg-blue-50 border border-blue-200 rounded-lg p-3 md:p-4"><p class="text-xs md:text-sm text-blue-800"><strong>Note:</strong> To add or edit staff, access Supabase Table Editor.</p></div></div>';
        }

        async function handleLogin(e) {
            e.preventDefault();
            await login(document.getElementById('username').value, document.getElementById('password').value);
        }

        async function handleJobSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const photoUrl = formData.get('photo_urls').trim();
            const assignedTo = formData.get('assigned_to') || null;
            const date = formData.get('date');
            const startTime = formData.get('start_time');
            const endTime = formData.get('end_time');
            if (endTime <= startTime) {
                alert('End time must be after start time.');
                return;
            }

            const jobData = {
                date: date,
                start_time: startTime,
                end_time: endTime,
                client_name: formData.get('client_name'),
                client_phone: formData.get('client_phone'),
                client_email: formData.get('client_email') || null,
                address: formData.get('address'),
                suburb: formData.get('suburb'),
                job_description: formData.get('job_description'),
                price: parseFloat(formData.get('price')),
                price_includes_gst: formData.get('price_includes_gst') === 'true',
                priority: formData.get('priority'),
                assigned_to: assignedTo,
                photo_urls: photoUrl ? [photoUrl] : null
            };
            await createJob(jobData);
        }

        function changeView(view) {
            currentView = view;
            currentStaffFilter = '';
            renderApp();
        }

        async function initialize() {
            checkAuth();
            if (currentUser) {
                await loadStaff();
                await loadJobs();
            }
            renderApp();
            if (currentUser) {
                setInterval(async () => {
                    await loadJobs();
                    if (currentView === 'dashboard' || currentView === 'all-jobs' || currentView === 'completed-jobs') renderApp();
                }, 120000);
            }
        }

        initialize();

        // Close dropdowns when clicking outside
        document.addEventListener('click', function (event) {
            const clickedElement = event.target;
            const isColumnSelector = clickedElement.closest('.relative');

            if (columnSelectorOpen && !isColumnSelector) {
                columnSelectorOpen = false;
                renderApp();
            }

            if (exportMenuOpen && !isColumnSelector) {
                exportMenuOpen = false;
                renderApp();
            }
        })
    </script>
</body>

</html>
