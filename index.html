<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Dashboard - Job Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .editable-cell {
            cursor: pointer;
            padding: 8px;
            min-height: 40px;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .editable-cell:hover {
            background-color: #f3f4f6;
            border-color: #3b82f6;
        }

        .editing {
            background-color: #fff;
            border-color: #3b82f6;
        }

        @media (max-width: 768px) {
            .editable-cell {
                cursor: default;
                pointer-events: none;
            }

            .editable-cell:hover {
                background-color: transparent;
                border-color: transparent;
            }
        }

        #mobileMenu {
            transition: transform 0.3s ease-in-out;
        }

        .job-card {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .job-card:active {
            transform: scale(0.98);
        }

        .date-header {
            position: sticky;
            top: 64px;
            z-index: 20;
            background: linear-gradient(to bottom, #f9fafb 0%, #f3f4f6 100%);
        }
    </style>
</head>

<body class="bg-gray-50">
    <div id="app"></div>

    <!-- Mobile Menu Overlay -->
    <div id="mobileMenuOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40" onclick="toggleMobileMenu()">
    </div>

    <!-- Mobile Menu Sidebar -->
    <div id="mobileMenu" class="fixed top-0 left-0 h-full w-64 bg-white shadow-xl z-50 transform -translate-x-full">
        <div class="p-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold text-gray-900">Menu</h2>
                <button onclick="toggleMobileMenu()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <nav class="space-y-2">
                <button onclick="changeView('dashboard'); toggleMobileMenu();"
                    class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 text-gray-700 font-medium">ðŸ“Š
                    Dashboard</button>
                <button onclick="changeView('create-job'); toggleMobileMenu();"
                    class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 text-gray-700 font-medium">âž• Create
                    Job</button>
                <button onclick="changeView('all-jobs'); toggleMobileMenu();"
                    class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 text-gray-700 font-medium">ðŸ“‹ Active
                    Jobs</button>
                <button onclick="changeView('completed-jobs'); toggleMobileMenu();"
                    class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 text-gray-700 font-medium">âœ…
                    Completed Jobs</button>
                <button onclick="changeView('staff-management'); toggleMobileMenu();"
                    class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 text-gray-700 font-medium">ðŸ‘¥
                    Staff</button>
                <hr class="my-4">
                <button onclick="logout(); toggleMobileMenu();"
                    class="w-full text-left px-4 py-3 rounded-lg hover:bg-red-50 text-red-600 font-medium">ðŸšª
                    Logout</button>
            </nav>
        </div>
    </div>

    <!-- Mobile Job Detail Modal -->
    <div id="mobileJobModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg my-8">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-900">Job Details</h2>
                    <button onclick="closeMobileJobModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="mobileJobContent" class="space-y-4"></div>
                <div class="flex gap-3 mt-6">
                    <button onclick="editJobFromMobile()"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg">Edit</button>
                    <button onclick="deleteJobFromMobile()"
                        class="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-6 rounded-lg">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Job Modal -->
    <div id="editJobModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl my-8">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Edit Job</h2>
                    <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <form id="editJobForm" onsubmit="handleEditSubmit(event)" class="space-y-4">
                    <input type="hidden" id="edit_job_id">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date *</label>
                            <input type="date" id="edit_date" required class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Start Time *</label>
                            <select id="edit_start_time" required class="w-full px-4 py-2 border rounded-lg"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">End Time *</label>
                            <select id="edit_end_time" required class="w-full px-4 py-2 border rounded-lg"></select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Assign To</label>
                        <select id="edit_assigned_to" class="w-full px-4 py-2 border rounded-lg"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="edit_status" class="w-full px-4 py-2 border rounded-lg">
                            <option value="Unassigned">Unassigned</option>
                            <option value="Assigned">Assigned</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Client Name *</label>
                        <input type="text" id="edit_client_name" required class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Address *</label>
                        <textarea id="edit_address" required rows="2"
                            class="w-full px-4 py-2 border rounded-lg"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Phone *</label>
                        <input type="tel" id="edit_client_phone" required class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Job Description *</label>
                        <textarea id="edit_job_description" required rows="4"
                            class="w-full px-4 py-2 border rounded-lg"></textarea>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Price ($) *</label>
                            <input type="number" step="0.01" id="edit_price" required
                                class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">GST</label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer">
                                <input type="checkbox" id="edit_price_includes_gst" class="w-4 h-4 text-blue-600">
                                <span class="ml-3">Price includes GST</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="edit_client_email" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Amount Paid ($)</label>
                            <input type="number" step="0.01" id="edit_amount_paid"
                                class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Payment Method</label>
                            <select id="edit_payment_method" class="w-full px-4 py-2 border rounded-lg">
                                <option value="">Not specified</option>
                                <option value="Cash">Cash</option>
                                <option value="Bank Transfer/Check">Bank Transfer/Check</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Photo URL (Google Photos
                            Album)</label>
                        <input type="url" id="edit_photo_urls" placeholder="https://photos.google.com/share/..."
                            class="w-full px-4 py-2 border rounded-lg">
                        <p class="text-xs text-gray-500 mt-1">Paste one Google Photos album link</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                        <select id="edit_priority" class="w-full px-4 py-2 border rounded-lg">
                            <option value="Normal">Normal</option>
                            <option value="High">High</option>
                            <option value="Urgent">Urgent</option>
                        </select>
                    </div>
                    <div class="flex gap-4 pt-4">
                        <button type="submit"
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg">Save
                            Changes</button>
                        <button type="button" onclick="closeEditModal()"
                            class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-3 px-6 rounded-lg">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ssxcjsdoxtgddnkugntl.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzeGNqc2RveHRnZGRua3VnbnRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NDEwODgsImV4cCI6MjA3NzMxNzA4OH0.C-lkPRJtFYa7YAgPavXRIGvV1LPkCXOJQYoVrZ4nCMw';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let currentView = 'dashboard';
        let jobs = [];
        let staff = [];
        let editingJob = null;
        let selectedMobileJob = null;
        let currentStaffFilter = '';

        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const overlay = document.getElementById('mobileMenuOverlay');
            if (menu.classList.contains('-translate-x-full')) {
                menu.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                menu.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        async function login(username, password) {
            try {
                const {data, error} = await supabase.from('manager_users').select('*').eq('username', username).eq('password', password).single();
                if (error || !data) {alert('Invalid username or password'); return false;}
                currentUser = data;
                localStorage.setItem('manager_user', JSON.stringify(data));
                await loadStaff();
                await loadJobs();
                renderApp();
                return true;
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed');
                return false;
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('manager_user');
            renderApp();
        }

        function checkAuth() {
            const stored = localStorage.getItem('manager_user');
            if (stored) currentUser = JSON.parse(stored);
        }

        async function loadJobs() {
            try {
                const {data, error} = await supabase.from('jobs').select('*, staff:assigned_to (full_name, color_code)').order('date', {ascending: true}).order('start_time', {ascending: true});
                if (error) throw error;
                jobs = data || [];
                return jobs;
            } catch (error) {
                console.error('Error loading jobs:', error);
                return [];
            }
        }

        async function loadStaff() {
            try {
                const {data, error} = await supabase.from('staff').select('*').eq('active', true).order('full_name');
                if (error) throw error;
                staff = data || [];
                return staff;
            } catch (error) {
                console.error('Error loading staff:', error);
                return [];
            }
        }

        function checkSchedulingConflict(date, startTime, endTime, assignedTo, excludeJobId = null) {
            if (!assignedTo || !date || !startTime || !endTime) return null;

            const conflictingJob = jobs.find(job => {
                if (job.id === excludeJobId) return false;
                if (job.assigned_to !== assignedTo) return false;
                if (job.date !== date) return false;
                if (job.status === 'Completed') return false;

                const jobStart = job.start_time;
                const jobEnd = job.end_time;

                const overlap = (startTime < jobEnd && endTime > jobStart);
                return overlap;
            });

            return conflictingJob;
        }

        async function updateJobField(jobId, field, value) {
            if (window.innerWidth <= 768) return;
            try {
                const job = jobs.find(j => j.id === jobId);
                if (!job) throw new Error('Job not found');

                if (field === 'assigned_to' && value) {
                    const conflict = checkSchedulingConflict(job.date, job.start_time, job.end_time, value, jobId);
                    if (conflict) {
                        const staffMember = staff.find(s => s.id === value);
                        alert(`Scheduling Conflict!\n\n${staffMember ? staffMember.full_name : 'This staff member'} is already assigned to:\n\nClient: ${conflict.client_name}\nDate: ${new Date(conflict.date).toLocaleDateString()}\nTime: ${formatTime12Hour(conflict.start_time)} - ${formatTime12Hour(conflict.end_time)}\n\nPlease choose a different staff member or time slot.`);
                        return false;
                    }
                }

                const {error} = await supabase.from('jobs').update({[field]: value}).eq('id', jobId);
                if (error) throw error;
                await loadJobs();
                renderApp();
                return true;
            } catch (error) {
                console.error('Error updating job:', error);
                alert('Failed to update: ' + error.message);
                return false;
            }
        }

        function formatTime12Hour(time24) {
            if (!time24) return '';
            const [hours, minutes] = time24.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const hour12 = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
            return `${hour12}:${minutes} ${ampm}`;
        }

        function makeEditable(jobId, field, currentValue, type = 'text') {
            if (window.innerWidth <= 768) return;
            const cellId = `cell-${jobId}-${field}`;
            const cell = document.getElementById(cellId);
            if (!cell || cell.classList.contains('editing')) return;

            cell.classList.add('editing');
            const originalContent = cell.innerHTML;
            let input;

            if (type === 'date') {
                input = document.createElement('input');
                input.type = 'date';
                input.value = currentValue || '';
                input.className = 'w-full px-2 py-1 border border-blue-500 rounded focus:outline-none';
            } else if (type === 'time') {
                input = document.createElement('select');
                input.className = 'w-full px-2 py-1 border border-blue-500 rounded focus:outline-none';
                input.innerHTML = '<option value="">Select...</option>' + generateTimeOptions(currentValue);
            } else if (type === 'select-status') {
                input = document.createElement('select');
                input.className = 'w-full px-2 py-1 border border-blue-500 rounded focus:outline-none';
                input.innerHTML = `
                    <option value="Unassigned" ${currentValue === 'Unassigned' ? 'selected' : ''}>Unassigned</option>
                    <option value="Assigned" ${currentValue === 'Assigned' ? 'selected' : ''}>Assigned</option>
                    <option value="In Progress" ${currentValue === 'In Progress' ? 'selected' : ''}>In Progress</option>
                    <option value="Completed" ${currentValue === 'Completed' ? 'selected' : ''}>Completed</option>
                `;
            } else if (type === 'select-staff') {
                input = document.createElement('select');
                input.className = 'w-full px-2 py-1 border border-blue-500 rounded focus:outline-none';
                input.innerHTML = '<option value="">Unassigned</option>' + staff.map(s => `<option value="${s.id}" ${currentValue === s.id ? 'selected' : ''}>${s.full_name}</option>`).join('');
            } else if (type === 'select-payment') {
                input = document.createElement('select');
                input.className = 'w-full px-2 py-1 border border-blue-500 rounded focus:outline-none';
                input.innerHTML = `
                    <option value="">Not specified</option>
                    <option value="Cash" ${currentValue === 'Cash' ? 'selected' : ''}>Cash</option>
                    <option value="Bank Transfer/Check" ${currentValue === 'Bank Transfer/Check' ? 'selected' : ''}>Bank Transfer/Check</option>
                `;
            } else if (type === 'number') {
                input = document.createElement('input');
                input.type = 'number';
                input.step = '0.01';
                input.value = currentValue || '';
                input.className = 'w-full px-2 py-1 border border-blue-500 rounded focus:outline-none';
            } else if (type === 'url') {
                input = document.createElement('input');
                input.type = 'url';
                input.value = currentValue || '';
                input.placeholder = 'https://...';
                input.className = 'w-full px-2 py-1 border border-blue-500 rounded focus:outline-none';
            } else {
                input = document.createElement('input');
                input.type = 'text';
                input.value = currentValue || '';
                input.className = 'w-full px-2 py-1 border border-blue-500 rounded focus:outline-none';
            }

            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();

            const save = async () => {
                const newValue = input.value;
                if (newValue !== currentValue) {
                    const success = await updateJobField(jobId, field, newValue || null);
                    if (!success) {
                        cell.innerHTML = originalContent;
                        cell.classList.remove('editing');
                    }
                } else {
                    cell.innerHTML = originalContent;
                    cell.classList.remove('editing');
                }
            };

            const cancel = () => {
                cell.innerHTML = originalContent;
                cell.classList.remove('editing');
            };

            input.addEventListener('blur', save);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {e.preventDefault(); save();}
                else if (e.key === 'Escape') {e.preventDefault(); cancel();}
            });

            if (type === 'select-status' || type === 'select-staff' || type === 'time' || type === 'select-payment') {
                input.addEventListener('change', save);
            }
        }

        function openMobileJobModal(job) {
            selectedMobileJob = job;
            const modal = document.getElementById('mobileJobModal');
            const content = document.getElementById('mobileJobContent');

            const gstBadge = job.price_includes_gst
                ? '<span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded">incl. GST</span>'
                : '<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded font-medium">+GST</span>';

            content.innerHTML = `
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between py-2 border-b">
                        <span class="font-semibold text-gray-600">Date:</span>
                        <span class="text-gray-900">${new Date(job.date).toLocaleDateString()}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b">
                        <span class="font-semibold text-gray-600">Start Time:</span>
                        <span class="text-gray-900">${formatTime12Hour(job.start_time)}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b">
                        <span class="font-semibold text-gray-600">End Time:</span>
                        <span class="text-gray-900">${formatTime12Hour(job.end_time)}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b">
                        <span class="font-semibold text-gray-600">Assigned To:</span>
                        <span class="text-gray-900">${job.staff ? job.staff.full_name : 'Unassigned'}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b">
                        <span class="font-semibold text-gray-600">Status:</span>
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${job.status === 'Completed' ? 'bg-green-100 text-green-800' : job.status === 'In Progress' ? 'bg-blue-100 text-blue-800' : job.status === 'Assigned' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800'}">${job.status}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b">
                        <span class="font-semibold text-gray-600">Client Name:</span>
                        <span class="text-gray-900">${job.client_name}</span>
                    </div>
                    <div class="py-2 border-b">
                        <span class="font-semibold text-gray-600 block mb-1">Address:</span>
                        <span class="text-gray-900">${job.address}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b">
                        <span class="font-semibold text-gray-600">Phone:</span>
                        <span class="text-gray-900">${job.client_phone}</span>
                    </div>
                    <div class="py-2 border-b">
                        <span class="font-semibold text-gray-600 block mb-1">Description:</span>
                        <span class="text-gray-900 whitespace-pre-wrap">${job.job_description}</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b">
                        <span class="font-semibold text-gray-600">Price:</span>
                        <span class="text-gray-900 flex items-center gap-2">$${parseFloat(job.price).toFixed(2)} ${gstBadge}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b">
                        <span class="font-semibold text-gray-600">Email:</span>
                        <span class="text-gray-900">${job.client_email || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b">
                        <span class="font-semibold text-gray-600">Amount Paid:</span>
                        <span class="text-gray-900">${job.amount_paid ? '$' + parseFloat(job.amount_paid).toFixed(2) : 'N/A'}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b">
                        <span class="font-semibold text-gray-600">Payment Method:</span>
                        <span class="text-gray-900">${job.payment_method || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between py-2">
                        <span class="font-semibold text-gray-600">Photos:</span>
                        <span class="text-gray-900">${job.photo_urls && job.photo_urls.length > 0 ? `<a href="${job.photo_urls[0]}" target="_blank" class="text-blue-600">View</a>` : 'None'}</span>
                    </div>
                </div>
            `;

            modal.classList.remove('hidden');
        }

        function closeMobileJobModal() {
            document.getElementById('mobileJobModal').classList.add('hidden');
            selectedMobileJob = null;
        }

        function editJobFromMobile() {
            if (selectedMobileJob) {
                closeMobileJobModal();
                openEditModal(selectedMobileJob);
            }
        }

        function deleteJobFromMobile() {
            if (selectedMobileJob) {
                closeMobileJobModal();
                deleteJob(selectedMobileJob.id);
            }
        }

        function openEditModal(job) {
            document.getElementById('editJobModal').classList.remove('hidden');
            document.getElementById('edit_job_id').value = job.id;
            document.getElementById('edit_date').value = job.date;
            document.getElementById('edit_start_time').innerHTML = '<option value="">Select...</option>' + generateTimeOptions(job.start_time);
            document.getElementById('edit_end_time').innerHTML = '<option value="">Select...</option>' + generateTimeOptions(job.end_time);
            document.getElementById('edit_status').value = job.status;
            document.getElementById('edit_client_name').value = job.client_name;
            document.getElementById('edit_client_phone').value = job.client_phone;
            document.getElementById('edit_client_email').value = job.client_email || '';
            document.getElementById('edit_address').value = job.address;
            document.getElementById('edit_job_description').value = job.job_description;
            document.getElementById('edit_price').value = job.price;
            document.getElementById('edit_price_includes_gst').checked = job.price_includes_gst;
            document.getElementById('edit_priority').value = job.priority;
            document.getElementById('edit_amount_paid').value = job.amount_paid || '';
            document.getElementById('edit_payment_method').value = job.payment_method || '';
            document.getElementById('edit_photo_urls').value = (job.photo_urls && job.photo_urls.length > 0) ? job.photo_urls[0] : '';
            document.getElementById('edit_assigned_to').innerHTML = '<option value="">Unassigned</option>' + staff.map(s => `<option value="${s.id}" ${job.assigned_to === s.id ? 'selected' : ''}>${s.full_name}</option>`).join('');
        }

        function closeEditModal() {
            document.getElementById('editJobModal').classList.add('hidden');
        }

        async function handleEditSubmit(e) {
            e.preventDefault();
            const jobId = document.getElementById('edit_job_id').value;
            const photoUrl = document.getElementById('edit_photo_urls').value.trim();
            const jobData = {
                date: document.getElementById('edit_date').value,
                start_time: document.getElementById('edit_start_time').value,
                end_time: document.getElementById('edit_end_time').value,
                status: document.getElementById('edit_status').value,
                client_name: document.getElementById('edit_client_name').value,
                client_phone: document.getElementById('edit_client_phone').value,
                client_email: document.getElementById('edit_client_email').value || null,
                address: document.getElementById('edit_address').value,
                job_description: document.getElementById('edit_job_description').value,
                price: parseFloat(document.getElementById('edit_price').value),
                price_includes_gst: document.getElementById('edit_price_includes_gst').checked,
                priority: document.getElementById('edit_priority').value,
                assigned_to: document.getElementById('edit_assigned_to').value || null,
                amount_paid: document.getElementById('edit_amount_paid').value ? parseFloat(document.getElementById('edit_amount_paid').value) : null,
                payment_method: document.getElementById('edit_payment_method').value || null,
                photo_urls: photoUrl ? [photoUrl] : null
            };

            if (jobData.end_time <= jobData.start_time) {alert('End time must be after start time.'); return;}

            if (jobData.assigned_to) {
                const conflict = checkSchedulingConflict(jobData.date, jobData.start_time, jobData.end_time, jobData.assigned_to, jobId);
                if (conflict) {
                    const staffMember = staff.find(s => s.id === jobData.assigned_to);
                    alert(`Scheduling Conflict!\n\n${staffMember ? staffMember.full_name : 'This staff member'} is already assigned to:\n\nClient: ${conflict.client_name}\nDate: ${new Date(conflict.date).toLocaleDateString()}\nTime: ${formatTime12Hour(conflict.start_time)} - ${formatTime12Hour(conflict.end_time)}\n\nPlease choose a different staff member or time slot.`);
                    return;
                }
            }

            try {
                const {error} = await supabase.from('jobs').update(jobData).eq('id', jobId);
                if (error) throw error;
                alert('Job updated successfully!');
                closeEditModal();
                await loadJobs();
                renderApp();
            } catch (error) {
                console.error('Error updating job:', error);
                alert('Failed to update job: ' + error.message);
            }
        }

        function generateTimeOptions(selectedTime = '') {
            const times = [];
            for (let hour = 0; hour < 24; hour++) {
                for (let min = 0; min < 60; min += 30) {
                    const timeStr = `${String(hour).padStart(2, '0')}:${String(min).padStart(2, '0')}:00`;
                    const displayTime = formatTime12Hour(timeStr);
                    times.push(`<option value="${timeStr}" ${selectedTime === timeStr ? 'selected' : ''}>${displayTime}</option>`);
                }
            }
            return times.join('');
        }

        async function createJob(jobData) {
            try {
                const {data, error} = await supabase.from('jobs').insert([jobData]).select();
                if (error) throw error;
                alert('Job created successfully!');
                await loadJobs();
                currentView = 'dashboard';
                renderApp();
                return true;
            } catch (error) {
                console.error('Error creating job:', error);
                alert('Failed to create job: ' + error.message);
                return false;
            }
        }

        async function deleteJob(jobId) {
            if (!confirm('Are you sure you want to delete this job?')) return;
            try {
                const {error} = await supabase.from('jobs').delete().eq('id', jobId);
                if (error) throw error;
                alert('Job deleted successfully!');
                await loadJobs();
                renderApp();
            } catch (error) {
                console.error('Error deleting job:', error);
                alert('Failed to delete job: ' + error.message);
            }
        }

        function renderApp() {
            const app = document.getElementById('app');
            if (!currentUser) {app.innerHTML = renderLogin(); return;}
            app.innerHTML = renderHeader() + '<div class="max-w-full mx-auto px-4 py-6">' + renderContent() + '</div>';
        }

        function renderLogin() {
            return `<div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-purple-600"><div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md"><h1 class="text-3xl font-bold text-gray-900 mb-6 text-center">Manager Login</h1><form onsubmit="handleLogin(event)" class="space-y-4"><div><label class="block text-sm font-medium text-gray-700 mb-2">Username</label><input type="text" id="username" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Password</label><input type="password" id="password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></div><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg">Login</button></form></div></div>`;
        }

        function renderHeader() {
            return `<nav class="bg-white shadow-sm sticky top-0 z-30"><div class="max-w-full mx-auto px-4"><div class="flex justify-between items-center h-16"><div class="flex items-center space-x-4"><button onclick="toggleMobileMenu()" class="md:hidden text-gray-600 hover:text-gray-900"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button><h1 class="text-lg md:text-xl font-bold text-gray-900">Job Management</h1><div class="hidden md:flex space-x-2"><button onclick="changeView('dashboard')" class="px-3 py-2 rounded-md text-sm ${currentView === 'dashboard' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100'}">Dashboard</button><button onclick="changeView('create-job')" class="px-3 py-2 rounded-md text-sm ${currentView === 'create-job' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100'}">Create</button><button onclick="changeView('all-jobs')" class="px-3 py-2 rounded-md text-sm ${currentView === 'all-jobs' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100'}">Active</button><button onclick="changeView('completed-jobs')" class="px-3 py-2 rounded-md text-sm ${currentView === 'completed-jobs' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100'}">Completed</button><button onclick="changeView('staff-management')" class="px-3 py-2 rounded-md text-sm ${currentView === 'staff-management' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100'}">Staff</button></div></div><div class="flex items-center space-x-2 md:space-x-4"><span class="text-xs md:text-sm text-gray-600 hidden sm:inline">Hi, ${currentUser.full_name}</span><button onclick="logout()" class="text-xs md:text-sm text-red-600 hover:text-red-700 font-medium">Logout</button></div></div></div></nav>`;
        }

        function renderContent() {
            switch (currentView) {
                case 'dashboard': return renderDashboard();
                case 'create-job': return renderJobForm();
                case 'all-jobs': return renderJobsList(false);
                case 'completed-jobs': return renderJobsList(true);
                case 'staff-management': return renderStaffManagement();
                default: return renderDashboard();
            }
        }

        function renderDashboard() {
            const unassigned = jobs.filter(j => j.status === 'Unassigned').length;
            const assigned = jobs.filter(j => j.status === 'Assigned').length;
            const inProgress = jobs.filter(j => j.status === 'In Progress').length;
            const completedToday = jobs.filter(j => {
                if (j.status !== 'Completed' || !j.actual_end_time) return false;
                return new Date(j.actual_end_time).toDateString() === new Date().toDateString();
            }).length;

            const todayRevenue = jobs.filter(j => {
                if (j.status !== 'Completed' || !j.actual_end_time || !j.amount_paid) return false;
                return new Date(j.actual_end_time).toDateString() === new Date().toDateString();
            }).reduce((sum, j) => sum + parseFloat(j.amount_paid || 0), 0);

            const cashTotal = jobs.filter(j => {
                if (j.status !== 'Completed' || !j.actual_end_time || j.payment_method !== 'Cash') return false;
                return new Date(j.actual_end_time).toDateString() === new Date().toDateString();
            }).reduce((sum, j) => sum + parseFloat(j.amount_paid || 0), 0);

            const bankTotal = todayRevenue - cashTotal;
            const workload = staff.map(s => ({...s, activeJobs: jobs.filter(j => j.assigned_to === s.id && j.status !== 'Completed').length}));

            return `<div class="space-y-4 md:space-y-6"><h2 class="text-xl md:text-2xl font-bold text-gray-900">Dashboard</h2><div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4"><div class="bg-white rounded-lg shadow p-4 md:p-6"><div class="text-xs md:text-sm font-medium text-gray-500">Unassigned</div><div class="text-2xl md:text-3xl font-bold text-yellow-600 mt-2">${unassigned}</div></div><div class="bg-white rounded-lg shadow p-4 md:p-6"><div class="text-xs md:text-sm font-medium text-gray-500">Assigned</div><div class="text-2xl md:text-3xl font-bold text-blue-600 mt-2">${assigned}</div></div><div class="bg-white rounded-lg shadow p-4 md:p-6"><div class="text-xs md:text-sm font-medium text-gray-500">In Progress</div><div class="text-2xl md:text-3xl font-bold text-purple-600 mt-2">${inProgress}</div></div><div class="bg-white rounded-lg shadow p-4 md:p-6"><div class="text-xs md:text-sm font-medium text-gray-500">Done Today</div><div class="text-2xl md:text-3xl font-bold text-green-600 mt-2">${completedToday}</div></div></div><div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-lg p-4 md:p-6 text-white"><h3 class="text-base md:text-lg font-medium mb-3 md:mb-4">Today's Revenue</h3><div class="text-3xl md:text-4xl font-bold mb-3 md:mb-4">${todayRevenue.toFixed(2)}</div><div class="flex space-x-4 md:space-x-6 text-xs md:text-sm"><div><div class="opacity-90">Cash</div><div class="text-lg md:text-xl font-semibold">${cashTotal.toFixed(2)}</div></div><div><div class="opacity-90">Bank</div><div class="text-lg md:text-xl font-semibold">${bankTotal.toFixed(2)}</div></div></div></div><div class="bg-white rounded-lg shadow p-4 md:p-6"><h3 class="text-base md:text-lg font-bold text-gray-900 mb-3 md:mb-4">Staff Workload</h3><div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 md:gap-4">${workload.map(s => `<div class="border rounded-lg p-3 md:p-4" style="border-left: 4px solid ${s.color_code}"><div class="text-sm md:text-base font-medium text-gray-900">${s.full_name}</div><div class="text-xl md:text-2xl font-bold mt-1 md:mt-2" style="color: ${s.color_code}">${s.activeJobs}</div></div>`).join('')}</div></div></div>`;
        }

        function renderJobForm() {
            return `<div class="max-w-3xl mx-auto"><div class="bg-white rounded-lg shadow p-4 md:p-6"><h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-4 md:mb-6">Create New Job</h2><form onsubmit="handleJobSubmit(event)" class="space-y-4 md:space-y-6"><div class="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4"><div><label class="block text-sm font-medium text-gray-700 mb-2">Date *</label><input type="date" name="date" required class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Start Time *</label><select name="start_time" required class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"><option value="">Select...</option>${generateTimeOptions()}</select></div><div><label class="block text-sm font-medium text-gray-700 mb-2">End Time *</label><select name="end_time" required class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"><option value="">Select...</option>${generateTimeOptions()}</select></div></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Assign To</label><select name="assigned_to" class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"><option value="">-- Leave Unassigned --</option>${staff.map(s => `<option value="${s.id}">${s.full_name}</option>`).join('')}</select></div><div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4"><div><label class="block text-sm font-medium text-gray-700 mb-2">Client Name *</label><input type="text" name="client_name" required class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Phone *</label><input type="tel" name="client_phone" required class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"></div></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Address *</label><textarea name="address" required rows="2" class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"></textarea></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Job Description *</label><textarea name="job_description" required rows="3" class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"></textarea></div><div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4"><div><label class="block text-sm font-medium text-gray-700 mb-2">Price ($) *</label><input type="number" step="0.01" name="price" required class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"></div><div><label class="block text-sm font-medium text-gray-700 mb-2">GST</label><label class="flex items-center p-3 border rounded-lg cursor-pointer"><input type="checkbox" name="price_includes_gst" class="w-4 h-4 text-blue-600"><span class="ml-3 text-sm md:text-base">Price includes GST</span></label></div></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Email</label><input type="email" name="client_email" class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Photo URL (Google Photos)</label><input type="url" name="photo_urls" placeholder="https://photos.google.com/share/..." class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"><p class="text-xs text-gray-500 mt-1">Paste one Google Photos album link</p></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Priority</label><select name="priority" class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"><option value="Normal">Normal</option><option value="High">High</option><option value="Urgent">Urgent</option></select></div><div class="flex flex-col md:flex-row gap-3 md:gap-4"><button type="submit" class="w-full md:flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg text-sm md:text-base">Create Job</button><button type="button" onclick="changeView('dashboard')" class="w-full md:flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-3 px-6 rounded-lg text-sm md:text-base">Cancel</button></div></form></div></div>`;
        }

        function renderJobsList(showCompleted) {
            let filteredJobs = showCompleted ? jobs.filter(j => j.status === 'Completed') : jobs.filter(j => j.status !== 'Completed');

            if (currentStaffFilter) {
                filteredJobs = filteredJobs.filter(j => j.assigned_to === currentStaffFilter);
            }

            const title = showCompleted ? 'Completed Jobs' : 'Active Jobs';
            const emptyMsg = showCompleted ? 'No completed jobs yet.' : 'No active jobs.';

            const staffFilterDropdown = `
                <select onchange="currentStaffFilter = this.value; renderApp();" class="px-4 py-2 border rounded-lg text-sm md:text-base">
                    <option value="">All Staff</option>
                    ${staff.map(s => `<option value="${s.id}" ${currentStaffFilter === s.id ? 'selected' : ''}>${s.full_name}</option>`).join('')}
                </select>
            `;

            if (filteredJobs.length === 0) {
                return `<div class="space-y-4"><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3"><h2 class="text-xl md:text-2xl font-bold text-gray-900">${title}</h2><div class="flex gap-3">${staffFilterDropdown}<button onclick="changeView('create-job')" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg text-sm md:text-base">+ Create Job</button></div></div><div class="bg-white rounded-lg shadow p-8 md:p-12 text-center"><p class="text-gray-500">${emptyMsg}</p></div></div>`;
            }

            // Mobile view - group by date
            const jobsByDate = {};
            filteredJobs.forEach(job => {
                const dateKey = job.date;
                if (!jobsByDate[dateKey]) jobsByDate[dateKey] = [];
                jobsByDate[dateKey].push(job);
            });

            const mobileCards = Object.keys(jobsByDate).sort().map(date => {
                const dateJobs = jobsByDate[date];
                return `
                    <div class="date-header px-4 py-2 border-b border-gray-300">
                        <h3 class="text-sm font-bold text-gray-700">${new Date(date).toLocaleDateString('en-US', {weekday: 'short', month: 'short', day: 'numeric', year: 'numeric'})}</h3>
                    </div>
                    ${dateJobs.map(job => renderMobileJobCard(job)).join('')}
                `;
            }).join('');

            return `<div class="space-y-4"><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3"><h2 class="text-xl md:text-2xl font-bold text-gray-900">${title}</h2><div class="flex gap-3 w-full sm:w-auto">${staffFilterDropdown}<button onclick="changeView('create-job')" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg text-sm md:text-base whitespace-nowrap">+ Create Job</button></div></div><div class="md:hidden space-y-0">${mobileCards}</div><div class="hidden md:block bg-white rounded-lg shadow overflow-x-auto">${renderDesktopTable(filteredJobs)}</div></div>`;
        }

        function renderMobileJobCard(job) {
            const gstBadge = job.price_includes_gst
                ? '<span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded ml-1">incl. GST</span>'
                : '<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded font-medium ml-1">+GST</span>';

            return `
                <div class="job-card bg-white border-l-4 ${job.priority === 'Urgent' ? 'border-red-500' : job.priority === 'High' ? 'border-yellow-500' : 'border-gray-300'} p-4 border-b hover:bg-gray-50" onclick='openMobileJobModal(${JSON.stringify(job).replace(/'/g, "&#39;")})'>
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <div class="font-semibold text-gray-900">${job.client_name}</div>
                            <div class="text-xs text-gray-500 mt-1">â° ${formatTime12Hour(job.start_time)} - ${formatTime12Hour(job.end_time)}</div>
                        </div>
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${job.status === 'Completed' ? 'bg-green-100 text-green-800' : job.status === 'In Progress' ? 'bg-blue-100 text-blue-800' : job.status === 'Assigned' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800'}">${job.status}</span>
                    </div>
                    <div class="space-y-1 text-sm text-gray-600">
                        ${job.staff ? `<div>ðŸ‘¤ <span style="color: ${job.staff.color_code}">${job.staff.full_name}</span></div>` : '<div>ðŸ‘¤ Unassigned</div>'}
                        <div class="flex items-center">ðŸ’µ ${parseFloat(job.price).toFixed(2)}${gstBadge}</div>
                        ${job.priority !== 'Normal' ? `<div><span class="px-2 py-1 rounded text-xs font-medium ${job.priority === 'Urgent' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}">${job.priority}</span></div>` : ''}
                    </div>
                </div>
            `;
        }

        function renderDesktopTable(filteredJobs) {
            return `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Start Time</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">End Time</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Assigned To</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Client Name</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Address</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Phone</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Price</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount Paid</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Payment Method</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Photos</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${filteredJobs.map(job => {
                const gstBadge = job.price_includes_gst
                    ? '<span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded ml-1">incl</span>'
                    : '<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded font-medium ml-1">+GST</span>';

                const photoUrl = (job.photo_urls && job.photo_urls.length > 0) ? job.photo_urls[0] : '';

                return `
                                <tr class="hover:bg-gray-50">
                                    <td id="cell-${job.id}-date" class="editable-cell text-sm" onclick="makeEditable('${job.id}', 'date', '${job.date}', 'date')">${new Date(job.date).toLocaleDateString()}</td>
                                    <td id="cell-${job.id}-start_time" class="editable-cell text-sm" onclick="makeEditable('${job.id}', 'start_time', '${job.start_time}', 'time')">${formatTime12Hour(job.start_time)}</td>
                                    <td id="cell-${job.id}-end_time" class="editable-cell text-sm" onclick="makeEditable('${job.id}', 'end_time', '${job.end_time}', 'time')">${formatTime12Hour(job.end_time)}</td>
                                    <td id="cell-${job.id}-assigned_to" class="editable-cell text-sm" onclick="makeEditable('${job.id}', 'assigned_to', '${job.assigned_to || ''}', 'select-staff')">${job.staff ? `<span style="color: ${job.staff.color_code}">${job.staff.full_name}</span>` : '<span class="text-gray-400">Unassigned</span>'}</td>
                                    <td id="cell-${job.id}-status" class="editable-cell text-sm" onclick="makeEditable('${job.id}', 'status', '${job.status}', 'select-status')"><span class="px-2 py-1 rounded-full text-xs font-medium ${job.status === 'Completed' ? 'bg-green-100 text-green-800' : job.status === 'In Progress' ? 'bg-blue-100 text-blue-800' : job.status === 'Assigned' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800'}">${job.status}</span></td>
                                    <td id="cell-${job.id}-client_name" class="editable-cell text-sm" onclick="makeEditable('${job.id}', 'client_name', '${job.client_name.replace(/'/g, "\\'")}', 'text')">${job.client_name}</td>
                                    <td id="cell-${job.id}-address" class="editable-cell text-sm max-w-xs truncate" onclick="makeEditable('${job.id}', 'address', '${job.address.replace(/'/g, "\\'")}', 'text')" title="${job.address}">${job.address}</td>
                                    <td id="cell-${job.id}-client_phone" class="editable-cell text-sm" onclick="makeEditable('${job.id}', 'client_phone', '${job.client_phone}', 'text')">${job.client_phone}</td>
                                    <td id="cell-${job.id}-job_description" class="editable-cell text-sm max-w-xs truncate" onclick="makeEditable('${job.id}', 'job_description', '${job.job_description.replace(/'/g, "\\'")}', 'text')" title="${job.job_description}">${job.job_description}</td>
                                    <td id="cell-${job.id}-price" class="editable-cell text-sm whitespace-nowrap" onclick="makeEditable('${job.id}', 'price', '${job.price}', 'number')">${parseFloat(job.price).toFixed(2)}${gstBadge}</td>
                                    <td id="cell-${job.id}-client_email" class="editable-cell text-sm" onclick="makeEditable('${job.id}', 'client_email', '${job.client_email || ''}', 'text')">${job.client_email || '<span class="text-gray-400">N/A</span>'}</td>
                                    <td id="cell-${job.id}-amount_paid" class="editable-cell text-sm" onclick="makeEditable('${job.id}', 'amount_paid', '${job.amount_paid || ''}', 'number')">${job.amount_paid ? '                 + parseFloat(job.amount_paid).toFixed(2) : ' < span class="text-gray-400" > N / A</span > '}</td>
                    < td id = "cell-${job.id}-payment_method" class="editable-cell text-sm" onclick = "makeEditable('${job.id}', 'payment_method', '${job.payment_method || ''}', 'select-payment')" > ${job.payment_method || '<span class="text-gray-400">N/A</span>'}</td >
                        <td id="cell-${job.id}-photo_urls" class="editable-cell text-sm" onclick="makeEditable('${job.id}', 'photo_urls', '${photoUrl.replace(/'/g, "\\'")}', 'url')">${photoUrl ? `<a href="${photoUrl} " target="_blank" rel="noopener noreferrer" class="text - blue - 600 hover: text - blue - 800" onclick="event.stopPropagation()">View</a>` : '<span class="text - gray - 400">None</span>'}</td>
                            < td class="px-4 py-2 text-sm whitespace-nowrap" > <button onclick='openEditModal(${JSON.stringify(job).replace(/' /g, "&#39;")
        }) ' class="text-blue-600 hover:text-blue-800 mr-3">Edit</button><button onclick="deleteJob('${job.id} ')" class="text-red-600 hover:text-red-800">Delete</button></td>
                                </tr >
            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderStaffManagement() {
            return `<div class="space-y-4 md:space-y-6"><h2 class="text-xl md:text-2xl font-bold text-gray-900">Staff Management</h2><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">${staff.map(s => `<div class="bg-white rounded-lg shadow p-4 md:p-6 border-l-4" style="border-color: ${s.color_code}"><div class="flex items-start justify-between mb-3 md:mb-4"><div><h3 class="text-base md:text-lg font-bold text-gray-900">${s.full_name}</h3><p class="text-xs md:text-sm text-gray-500">@${s.username}</p></div><div class="w-8 h-8 md:w-10 md:h-10 rounded-full" style="background-color: ${s.color_code}"></div></div><div class="space-y-2 text-xs md:text-sm"><div><span class="font-medium">Phone:</span> ${s.phone || 'Not set'}</div><div><span class="font-medium">Status:</span> <span class="px-2 py-1 rounded-full text-xs ${s.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${s.active ? 'Active' : 'Inactive'}</span></div></div></div>`).join('')}</div><div class="bg-blue-50 border border-blue-200 rounded-lg p-3 md:p-4"><p class="text-xs md:text-sm text-blue-800"><strong>Note:</strong> To add or edit staff, access Supabase Table Editor.</p></div></div>`;
        }

        async function handleLogin(e) {
            e.preventDefault();
            await login(document.getElementById('username').value, document.getElementById('password').value);
        }

        async function handleJobSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const photoUrl = formData.get('photo_urls').trim();
            const assignedTo = formData.get('assigned_to') || null;
            const date = formData.get('date');
            const startTime = formData.get('start_time');
            const endTime = formData.get('end_time');

            if (endTime <= startTime) {
                alert('End time must be after start time.');
                return;
            }

            if (assignedTo) {
                const conflict = checkSchedulingConflict(date, startTime, endTime, assignedTo);
                if (conflict) {
                    const staffMember = staff.find(s => s.id === assignedTo);
                    alert(`Scheduling Conflict!\n\n${staffMember ? staffMember.full_name : 'This staff member'} is already assigned to:\n\nClient: ${conflict.client_name}\nDate: ${new Date(conflict.date).toLocaleDateString()}\nTime: ${formatTime12Hour(conflict.start_time)} - ${formatTime12Hour(conflict.end_time)}\n\nPlease choose a different staff member or time slot.`);
                    return;
                }
            }

            const jobData = {
                date: date,
                start_time: startTime,
                end_time: endTime,
                client_name: formData.get('client_name'),
                client_phone: formData.get('client_phone'),
                client_email: formData.get('client_email') || null,
                address: formData.get('address'),
                job_description: formData.get('job_description'),
                price: parseFloat(formData.get('price')),
                price_includes_gst: formData.get('price_includes_gst') === 'on',
                priority: formData.get('priority'),
                assigned_to: assignedTo,
                photo_urls: photoUrl ? [photoUrl] : null
            };

            await createJob(jobData);
        }

        function changeView(view) {
            currentView = view;
            currentStaffFilter = '';
            renderApp();
        }

        async function initialize() {
            checkAuth();
            if (currentUser) {
                await loadStaff();
                await loadJobs();
            }
            renderApp();
            if (currentUser) {
                setInterval(async () => {
                    await loadJobs();
                    if (currentView === 'dashboard' || currentView === 'all-jobs' || currentView === 'completed-jobs') renderApp();
                }, 120000);
            }
        }

        initialize();
    </script>
</body>

</html>
