<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Dashboard - Job Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'system-ui', '-apple-system', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .editable-cell {
            cursor: pointer;
            padding: 8px;
            min-height: 40px;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .editable-cell:hover {
            background-color: #f3f4f6;
            border-color: #3b82f6;
        }

        .editing {
            background-color: #fff;
            border-color: #3b82f6;
        }

        /* Table borders for all devices */
        table {
            border-collapse: collapse;
        }

        table th,
        table td {
            border: 1px solid #d1d5db;
        }

        @media (max-width: 768px) {
            .editable-cell {
                cursor: pointer;
                min-width: 100px;
                font-size: 13px;
            }

            /* Ensure date column is never truncated */
            td:first-child {
                min-width: 140px !important;
                white-space: nowrap !important;
            }

            .editable-cell:hover {
                background-color: #f3f4f6;
                border-color: #3b82f6;
            }

            /* Make table text smaller on mobile for better fit */
            table {
                font-size: 13px;
                border-collapse: collapse;
            }

            th {
                font-size: 11px;
                padding: 4px 8px !important;
                border: 1px solid #9ca3af;
            }

            td {
                padding: 4px 8px !important;
                border: 1px solid #9ca3af;
            }
        }

        #mobileMenu {
            transition: transform 0.3s ease-in-out;
        }

        .job-card {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .job-card:active {
            transform: scale(0.98);
        }

        .date-header {
            position: sticky;
            top: 64px;
            z-index: 20;
            background: linear-gradient(to bottom, #f9fafb 0%, #f3f4f6 100%);
        }

        .material-icons {
            vertical-align: middle;
            font-size: 20px;
        }

        .material-icons.md-18 {
            font-size: 18px;
        }

        .material-icons.md-24 {
            font-size: 24px;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .spin {
            animation: spin 1s linear infinite;
        }

        /* Mobile table improvements */
        @media (max-width: 768px) {
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
            }

            .overflow-x-auto::-webkit-scrollbar {
                height: 6px;
            }

            .overflow-x-auto::-webkit-scrollbar-track {
                background: #f1f1f1;
            }

            .overflow-x-auto::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 3px;
            }

            /* Better tap targets on mobile */
            .editable-cell {
                touch-action: manipulation;
            }

            /* Make action buttons more mobile-friendly */
            td button {
                padding: 6px 12px;
                font-size: 13px;
            }
        }

        .in-progress-row {
            background-color: #ff9966 !important;
        }

        /* Sticky first column */
        table thead th:first-child,
        table tbody td:first-child {
            position: sticky;
            left: 0;
            background: white;
            z-index: 10;
            box-shadow: 2px 0 4px rgba(0, 0, 0, 0.1);
        }

        table thead th:first-child {
            z-index: 20;
            background: #f9fafb;
            /* matches thead bg-gray-50 */
        }

        /* Keep background color for in-progress rows on sticky column */
        .in-progress-row td:first-child {
            background-color: #ff9966 !important;
        }

        /* Sticky table header */
        table thead {
            position: sticky;
            top: 0;
            z-index: 30;
            background: #f9fafb;
        }

        table thead th {
            background: #f9fafb;
        }
    </style>
</head>

<body class="bg-gray-50">
    <div id="app"></div>
    <div id="mobileMenuOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40" onclick="toggleMobileMenu()">
    </div>
    <div id="mobileMenu" class="fixed top-0 left-0 h-full w-64 bg-white shadow-xl z-50 transform -translate-x-full">
        <div class="p-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold text-gray-900">Menu</h2>
                <button onclick="toggleMobileMenu()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <nav class="space-y-2">
                <button onclick="changeView('dashboard'); toggleMobileMenu();"
                    class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 text-gray-700 font-medium flex items-center gap-3">
                    <span class="material-icons md-18">dashboard</span> Dashboard
                </button>
                <button onclick="changeView('create-job'); toggleMobileMenu();"
                    class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 text-gray-700 font-medium flex items-center gap-3">
                    <span class="material-icons md-18">add_circle</span> Create Job
                </button>
                <button onclick="changeView('all-jobs'); toggleMobileMenu();"
                    class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 text-gray-700 font-medium flex items-center gap-3">
                    <span class="material-icons md-18">work</span> Active Jobs
                </button>
                <button onclick="changeView('completed-jobs'); toggleMobileMenu();"
                    class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 text-gray-700 font-medium flex items-center gap-3">
                    <span class="material-icons md-18">check_circle</span> Completed Jobs
                </button>
                <button onclick="changeView('archived-jobs'); toggleMobileMenu();"
                    class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 text-gray-700 font-medium flex items-center gap-3">
                    <span class="material-icons md-18">archive</span> Archived Jobs
                </button>
                <button onclick="changeView('review-requests'); toggleMobileMenu();"
                    class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 text-gray-700 font-medium flex items-center gap-3">
                    <span class="material-icons md-18">rate_review</span> Review Requests
                </button>
                <button onclick="changeView('staff-management'); toggleMobileMenu();"
                    class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 text-gray-700 font-medium flex items-center gap-3">
                    <span class="material-icons md-18">group</span> Staff
                </button>
                <hr class="my-4">
                <button onclick="logout(); toggleMobileMenu();"
                    class="w-full text-left px-4 py-3 rounded-lg hover:bg-red-50 text-red-600 font-medium flex items-center gap-3">
                    <span class="material-icons md-18">logout</span> Logout
                </button>
            </nav>
        </div>
    </div>
    <div id="mobileJobModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg my-8">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-900">Job Details</h2>
                    <button onclick="closeMobileJobModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="mobileJobContent" class="space-y-4"></div>
                <div id="mobileJobModalButtons" class="flex gap-3 mt-6">
                    <button onclick="editJobFromMobile()"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg">Edit</button>
                    <button onclick="closeMobileJobModal()"
                        class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-medium py-3 px-6 rounded-lg">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    <div id="editJobModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 overflow-y-auto">
        <div class="flex min-h-screen items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl my-8 max-h-[90vh] flex flex-col">
                <div class="p-6 border-b flex-shrink-0">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900">Edit Job</h2>
                        <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="p-6 overflow-y-auto flex-1">
                    <form id="editJobForm" onsubmit="handleEditSubmit(event)" class="space-y-4">
                        <input type="hidden" id="edit_job_id">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Date *</label><input
                                    type="date" id="edit_date" required class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Start Time *</label>
                                <select id="edit_start_time" onchange="updateEndTimeOptions('edit')" required class="w-full px-4 py-2 border rounded-lg"></select>
                            </div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">End Time *</label>
                                <select id="edit_end_time" onchange="updateDurationDisplay('edit')" required class="w-full px-4 py-2 border rounded-lg"></select>
                            </div>
                            <div id="editDurationDisplay" class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg hidden">
                                <div class="flex items-center gap-2">
                                    <span class="material-icons text-blue-600">schedule</span>
                                    <span class="text-sm font-semibold text-blue-900">Job Duration: <span id="editDurationText"></span></span>
                                </div>
                            </div>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Assign To</label><select
                                id="edit_assigned_to" class="w-full px-4 py-2 border rounded-lg"></select></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                            <select id="edit_status" class="w-full px-4 py-2 border rounded-lg">
                                <option value="Unassigned">Unassigned</option>
                                <option value="Assigned">Assigned</option>
                                <option value="Assigned/Fix">Assigned/Fix</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Reschedule">Reschedule</option>
                                <option value="Completed">Completed</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Client Name *</label><input
                                type="text" id="edit_client_name" required class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Address *</label><textarea
                                id="edit_address" required rows="2"
                                class="w-full px-4 py-2 border rounded-lg"></textarea>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Suburb *</label><input
                                type="text" id="edit_suburb" list="suburbList" required
                                class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Phone *</label><input
                                type="tel" id="edit_client_phone" required class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Job Description
                                *</label><textarea id="edit_job_description" required rows="4"
                                class="w-full px-4 py-2 border rounded-lg"></textarea></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Price ($) *</label><input
                                type="number" step="0.01" id="edit_price" required
                                class="w-full px-4 py-2 border rounded-lg"></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">GST</label>
                            <div class="space-y-2">
                                <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                    <input type="radio" name="edit_price_includes_gst" value="false"
                                        class="w-4 h-4 text-green-600">
                                    <span class="ml-3">Price +GST</span>
                                </label>
                                <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                    <input type="radio" name="edit_price_includes_gst" value="true"
                                        class="w-4 h-4 text-gray-600">
                                    <span class="ml-3">Price excl GST</span>
                                </label>
                            </div>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Email</label><input
                                type="email" id="edit_client_email" class="w-full px-4 py-2 border rounded-lg"></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Contact Method</label>
                            <select id="edit_contact_method" class="w-full px-4 py-2 border rounded-lg">
                                <option value="">Not specified</option>
                                <option value="Phone Call">Phone Call</option>
                                <option value="Email">Email</option>
                                <option value="Whatsapp">Whatsapp</option>
                                <option value="SMS">SMS</option>
                                <option value="Referral">Referral</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Amount Paid
                                    ($)</label><input type="number" step="0.01" id="edit_amount_paid"
                                    class="w-full px-4 py-2 border rounded-lg"></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Payment
                                    Method</label><select id="edit_payment_method"
                                    class="w-full px-4 py-2 border rounded-lg">
                                    <option value="">Not specified</option>
                                    <option value="Cash">Cash</option>
                                    <option value="Bank Transfer/Card">Bank Transfer/Card</option>
                                </select></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Photos</label>
                            <div id="photoPreview" class="grid grid-cols-3 gap-2 mb-2">
                                <!-- Photos will be dynamically loaded here -->
                            </div>
                            <div class="flex gap-2">
                                <input type="file" id="photoUpload" accept="image/*" multiple class="hidden">
                                <button type="button" onclick="document.getElementById('photoUpload').click()"
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                                    <span class="material-icons text-sm">add_photo_alternate</span>
                                    Upload Photos
                                </button>
                                <span id="uploadStatus" class="text-sm text-gray-600 self-center"></span>
                            </div>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Priority</label><select
                                id="edit_priority" class="w-full px-4 py-2 border rounded-lg">
                                <option value="Normal">Normal</option>
                                <option value="High">High</option>
                                <option value="Urgent">Urgent</option>
                            </select></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Notes</label><textarea
                                id="edit_notes" rows="3" placeholder="Add any notes or comments about this job..."
                                class="w-full px-4 py-2 border rounded-lg"></textarea>
                            <p class="text-xs text-gray-500 mt-1">Track additional funds, special instructions, or other
                                important details</p>
                        </div>
                    </form>
                </div>
                <div class="p-6 border-t flex-shrink-0">
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button type="submit" form="editJobForm"
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg">Save
                            Changes</button>
                        <button type="button"
                            onclick="deleteJob(document.getElementById('edit_job_id').value); closeEditModal();"
                            class="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-6 rounded-lg">Delete</button>
                        <button type="button" onclick="closeEditModal()"
                            class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-3 px-6 rounded-lg">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="advancedExportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 overflow-y-auto">
        <div class="flex min-h-screen items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl my-8">
                <div class="p-6 border-b">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900">Advanced Export</h2>
                        <button onclick="closeAdvancedExportModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="p-6 max-h-[70vh] overflow-y-auto">
                    <form id="advancedExportForm" class="space-y-6">
                        <!-- Date Range -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Date Range</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">From Date</label>
                                    <input type="date" id="export_from_date" class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">To Date</label>
                                    <input type="date" id="export_to_date" class="w-full px-4 py-2 border rounded-lg">
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">Leave blank to export all dates</p>
                        </div>

                        <!-- Status Filter -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Status</h3>
                            <select id="export_status" class="w-full px-4 py-2 border rounded-lg">
                                <option value="all">All Statuses</option>
                                <option value="Unassigned">Unassigned</option>
                                <option value="Assigned">Assigned</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Assigned/Fix">Assigned/Fix</option>
                                <option value="Reschedule">Reschedule</option>
                                <option value="Completed">Completed</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>

                        <!-- Staff Filter -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Staff Member</h3>
                            <select id="export_staff" class="w-full px-4 py-2 border rounded-lg">
                                <option value="all">All Staff</option>
                            </select>
                        </div>

                        <!-- Column Selection -->
                        <div>
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-lg font-semibold text-gray-900">Select Columns</h3>
                                <div class="flex gap-2">
                                    <button type="button" onclick="selectAllExportColumns()"
                                        class="text-sm text-blue-600 hover:text-blue-800">Select All</button>
                                    <button type="button" onclick="deselectAllExportColumns()"
                                        class="text-sm text-gray-600 hover:text-gray-800">Deselect All</button>
                                </div>
                            </div>
                            <div
                                class="grid grid-cols-2 gap-3 max-h-60 overflow-y-auto border border-gray-200 rounded-lg p-4">
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_job_number"
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Job Number</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_date" checked
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Date</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_day" checked
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Day</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_start_time"
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Start Time</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_end_time"
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">End Time</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_client_name"
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Client Name</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_phone" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Phone</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_email" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Email</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_address"
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Address</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_suburb" checked
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Suburb</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_description"
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Description</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_assigned_to" checked
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Assigned To</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_status" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Status</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_priority"
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Priority</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_price" checked
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Price</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_gst" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">GST</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_amount_paid" checked
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Amount Paid</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_payment_method" checked
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Payment Method</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_actual_start"
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Actual Start</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_actual_end"
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Actual End</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_photo_url"
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Photo URL</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="export_col_contact_method"
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Contact Method</span>
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="p-6 border-t">
                    <div class="flex gap-3">
                        <button onclick="executeAdvancedExport()"
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-lg">
                            Export CSV
                        </button>
                        <button onclick="closeAdvancedExportModal()"
                            class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-3 px-6 rounded-lg">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="paymentModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Complete Job - Enter Payment</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Amount Paid ($)</label>
                    <input type="number" id="manager_amount_paid" step="0.01" placeholder="Enter amount"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Payment Method</label>
                    <div class="space-y-2">
                        <label
                            class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="manager_payment_method" value="Cash" checked
                                onchange="toggleSplitPaymentFields()" class="w-4 h-4 text-green-600">
                            <span class="ml-3 text-gray-900">Cash</span>
                        </label>
                        <label
                            class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="manager_payment_method" value="Bank Transfer/Card"
                                onchange="toggleSplitPaymentFields()" class="w-4 h-4 text-green-600">
                            <span class="ml-3 text-gray-900">Bank Transfer/Card</span>
                        </label>
                        <label
                            class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="manager_payment_method" value="Split"
                                onchange="toggleSplitPaymentFields()" class="w-4 h-4 text-green-600">
                            <span class="ml-3 text-gray-900">Split Payment (Cash + Bank)</span>
                        </label>
                    </div>
                </div>

                <!-- Split payment fields (hidden by default) -->
                <div id="split_payment_fields"
                    class="hidden space-y-4 mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="text-sm font-semibold text-blue-900 mb-2">Split Payment Breakdown</div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Cash Amount ($)</label>
                            <input type="number" id="manager_cash_amount" step="0.01" placeholder="0.00"
                                onchange="updateSplitTotal()"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Bank Amount ($)</label>
                            <input type="number" id="manager_bank_amount" step="0.01" placeholder="0.00"
                                onchange="updateSplitTotal()"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                    </div>
                    <div class="text-sm text-gray-600">
                        Total: <span id="split_total" class="font-bold text-blue-600">$0.00</span>
                    </div>
                </div>
                <div>
                    <label
                        class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="checkbox" id="manager_request_review" class="w-4 h-4 text-blue-600 rounded">
                        <span class="ml-3 text-gray-900">ðŸ˜Š Happy customer - Request review</span>
                    </label>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeManagerPaymentModal()"
                    class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-medium transition-colors">
                    Cancel
                </button>
                <button onclick="submitManagerCompletion()"
                    class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors">
                    Complete Job
                </button>
            </div>
        </div>
    </div>
    <div id="ratingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Add Review Rating</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Rating (1-5 stars)</label>
                    <div class="flex gap-2 justify-center">
                        <button onclick="selectRating(1)" id="star-1"
                            class="text-4xl text-gray-300 hover:text-yellow-400 transition-colors">â˜…</button>
                        <button onclick="selectRating(2)" id="star-2"
                            class="text-4xl text-gray-300 hover:text-yellow-400 transition-colors">â˜…</button>
                        <button onclick="selectRating(3)" id="star-3"
                            class="text-4xl text-gray-300 hover:text-yellow-400 transition-colors">â˜…</button>
                        <button onclick="selectRating(4)" id="star-4"
                            class="text-4xl text-gray-300 hover:text-yellow-400 transition-colors">â˜…</button>
                        <button onclick="selectRating(5)" id="star-5"
                            class="text-4xl text-gray-300 hover:text-yellow-400 transition-colors">â˜…</button>
                    </div>
                    <p class="text-center text-sm text-gray-500 mt-2" id="rating-text">Select a rating</p>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeRatingModal()"
                    class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-medium transition-colors">
                    Cancel
                </button>
                <button onclick="submitRating()"
                    class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
                    Save Rating
                </button>
            </div>
        </div>
    </div>
    <!-- Photo Gallery Modal -->
    <div id="photoGalleryModal"
        class="hidden fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4">
        <button onclick="closePhotoGallery()" class="absolute top-4 right-4 text-white hover:text-gray-300 z-10">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>

        <button onclick="previousPhoto()"
            class="absolute left-4 top-1/2 transform -translate-y-1/2 text-white hover:text-gray-300 bg-black bg-opacity-50 rounded-full p-3 z-10">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
        </button>

        <button onclick="nextPhoto()"
            class="absolute right-4 top-1/2 transform -translate-y-1/2 text-white hover:text-gray-300 bg-black bg-opacity-50 rounded-full p-3 z-10">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </button>

        <div class="max-w-6xl max-h-full flex flex-col">
            <img id="galleryImage" src="" alt="Job Photo" class="max-w-full max-h-[80vh] object-contain">
            <div class="text-center text-white mt-4">
                <span id="galleryCounter" class="text-sm">1 / 1</span>
            </div>
        </div>
    </div>
    <script>
        const SUPABASE_URL = 'https://ssxcjsdoxtgddnkugntl.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzeGNqc2RveHRnZGRua3VnbnRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NDEwODgsImV4cCI6MjA3NzMxNzA4OH0.C-lkPRJtFYa7YAgPavXRIGvV1LPkCXOJQYoVrZ4nCMw';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = null;
        let currentView = 'dashboard';
        let jobs = [];
        let staff = [];
        let selectedMobileJob = null;
        let currentStaffFilter = '';
        let currentDateFilter = '';
        let dashboardTimePeriod = 'this_month';
        let currentReviewTab = 'pending';
        let showAllColumns = false;
        let visibleColumns = {
            date: true,
            start_time: true,
            end_time: true,
            assigned_to: true,
            status: true,
            client_name: true,
            address: true,
            suburb: true,
            phone: true,
            description: true,
            price: true,
            email: false,
            amount_paid: false,
            payment_method: false,
            photos: false,
            notes: false,
            contact_method: false
        };
        let columnSelectorOpen = false;
        let pendingCompletionJobId = null;
        let pendingRatingJobId = null;
        let selectedRatingValue = 0;
        let reportTimePeriod = 'last_30_days';
        let reportStaffFilter = '';
        let reviewReportPeriod = 'this_week';
        let dashboardReviewPeriod = 'this_week';
        let dashboardReviewStaff = '';
        let scheduleViewMode = 'daily'; // 'daily' or 'weekly'

        // ==================== IMAGE UPLOAD FUNCTIONS ====================
        async function uploadImageToSupabase(file, jobId) {
            try {
                // Create a unique filename
                const timestamp = Date.now();
                const fileExt = file.name.split('.').pop();
                const fileName = `${jobId}/${timestamp}.${fileExt}`;

                // Upload file to Supabase Storage
                const {data, error} = await supabaseClient
                    .storage
                    .from('job-photos')
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (error) throw error;

                // Get public URL
                const {data: {publicUrl}} = supabaseClient
                    .storage
                    .from('job-photos')
                    .getPublicUrl(fileName);

                return publicUrl;
            } catch (error) {
                console.error('Error uploading image:', error);
                throw error;
            }
        }

        async function removePhotoFromEdit(photoIndex) {
            if (!confirm('Remove this photo?')) return;

            try {
                const jobId = document.getElementById('edit_job_id').value;

                const {data: job, error: fetchError} = await supabaseClient
                    .from('jobs')
                    .select('photo_urls')
                    .eq('id', jobId)
                    .single();

                if (fetchError) throw fetchError;

                const photoUrls = job.photo_urls || [];
                const imageUrl = photoUrls[photoIndex];

                // Remove from array
                photoUrls.splice(photoIndex, 1);

                // Update database
                const {error: updateError} = await supabaseClient
                    .from('jobs')
                    .update({photo_urls: photoUrls})
                    .eq('id', jobId);

                if (updateError) throw updateError;

                // Delete from storage
                await deleteImageFromSupabase(imageUrl);

                // Refresh the jobs data
                await loadJobs();

                // Refresh preview
                const photoPreview = document.getElementById('photoPreview');
                if (photoUrls.length > 0) {
                    photoPreview.innerHTML = photoUrls.map((url, index) => `
                        <div class="relative group">
                            <img src="${url}" alt="Job Photo ${index + 1}" class="w-full h-24 object-cover rounded border border-gray-300">
                            <button type="button" onclick="removePhotoFromEdit(${index})" 
                                class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                Ã—
                            </button>
                        </div>
                    `).join('');
                } else {
                    photoPreview.innerHTML = '<p class="text-sm text-gray-500">No photos uploaded</p>';
                }

                alert('Photo removed successfully!');
            } catch (error) {
                console.error('Error removing photo:', error);
                alert('Failed to remove photo: ' + error.message);
            }
        }

        async function deleteImageFromSupabase(imageUrl) {
            try {
                // Extract file path from URL
                const urlParts = imageUrl.split('/job-photos/');
                if (urlParts.length < 2) return;

                const filePath = urlParts[1];

                const {error} = await supabaseClient
                    .storage
                    .from('job-photos')
                    .remove([filePath]);

                if (error) throw error;
            } catch (error) {
                console.error('Error deleting image:', error);
            }
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const overlay = document.getElementById('mobileMenuOverlay');
            if (menu.classList.contains('-translate-x-full')) {
                menu.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                menu.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        async function login(username, password) {
            try {
                const {data, error} = await supabaseClient.from('manager_users').select('*').eq('username', username).eq('password', password).single();
                if (error || !data) {alert('Invalid username or password'); return false;}
                currentUser = data;
                localStorage.setItem('manager_user', JSON.stringify(data));
                await loadStaff();
                await loadJobs();
                renderApp();
                return true;
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed');
                return false;
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('manager_user');
            renderApp();
        }

        function checkAuth() {
            const stored = localStorage.getItem('manager_user');
            if (stored) currentUser = JSON.parse(stored);
        }

        async function loadJobs() {
            try {
                const {data, error} = await supabaseClient.from('jobs').select('*, staff:assigned_to (full_name, color_code)').order('date', {ascending: true}).order('start_time', {ascending: true});
                if (error) throw error;
                jobs = data || [];
                populateSuburbList();
                return jobs;
            } catch (error) {
                console.error('Error loading jobs:', error);
                return [];
            }
        }
        function populateSuburbList() {
            const suburbs = [...new Set(jobs.map(j => j.suburb).filter(s => s))];
            const datalist = document.getElementById('suburbList');
            if (datalist) {
                datalist.innerHTML = suburbs.map(s => '<option value="' + s + '">').join('');
            }
        }

        async function loadStaff() {
            try {
                const {data, error} = await supabaseClient.from('staff').select('*').eq('active', true).order('full_name');
                if (error) throw error;
                staff = data || [];
                return staff;
            } catch (error) {
                console.error('Error loading staff:', error);
                return [];
            }
        }

        function toggleColumns() {
            showAllColumns = !showAllColumns;
            renderApp();
        }

        function toggleColumnSelector() {
            columnSelectorOpen = !columnSelectorOpen;
            renderApp();
        }

        function toggleColumn(columnKey) {
            visibleColumns[columnKey] = !visibleColumns[columnKey];
            renderApp();
        }

        function selectAllColumns() {
            Object.keys(visibleColumns).forEach(key => {
                visibleColumns[key] = true;
            });
            renderApp();
        }

        function deselectAllColumns() {
            Object.keys(visibleColumns).forEach(key => {
                visibleColumns[key] = false;
            });
            // Keep essential columns visible
            visibleColumns.date = true;
            visibleColumns.status = true;
            visibleColumns.client_name = true;
            renderApp();
        }

        function generateCSV(jobsData, filterType) {
            // CSV Headers
            const headers = [
                'Job Number',
                'Date',
                'Day',
                'Start Time',
                'End Time',
                'Client Name',
                'Phone',
                'Email',
                'Address',
                'Suburb',
                'Job Description',
                'Assigned To',
                'Status',
                'Priority',
                'Price',
                'GST',
                'Amount Paid',
                'Payment Method',
                'Actual Start',
                'Actual End',
                'Photo URL',
                'Contact Method'
            ];

            // Convert jobs to CSV rows
            const rows = jobsData.map(job => {
                const jobDate = new Date(job.date);
                const dayName = jobDate.toLocaleDateString('en-US', {weekday: 'long'});

                return [
                    job.job_number || '',
                    job.date || '',
                    dayName,
                    job.start_time ? formatTime12Hour(job.start_time) : '',
                    job.end_time ? formatTime12Hour(job.end_time) : '',
                    job.client_name || '',
                    job.client_phone || '',
                    job.client_email || '',
                    job.address || '',
                    job.suburb || '',
                    job.job_description || '',
                    job.staff ? job.staff.full_name : 'Unassigned',
                    job.status || '',
                    job.priority || '',
                    job.price || '',
                    job.price_includes_gst ? 'Incl GST' : '+GST',
                    job.amount_paid || '',
                    job.payment_method || '',
                    job.actual_start_time ? new Date(job.actual_start_time).toLocaleString() : '',
                    job.actual_end_time ? new Date(job.actual_end_time).toLocaleString() : '',
                    job.photo_urls && job.photo_urls.length > 0 ? job.photo_urls[0] : '',
                    job.contact_method || ''
                ];
            });

            // Escape CSV values (handle commas and quotes)
            const escapeCSV = (value) => {
                if (value === null || value === undefined) return '';
                const stringValue = String(value);
                if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
                    return '"' + stringValue.replace(/"/g, '""') + '"';
                }
                return stringValue;
            };

            // Build CSV content
            let csv = headers.map(escapeCSV).join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(escapeCSV).join(',') + '\n';
            });

            // Create download
            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            const timestamp = new Date().toISOString().split('T')[0];
            const filename = `jobs_export_${filterType}_${timestamp}.csv`;

            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function generateSummaryReport() {
            // Get completed jobs based on current filters
            let completedJobs = jobs.filter(j => j.status === 'Completed');

            // Apply date filter if active
            if (currentDateFilter) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                completedJobs = completedJobs.filter(j => {
                    const jobDate = new Date(j.date);
                    jobDate.setHours(0, 0, 0, 0);

                    if (currentDateFilter === 'today') {
                        return jobDate.getTime() === today.getTime();
                    } else if (currentDateFilter === 'tomorrow') {
                        const tomorrow = new Date(today);
                        tomorrow.setDate(today.getDate() + 1);
                        return jobDate.getTime() === tomorrow.getTime();
                    } else if (currentDateFilter === 'this_week') {
                        const weekStart = new Date(today);
                        weekStart.setDate(today.getDate() - today.getDay());
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekStart.getDate() + 6);
                        return jobDate >= weekStart && jobDate <= weekEnd;
                    } else if (currentDateFilter === 'next_week') {
                        const nextWeekStart = new Date(today);
                        nextWeekStart.setDate(today.getDate() - today.getDay() + 7);
                        const nextWeekEnd = new Date(nextWeekStart);
                        nextWeekEnd.setDate(nextWeekStart.getDate() + 6);
                        return jobDate >= nextWeekStart && jobDate <= nextWeekEnd;
                    } else if (currentDateFilter === 'this_month') {
                        return jobDate.getMonth() === today.getMonth() && jobDate.getFullYear() === today.getFullYear();
                    }
                    return true;
                });
            }

            // Apply staff filter if active
            if (currentStaffFilter) {
                completedJobs = completedJobs.filter(j => j.assigned_to === currentStaffFilter);
            }

            // Separate by payment method - handle split payments
            const cashJobs = [];
            const bankJobs = [];

            completedJobs.forEach(j => {
                if (!j.amount_paid) return;

                if (j.payment_method === 'Cash') {
                    cashJobs.push(j);
                } else if (j.payment_method === 'Bank Transfer/Card') {
                    bankJobs.push(j);
                } else if (j.payment_method === 'Split') {
                    // For split payments, create separate entries for cash and bank portions
                    if (j.cash_amount && j.cash_amount > 0) {
                        cashJobs.push({
                            ...j,
                            amount_paid: j.cash_amount,
                            payment_method: 'Cash (Split)'
                        });
                    }
                    if (j.bank_amount && j.bank_amount > 0) {
                        bankJobs.push({
                            ...j,
                            amount_paid: j.bank_amount,
                            payment_method: 'Bank (Split)'
                        });
                    }
                }
            });

            // Helper function for CSV escaping
            const escapeCSV = (value) => {
                if (value === null || value === undefined) return '';
                const stringValue = String(value);
                if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
                    return '"' + stringValue.replace(/"/g, '""') + '"';
                }
                return stringValue;
            };

            // Build CSV content
            let csv = 'COMPLETED JOBS SUMMARY REPORT\n';
            csv += 'Generated: ' + new Date().toLocaleString() + '\n\n';

            // CASH TRANSACTIONS
            csv += '=== CASH TRANSACTIONS ===\n';
            csv += 'Job Number,Date,Day,Start Time,End Time,Client Name,Phone,Email,Address,Suburb,Job Description,Assigned To,Status,Priority,Price,GST Status,GST Amount,Amount Paid,Payment Method,Actual Start,Actual End,Photo URL,Contact Method\n';

            let cashGSTTotal = 0;

            cashJobs.forEach(job => {
                const jobDate = new Date(job.date);
                const dayName = jobDate.toLocaleDateString('en-US', {weekday: 'long'});

                // Calculate GST amount
                let gstAmount = 0;
                const amountPaid = parseFloat(job.amount_paid) || 0;
                if (amountPaid > 0) {
                    if (job.price_includes_gst) {
                        // "Excl GST" - Amount paid has NO GST in it
                        gstAmount = 0;
                    } else {
                        // "+GST" - Amount paid INCLUDES GST, extract it (GST = Total / 11)
                        gstAmount = amountPaid / 11;
                    }
                }
                cashGSTTotal += gstAmount;

                csv += [
                    job.job_number || '',
                    job.date || '',
                    dayName,
                    job.start_time ? formatTime12Hour(job.start_time) : '',
                    job.end_time ? formatTime12Hour(job.end_time) : '',
                    job.client_name || '',
                    job.client_phone || '',
                    job.client_email || '',
                    job.address || '',
                    job.suburb || '',
                    job.job_description || '',
                    job.staff ? job.staff.full_name : 'Unassigned',
                    job.status || '',
                    job.priority || '',
                    job.price || '',
                    job.price_includes_gst ? 'Excl GST' : '+GST',
                    '$' + gstAmount.toFixed(2),
                    job.amount_paid || '',
                    job.payment_method || '',
                    job.actual_start_time ? new Date(job.actual_start_time).toLocaleString() : '',
                    job.actual_end_time ? new Date(job.actual_end_time).toLocaleString() : '',
                    job.photo_urls && job.photo_urls.length > 0 ? job.photo_urls[0] : '',
                    job.contact_method || ''
                ].map(escapeCSV).join(',') + '\n';
            });

            const cashTotal = cashJobs.reduce((sum, j) => sum + (parseFloat(j.amount_paid) || 0), 0);
            const cashBaseAmount = cashTotal - cashGSTTotal;

            csv += '\n';
            csv += ',,,,,,,,,,,,,,,,SUBTOTAL (excl GST):,$' + cashBaseAmount.toFixed(2) + '\n';
            csv += ',,,,,,,,,,,,,,,,GST AMOUNT:,$' + cashGSTTotal.toFixed(2) + '\n';
            csv += ',,,,,,,,,,,,,,,,CASH TOTAL (incl GST):,$' + cashTotal.toFixed(2) + '\n';
            csv += ',,,,,,,,,,,,,,,,Number of Cash Jobs:,' + cashJobs.length + '\n';
            csv += '\n\n';

            // BANK TRANSACTIONS
            csv += '=== BANK TRANSACTIONS ===\n';
            csv += 'Job Number,Date,Day,Start Time,End Time,Client Name,Phone,Email,Address,Suburb,Job Description,Assigned To,Status,Priority,Price,GST Status,GST Amount,Amount Paid,Payment Method,Actual Start,Actual End,Photo URL,Contact Method\n';

            let bankGSTTotal = 0;

            bankJobs.forEach(job => {
                const jobDate = new Date(job.date);
                const dayName = jobDate.toLocaleDateString('en-US', {weekday: 'long'});

                // Calculate GST amount
                let gstAmount = 0;
                const amountPaid = parseFloat(job.amount_paid) || 0;
                if (amountPaid > 0) {
                    if (job.price_includes_gst) {
                        // "Excl GST" - Amount paid has NO GST in it
                        gstAmount = 0;
                    } else {
                        // "+GST" - Amount paid INCLUDES GST, extract it (GST = Total / 11)
                        gstAmount = amountPaid / 11;
                    }
                }
                bankGSTTotal += gstAmount;

                csv += [
                    job.job_number || '',
                    job.date || '',
                    dayName,
                    job.start_time ? formatTime12Hour(job.start_time) : '',
                    job.end_time ? formatTime12Hour(job.end_time) : '',
                    job.client_name || '',
                    job.client_phone || '',
                    job.client_email || '',
                    job.address || '',
                    job.suburb || '',
                    job.job_description || '',
                    job.staff ? job.staff.full_name : 'Unassigned',
                    job.status || '',
                    job.priority || '',
                    job.price || '',
                    job.price_includes_gst ? 'Excl GST' : '+GST',
                    '$' + gstAmount.toFixed(2),
                    job.amount_paid || '',
                    job.payment_method || '',
                    job.actual_start_time ? new Date(job.actual_start_time).toLocaleString() : '',
                    job.actual_end_time ? new Date(job.actual_end_time).toLocaleString() : '',
                    job.photo_urls && job.photo_urls.length > 0 ? job.photo_urls[0] : '',
                    job.contact_method || ''
                ].map(escapeCSV).join(',') + '\n';
            });

            const bankTotal = bankJobs.reduce((sum, j) => sum + (parseFloat(j.amount_paid) || 0), 0);
            const bankBaseAmount = bankTotal - bankGSTTotal;

            csv += '\n';
            csv += ',,,,,,,,,,,,,,,,SUBTOTAL (excl GST):,$' + bankBaseAmount.toFixed(2) + '\n';
            csv += ',,,,,,,,,,,,,,,,GST AMOUNT:,$' + bankGSTTotal.toFixed(2) + '\n';
            csv += ',,,,,,,,,,,,,,,,BANK TOTAL (incl GST):,$' + bankTotal.toFixed(2) + '\n';
            csv += ',,,,,,,,,,,,,,,,Number of Bank Jobs:,' + bankJobs.length + '\n';
            csv += '\n\n';

            // OVERALL SUMMARY
            const grandTotal = cashTotal + bankTotal;
            const grandGSTTotal = cashGSTTotal + bankGSTTotal;
            const grandBaseAmount = cashBaseAmount + bankBaseAmount;

            csv += '=== OVERALL SUMMARY ===\n';
            csv += 'Cash Subtotal (excl GST):,$' + cashBaseAmount.toFixed(2) + '\n';
            csv += 'Cash GST:,$' + cashGSTTotal.toFixed(2) + '\n';
            csv += 'Cash Total (incl GST):,$' + cashTotal.toFixed(2) + '\n';
            csv += '\n';
            csv += 'Bank Subtotal (excl GST):,$' + bankBaseAmount.toFixed(2) + '\n';
            csv += 'Bank GST:,$' + bankGSTTotal.toFixed(2) + '\n';
            csv += 'Bank Total (incl GST):,$' + bankTotal.toFixed(2) + '\n';
            csv += '\n';
            csv += 'GRAND SUBTOTAL (excl GST):,$' + grandBaseAmount.toFixed(2) + '\n';
            csv += 'GRAND GST AMOUNT:,$' + grandGSTTotal.toFixed(2) + '\n';
            csv += 'GRAND TOTAL (incl GST):,$' + grandTotal.toFixed(2) + '\n';
            csv += 'Total Jobs:,' + (cashJobs.length + bankJobs.length) + '\n';

            // Download the CSV
            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const timestamp = new Date().toISOString().split('T')[0];
            const filename = `summary_report_${timestamp}.csv`;

            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function openAdvancedExportModal() {
            // Populate staff dropdown
            const staffSelect = document.getElementById('export_staff');
            if (staffSelect) {
                const staffOptions = staff.map(s => '<option value="' + s.id + '">' + s.full_name + '</option>').join('');
                staffSelect.innerHTML = '<option value="all">All Staff</option>' + staffOptions;
            }

            // Set default dates (last 30 days to today)
            const today = new Date();
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(today.getDate() - 30);

            document.getElementById('export_to_date').value = today.toISOString().split('T')[0];
            document.getElementById('export_from_date').value = thirtyDaysAgo.toISOString().split('T')[0];

            document.getElementById('advancedExportModal').classList.remove('hidden');
        }

        function closeAdvancedExportModal() {
            document.getElementById('advancedExportModal').classList.add('hidden');
        }

        function openManagerPaymentModal(jobId) {
            pendingCompletionJobId = jobId;
            document.getElementById('manager_amount_paid').value = '';
            document.getElementById('manager_amount_paid').disabled = false;
            document.querySelector('input[name="manager_payment_method"][value="Cash"]').checked = true;
            document.getElementById('manager_request_review').checked = false;

            // Reset split payment fields
            document.getElementById('split_payment_fields').classList.add('hidden');
            document.getElementById('manager_cash_amount').value = '';
            document.getElementById('manager_bank_amount').value = '';
            document.getElementById('split_total').textContent = '$0.00';

            document.getElementById('paymentModal').classList.remove('hidden');
        }

        function closeManagerPaymentModal() {
            document.getElementById('paymentModal').classList.add('hidden');
            pendingCompletionJobId = null;
        }

        function toggleSplitPaymentFields() {
            const paymentMethod = document.querySelector('input[name="manager_payment_method"]:checked').value;
            const splitFields = document.getElementById('split_payment_fields');
            const amountPaidInput = document.getElementById('manager_amount_paid');

            if (paymentMethod === 'Split') {
                splitFields.classList.remove('hidden');
                amountPaidInput.disabled = true;
                amountPaidInput.value = '';
                amountPaidInput.placeholder = 'Will be calculated from split amounts';
            } else {
                splitFields.classList.add('hidden');
                amountPaidInput.disabled = false;
                amountPaidInput.placeholder = 'Enter amount';
                document.getElementById('manager_cash_amount').value = '';
                document.getElementById('manager_bank_amount').value = '';
                document.getElementById('split_total').textContent = '$0.00';
            }
        }

        function updateSplitTotal() {
            const cashAmount = parseFloat(document.getElementById('manager_cash_amount').value) || 0;
            const bankAmount = parseFloat(document.getElementById('manager_bank_amount').value) || 0;
            const total = cashAmount + bankAmount;

            document.getElementById('split_total').textContent = '$' + total.toFixed(2);
            document.getElementById('manager_amount_paid').value = total.toFixed(2);
        }


        async function submitManagerCompletion() {
            const paymentMethod = document.querySelector('input[name="manager_payment_method"]:checked').value;
            const requestReview = document.getElementById('manager_request_review').checked;

            let amountPaid, cashAmount = null, bankAmount = null;

            if (paymentMethod === 'Split') {
                cashAmount = parseFloat(document.getElementById('manager_cash_amount').value) || 0;
                bankAmount = parseFloat(document.getElementById('manager_bank_amount').value) || 0;
                amountPaid = cashAmount + bankAmount;

                if (cashAmount <= 0 && bankAmount <= 0) {
                    alert('Please enter valid cash and/or bank amounts for split payment.');
                    return;
                }
            } else {
                amountPaid = document.getElementById('manager_amount_paid').value;

                if (!amountPaid || amountPaid === '' || parseFloat(amountPaid) < 0) {
                    alert('Please enter a valid amount paid.');
                    return;
                }
            }

            if (!pendingCompletionJobId) {
                alert('Error: No job selected. Please refresh and try again.');
                closeManagerPaymentModal();
                return;
            }

            try {
                const updateData = {
                    status: 'Completed',
                    amount_paid: Number(parseFloat(amountPaid).toFixed(2)),
                    payment_method: paymentMethod,
                    request_review: requestReview,
                    review_sent: false,
                    review_received: false,
                    review_rating: null,
                    review_received_date: null,
                    actual_end_time: new Date().toISOString()
                };

                // Add split amounts if payment method is Split
                if (paymentMethod === 'Split') {
                    updateData.cash_amount = Number(cashAmount.toFixed(2));
                    updateData.bank_amount = Number(bankAmount.toFixed(2));
                } else {
                    updateData.cash_amount = null;
                    updateData.bank_amount = null;
                }

                const {error} = await supabaseClient
                    .from('jobs')
                    .update(updateData)
                    .eq('id', pendingCompletionJobId);

                if (error) throw error;

                closeManagerPaymentModal();
                await loadJobs();
                renderApp();
            } catch (error) {
                console.error('Error completing job:', error);
                alert('Failed to complete job. Please try again.');
            }
        }

        function selectAllExportColumns() {
            document.querySelectorAll('[id^="export_col_"]').forEach(checkbox => {
                checkbox.checked = true;
            });
        }

        function deselectAllExportColumns() {
            document.querySelectorAll('[id^="export_col_"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        function executeAdvancedExport() {
            // Get filter values
            const fromDate = document.getElementById('export_from_date').value;
            const toDate = document.getElementById('export_to_date').value;
            const status = document.getElementById('export_status').value;
            const staffId = document.getElementById('export_staff').value;

            // Get selected columns
            const selectedColumns = {
                job_number: document.getElementById('export_col_job_number').checked,
                date: document.getElementById('export_col_date').checked,
                day: document.getElementById('export_col_day').checked,
                start_time: document.getElementById('export_col_start_time').checked,
                end_time: document.getElementById('export_col_end_time').checked,
                client_name: document.getElementById('export_col_client_name').checked,
                phone: document.getElementById('export_col_phone').checked,
                email: document.getElementById('export_col_email').checked,
                address: document.getElementById('export_col_address').checked,
                suburb: document.getElementById('export_col_suburb').checked,
                description: document.getElementById('export_col_description').checked,
                assigned_to: document.getElementById('export_col_assigned_to').checked,
                status: document.getElementById('export_col_status').checked,
                priority: document.getElementById('export_col_priority').checked,
                price: document.getElementById('export_col_price').checked,
                gst: document.getElementById('export_col_gst').checked,
                amount_paid: document.getElementById('export_col_amount_paid').checked,
                payment_method: document.getElementById('export_col_payment_method').checked,
                actual_start: document.getElementById('export_col_actual_start').checked,
                actual_end: document.getElementById('export_col_actual_end').checked,
                photo_url: document.getElementById('export_col_photo_url').checked,
                contact_method: document.getElementById('export_col_contact_method').checked
            };

            // Filter jobs
            let filteredJobs = [...jobs]; // Create a copy of all jobs

            // Debug: Log what we're filtering
            console.log('Filtering jobs:', {
                totalJobs: filteredJobs.length,
                fromDate: fromDate,
                toDate: toDate,
                status: status,
                staffId: staffId
            });

            // Filter by date range
            if (fromDate) {
                const fromDateObj = new Date(fromDate + 'T00:00:00');
                filteredJobs = filteredJobs.filter(j => {
                    if (!j.date) return false;
                    const jobDate = new Date(j.date + 'T00:00:00');
                    return jobDate >= fromDateObj;
                });
                console.log(`After fromDate filter (${fromDate}):`, filteredJobs.length);
            }

            if (toDate) {
                const toDateObj = new Date(toDate + 'T23:59:59');
                filteredJobs = filteredJobs.filter(j => {
                    if (!j.date) return false;
                    const jobDate = new Date(j.date + 'T00:00:00');
                    return jobDate <= toDateObj;
                });
                console.log(`After toDate filter (${toDate}):`, filteredJobs.length);
            }

            // Filter by status
            if (status !== 'all') {
                filteredJobs = filteredJobs.filter(j => j.status === status);
                console.log(`After status filter (${status}):`, filteredJobs.length);
            }

            // Filter by staff
            if (staffId !== 'all') {
                filteredJobs = filteredJobs.filter(j => j.assigned_to === staffId);
                console.log(`After staff filter (${staffId}):`, filteredJobs.length);
            }

            if (filteredJobs.length === 0) {
                alert('No jobs match your selected filters.');
                return;
            }

            console.log('Final filtered jobs count:', filteredJobs.length);

            // Generate CSV with selected columns
            generateAdvancedCSV(filteredJobs, selectedColumns);
            closeAdvancedExportModal();
        }

        function generateAdvancedCSV(jobsData, selectedColumns) {
            // Build headers based on selected columns
            const headers = [];
            if (selectedColumns.job_number) headers.push('Job Number');
            if (selectedColumns.date) headers.push('Date');
            if (selectedColumns.day) headers.push('Day');
            if (selectedColumns.start_time) headers.push('Start Time');
            if (selectedColumns.end_time) headers.push('End Time');
            if (selectedColumns.client_name) headers.push('Client Name');
            if (selectedColumns.phone) headers.push('Phone');
            if (selectedColumns.email) headers.push('Email');
            if (selectedColumns.address) headers.push('Address');
            if (selectedColumns.suburb) headers.push('Suburb');
            if (selectedColumns.description) headers.push('Job Description');
            if (selectedColumns.assigned_to) headers.push('Assigned To');
            if (selectedColumns.status) headers.push('Status');
            if (selectedColumns.priority) headers.push('Priority');
            if (selectedColumns.price) headers.push('Price');
            if (selectedColumns.gst) headers.push('GST');
            if (selectedColumns.amount_paid) headers.push('Amount Paid');
            if (selectedColumns.payment_method) headers.push('Payment Method');
            if (selectedColumns.actual_start) headers.push('Actual Start');
            if (selectedColumns.actual_end) headers.push('Actual End');
            if (selectedColumns.photo_url) headers.push('Photo URL');
            if (selectedColumns.contact_method) headers.push('Contact Method');

            // Build rows based on selected columns
            const rows = jobsData.map(job => {
                const row = [];
                const jobDate = new Date(job.date);
                const dayName = jobDate.toLocaleDateString('en-US', {weekday: 'long'});

                if (selectedColumns.job_number) row.push(job.job_number || '');
                if (selectedColumns.date) row.push(job.date || '');
                if (selectedColumns.day) row.push(dayName);
                if (selectedColumns.start_time) row.push(job.start_time ? formatTime12Hour(job.start_time) : '');
                if (selectedColumns.end_time) row.push(job.end_time ? formatTime12Hour(job.end_time) : '');
                if (selectedColumns.client_name) row.push(job.client_name || '');
                if (selectedColumns.phone) row.push(job.client_phone || '');
                if (selectedColumns.email) row.push(job.client_email || '');
                if (selectedColumns.address) row.push(job.address || '');
                if (selectedColumns.suburb) row.push(job.suburb || '');
                if (selectedColumns.description) row.push(job.job_description || '');
                if (selectedColumns.assigned_to) row.push(job.staff ? job.staff.full_name : 'Unassigned');
                if (selectedColumns.status) row.push(job.status || '');
                if (selectedColumns.priority) row.push(job.priority || '');
                if (selectedColumns.price) row.push(job.price || '');
                if (selectedColumns.gst) row.push(job.price_includes_gst ? 'Excl GST' : '+GST');
                if (selectedColumns.amount_paid) row.push(job.amount_paid || '');
                if (selectedColumns.payment_method) row.push(job.payment_method || '');
                if (selectedColumns.actual_start) row.push(job.actual_start_time ? new Date(job.actual_start_time).toLocaleString() : '');
                if (selectedColumns.actual_end) row.push(job.actual_end_time ? new Date(job.actual_end_time).toLocaleString() : '');
                if (selectedColumns.photo_url) row.push(job.photo_urls && job.photo_urls.length > 0 ? job.photo_urls[0] : '');
                if (selectedColumns.contact_method) row.push(job.contact_method || '');

                return row;
            });

            // Escape CSV values
            const escapeCSV = (value) => {
                if (value === null || value === undefined) return '';
                const stringValue = String(value);
                if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
                    return '"' + stringValue.replace(/"/g, '""') + '"';
                }
                return stringValue;
            };

            // Build CSV content
            let csv = headers.map(escapeCSV).join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(escapeCSV).join(',') + '\n';
            });

            // Add comprehensive summary section
            csv += '\n\n';
            csv += 'SUMMARY REPORT\n';
            csv += '========================================\n\n';

            // Date range info
            const fromDate = document.getElementById('export_from_date').value;
            const toDate = document.getElementById('export_to_date').value;
            csv += 'Date Range:,' + (fromDate || 'All') + ' to ' + (toDate || 'All') + '\n';

            // Status info
            const status = document.getElementById('export_status').value;
            csv += 'Status Filter:,' + (status === 'all' ? 'All Statuses' : status) + '\n';

            // Staff info
            const staffId = document.getElementById('export_staff').value;
            if (staffId !== 'all') {
                const staffMember = staff.find(s => s.id === staffId);
                csv += 'Staff Filter:,' + (staffMember ? staffMember.full_name : 'Unknown') + '\n';
            }

            csv += 'Total Jobs Exported:,' + jobsData.length + '\n';
            csv += 'Export Generated:,' + new Date().toLocaleString() + '\n\n';

            // Calculate financials
            let cashTotal = 0;
            let bankTotal = 0;
            let totalRevenue = 0;
            let cashJobs = 0;
            let bankJobs = 0;
            let splitJobs = 0;

            jobsData.forEach(j => {
                const amountPaid = parseFloat(j.amount_paid) || 0;
                totalRevenue += amountPaid;

                if (j.payment_method === 'Cash') {
                    cashTotal += amountPaid;
                    cashJobs++;
                } else if (j.payment_method === 'Bank Transfer/Card') {
                    bankTotal += amountPaid;
                    bankJobs++;
                } else if (j.payment_method === 'Split') {
                    const cashAmount = parseFloat(j.cash_amount) || 0;
                    const bankAmount = parseFloat(j.bank_amount) || 0;
                    cashTotal += cashAmount;
                    bankTotal += bankAmount;
                    splitJobs++;
                }
            });

            // Calculate GST breakdown
            let cashGST = 0;
            let bankGST = 0;
            let cashExclGST = 0;
            let bankExclGST = 0;

            jobsData.forEach(j => {
                const amountPaid = parseFloat(j.amount_paid) || 0;
                if (amountPaid > 0) {
                    if (j.payment_method === 'Cash' || j.payment_method === 'Split') {
                        if (!j.price_includes_gst) {
                            // Amount includes GST, so extract it
                            const gst = amountPaid / 11;
                            cashGST += gst;
                        }
                    } else if (j.payment_method === 'Bank Transfer/Card') {
                        if (!j.price_includes_gst) {
                            const gst = amountPaid / 11;
                            bankGST += gst;
                        }
                    }
                }
            });

            cashExclGST = cashTotal - cashGST;
            bankExclGST = bankTotal - bankGST;

            // Cash Summary
            csv += 'CASH TRANSACTIONS\n';
            csv += 'Number of Cash Jobs:,' + cashJobs + '\n';
            csv += 'Cash Subtotal (excl GST):,$' + cashExclGST.toFixed(2) + '\n';
            csv += 'Cash GST:,$' + cashGST.toFixed(2) + '\n';
            csv += 'Cash Total (incl GST):,$' + cashTotal.toFixed(2) + '\n\n';

            // Bank Summary
            csv += 'BANK TRANSACTIONS\n';
            csv += 'Number of Bank Jobs:,' + bankJobs + '\n';
            csv += 'Bank Subtotal (excl GST):,$' + bankExclGST.toFixed(2) + '\n';
            csv += 'Bank GST:,$' + bankGST.toFixed(2) + '\n';
            csv += 'Bank Total (incl GST):,$' + bankTotal.toFixed(2) + '\n\n';

            // Split Payments Summary
            if (splitJobs > 0) {
                csv += 'SPLIT PAYMENTS\n';
                csv += 'Number of Split Payment Jobs:,' + splitJobs + '\n\n';
            }

            // Overall Summary
            csv += 'OVERALL SUMMARY\n';
            csv += 'Total Subtotal (excl GST):,$' + (cashExclGST + bankExclGST).toFixed(2) + '\n';
            csv += 'Total GST:,$' + (cashGST + bankGST).toFixed(2) + '\n';
            csv += 'Grand Total (incl GST):,$' + totalRevenue.toFixed(2) + '\n';
            csv += 'Total Completed Jobs:,' + (cashJobs + bankJobs + splitJobs) + '\n';

            // Create download
            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            const timestamp = new Date().toISOString().split('T')[0];
            const filename = `jobs_export_advanced_${timestamp}.csv`;

            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function formatDateWithDay(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const options = {weekday: 'short', day: 'numeric', month: 'short'};
            return date.toLocaleDateString('en-US', options);
        }

        function getDateColor(dateString) {
            if (!dateString) return '#f3f4f6';

            // Generate a consistent color based on the date string
            // This ensures same dates always get the same color
            const colors = [
                '#dbeafe', // blue-100
                '#fce7f3', // pink-100
                '#ddd6fe', // violet-100
                '#fbcfe8', // fuchsia-100
                '#e9d5ff', // purple-100
                '#fef3c7', // amber-100
                '#fed7aa', // orange-100
                '#d1fae5', // emerald-100
                '#a7f3d0', // green-100
                '#fecaca', // red-100
                '#bfdbfe', // blue-200
                '#f9a8d4', // pink-200
                '#c4b5fd', // violet-200
                '#f5d0fe', // fuchsia-200
                '#e9d5ff', // purple-200
                '#fde68a', // amber-200
                '#fed7aa', // orange-200
                '#6ee7b7', // emerald-200
            ];

            // Create a hash from the date string
            let hash = 0;
            for (let i = 0; i < dateString.length; i++) {
                hash = dateString.charCodeAt(i) + ((hash << 5) - hash);
            }

            // Use the hash to pick a color consistently
            const index = Math.abs(hash) % colors.length;
            return colors[index];
        }

        function getDateTextColor(dateString) {
            if (!dateString) return '#374151';

            // Corresponding darker text colors for readability
            const textColors = [
                '#1e40af', // blue-800
                '#be185d', // pink-800
                '#5b21b6', // violet-800
                '#a21caf', // fuchsia-800
                '#6b21a8', // purple-800
                '#b45309', // amber-800
                '#c2410c', // orange-800
                '#065f46', // emerald-800
                '#047857', // green-800
                '#991b1b', // red-800
                '#1e3a8a', // blue-900
                '#831843', // pink-900
                '#4c1d95', // violet-900
                '#701a75', // fuchsia-900
                '#581c87', // purple-900
                '#78350f', // amber-900
                '#7c2d12', // orange-900
                '#064e3b', // emerald-900
            ];

            // Same hash logic to match the background color
            let hash = 0;
            for (let i = 0; i < dateString.length; i++) {
                hash = dateString.charCodeAt(i) + ((hash << 5) - hash);
            }

            const index = Math.abs(hash) % textColors.length;
            return textColors[index];
        }

        async function updateJobField(jobId, field, value) {
            try {
                const job = jobs.find(j => j.id === jobId);
                if (!job) throw new Error('Job not found');

                // Intercept status change to "Completed" - open payment modal instead
                if (field === 'status' && value === 'Completed') {
                    openManagerPaymentModal(jobId);
                    return true;
                }

                // Reset review fields if changing FROM "Completed" to any other status
                if (field === 'status' && job.status === 'Completed' && value !== 'Completed') {
                    const {error} = await supabaseClient.from('jobs').update({
                        status: value,
                        request_review: false,
                        review_sent: false,
                        review_received: false,
                        review_rating: null,
                        review_received_date: null,
                        amount_paid: null,
                        payment_method: null
                    }).eq('id', jobId);

                    if (error) throw error;
                    await loadJobs();
                    renderApp();
                    return true;
                }

                // Check for time conflicts when changing staff, date, start_time, or end_time
                if (field === 'assigned_to' || field === 'date' || field === 'start_time' || field === 'end_time') {
                    const checkStaff = field === 'assigned_to' ? value : job.assigned_to;
                    const checkDate = field === 'date' ? value : job.date;
                    const checkStart = field === 'start_time' ? value : job.start_time;
                    const checkEnd = field === 'end_time' ? value : job.end_time;
                    
                    if (checkStaff && checkDate && checkStart && checkEnd) {
                        const conflicts = checkTimeSlotConflict(checkStaff, checkDate, checkStart, checkEnd, jobId);
                        if (conflicts) {
                            const staffMember = staff.find(s => s.id === checkStaff);
                            const conflictJob = conflicts[0];
                            alert('âŒ TIME SLOT CONFLICT!\n\n' +
                                'Staff: ' + (staffMember ? staffMember.full_name : 'Unknown') + '\n' +
                                'Date: ' + new Date(checkDate).toLocaleDateString() + '\n' +
                                'Time: ' + formatTime12Hour(checkStart) + ' - ' + formatTime12Hour(checkEnd) + '\n\n' +
                                'CONFLICTS WITH:\n' +
                                'Client: ' + conflictJob.client_name + '\n' +
                                'Time: ' + formatTime12Hour(conflictJob.start_time) + ' - ' + formatTime12Hour(conflictJob.end_time) + '\n' +
                                'Status: ' + conflictJob.status + '\n\n' +
                                'Change not saved. Please choose a different value.');
                            return false;
                        }
                    }
                }

                const {error} = await supabaseClient.from('jobs').update({[field]: value}).eq('id', jobId);
                if (error) throw error;

                await loadJobs();
                renderApp();

                return true;
            } catch (error) {
                console.error('Error updating job:', error);
                alert('Failed to update: ' + error.message);
                return false;
            }
        }

        function formatTime12Hour(time24) {
            if (!time24) return '';
            const parts = time24.split(':');
            const hour = parseInt(parts[0]);
            const minutes = parts[1];
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const hour12 = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
            return hour12 + ':' + minutes + ' ' + ampm;
        }

        function makeEditable(jobId, field, currentValue, type) {
            const cellId = 'cell-' + jobId + '-' + field;
            const cell = document.getElementById(cellId);
            if (!cell || cell.classList.contains('editing')) return;
            cell.classList.add('editing');
            const originalContent = cell.innerHTML;
            let input;

            if (type === 'date') {
                input = document.createElement('input');
                input.type = 'date';
                input.value = currentValue || '';
                input.className = 'w-full px-2 py-1 border border-blue-500 rounded focus:outline-none';
                // Add change event for immediate save on mobile
                input.addEventListener('change', async () => {
                    const newValue = input.value;
                    if (newValue !== currentValue) {
                        await updateJobField(jobId, field, newValue || null);
                    } else {
                        cell.innerHTML = originalContent;
                        cell.classList.remove('editing');
                    }
                });
            } else if (type === 'time') {
                input = document.createElement('select');
                input.className = 'w-full px-2 py-1 border border-blue-500 rounded focus:outline-none';
                input.innerHTML = '<option value="">Select...</option>' + generateTimeOptions(currentValue);
            } else if (type === 'select-status') {
                input = document.createElement('select');
                input.className = 'w-full px-2 py-1 border border-blue-500 rounded focus:outline-none';
                const statuses = ['Unassigned', 'Assigned', 'Assigned/Fix', 'In Progress', 'Reschedule', 'Cancelled', 'Completed'];
                input.innerHTML = statuses.map(s => '<option value="' + s + '"' + (currentValue === s ? ' selected' : '') + '>' + s + '</option>').join('');
            } else if (type === 'select-staff') {
                input = document.createElement('select');
                input.className = 'w-full px-2 py-1 border border-blue-500 rounded focus:outline-none';
                input.innerHTML = '<option value="">Unassigned</option>' + staff.map(s => '<option value="' + s.id + '"' + (currentValue === s.id ? ' selected' : '') + '>' + s.full_name + '</option>').join('');
            } else if (type === 'select-payment') {
                input = document.createElement('select');
                input.className = 'w-full px-2 py-1 border border-blue-500 rounded focus:outline-none';
                const methods = ['', 'Cash', 'Bank Transfer/Card'];
                input.innerHTML = methods.map(m => '<option value="' + m + '"' + (currentValue === m ? ' selected' : '') + '>' + (m || 'Not specified') + '</option>').join('');
            } else if (type === 'select-contact') {
                input = document.createElement('select');
                input.className = 'w-full px-2 py-1 border border-blue-500 rounded focus:outline-none';
                const methods = ['', 'Phone Call', 'Email', 'Whatsapp', 'SMS', 'Referral', 'Other'];
                input.innerHTML = methods.map(m => '<option value="' + m + '"' + (currentValue === m ? ' selected' : '') + '>' + (m || 'Not specified') + '</option>').join('');
            } else if (type === 'number') {
                input = document.createElement('input');
                input.type = 'number';
                input.step = '0.01';
                input.value = currentValue || '';
                input.className = 'w-full px-2 py-1 border border-blue-500 rounded focus:outline-none';
            } else if (type === 'url') {
                input = document.createElement('input');
                input.type = 'url';
                input.value = currentValue || '';
                input.placeholder = 'https://...';
                input.className = 'w-full px-2 py-1 border border-blue-500 rounded focus:outline-none';
            } else if (type === 'textarea') {
                input = document.createElement('textarea');
                input.value = currentValue || '';
                input.rows = 3;
                input.className = 'w-full px-2 py-1 border border-blue-500 rounded focus:outline-none';
            } else {
                input = document.createElement('input');
                input.type = 'text';
                input.value = currentValue || '';
                input.className = 'w-full px-2 py-1 border border-blue-500 rounded focus:outline-none';
            }
            cell.innerHTML = '';
            cell.appendChild(input);

            // Prevent browser from auto-scrolling when input is focused
            const currentScroll = window.lastScrollPosition || window.pageYOffset;
            input.focus({preventScroll: true});

            // Restore scroll immediately after focus
            window.scrollTo(0, currentScroll);
            const save = async () => {
                // Save scroll position HERE, before any updates
                const savedScrollPosition = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop;

                const newValue = input.value;
                if (newValue !== currentValue) {
                    const success = await updateJobField(jobId, field, newValue || null, savedScrollPosition);
                    if (!success) {
                        cell.innerHTML = originalContent;
                        cell.classList.remove('editing');
                    }
                } else {
                    cell.innerHTML = originalContent;
                    cell.classList.remove('editing');
                }
            };
            const cancel = () => {
                cell.innerHTML = originalContent;
                cell.classList.remove('editing');
            };
            input.addEventListener('blur', save);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {e.preventDefault(); save();}
                else if (e.key === 'Escape') {e.preventDefault(); cancel();}
            });
            if (type.startsWith('select-') || type === 'time') {
                input.addEventListener('change', save);
            }
        }

        function openMobileJobModal(jobId) {
            const job = jobs.find(j => j.id === jobId);
            if (!job) return;
            selectedMobileJob = job;
            const modal = document.getElementById('mobileJobModal');
            const content = document.getElementById('mobileJobContent');
            const gstBadge = job.price_includes_gst ? '<span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded">incl. GST</span>' : '<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded font-medium">+GST</span>';
            content.innerHTML = '<div class="space-y-3 text-sm">' +
                '<div class="flex justify-between py-2 border-b"><span class="font-semibold text-gray-600">Date:</span><span class="text-gray-900">' + new Date(job.date).toLocaleDateString() + '</span></div>' +
                '<div class="flex justify-between py-2 border-b"><span class="font-semibold text-gray-600">Start Time:</span><span class="text-gray-900">' + formatTime12Hour(job.start_time) + '</span></div>' +
                '<div class="flex justify-between py-2 border-b"><span class="font-semibold text-gray-600">End Time:</span><span class="text-gray-900">' + formatTime12Hour(job.end_time) + '</span></div>' +
                '<div class="flex justify-between py-2 border-b"><span class="font-semibold text-gray-600">Assigned To:</span><span class="text-gray-900">' + (job.staff ? job.staff.full_name : 'Unassigned') + '</span></div>' +
                '<div class="flex justify-between py-2 border-b"><span class="font-semibold text-gray-600">Status:</span><span class="px-2 py-1 rounded-full text-xs font-medium ' + getStatusClass(job.status) + '">' + job.status + '</span></div>' +
                '<div class="flex justify-between py-2 border-b"><span class="font-semibold text-gray-600">Client Name:</span><span class="text-gray-900">' + escapeHtml(job.client_name) + '</span></div>' +
                '<div class="py-2 border-b"><span class="font-semibold text-gray-600 block mb-1">Address:</span><span class="text-gray-900">' + escapeHtml(job.address) + '</span></div>' +
                '<div class="flex justify-between py-2 border-b"><span class="font-semibold text-gray-600">Phone:</span><span class="text-gray-900">' + escapeHtml(job.client_phone) + '</span></div>' +
                '<div class="py-2 border-b"><span class="font-semibold text-gray-600 block mb-1">Description:</span><span class="text-gray-900 whitespace-pre-wrap">' + escapeHtml(job.job_description) + '</span></div>' +
                '<div class="flex justify-between items-center py-2 border-b"><span class="font-semibold text-gray-600">Price:</span><span class="text-gray-900 flex items-center gap-2">$' + parseFloat(job.price).toFixed(2) + ' ' + gstBadge + '</span></div>' +
                '<div class="flex justify-between py-2 border-b"><span class="font-semibold text-gray-600">Email:</span><span class="text-gray-900">' + (job.client_email || 'N/A') + '</span></div>' +
                '<div class="flex justify-between py-2 border-b"><span class="font-semibold text-gray-600">Contact Method:</span><span class="text-gray-900">' + (job.contact_method || 'N/A') + '</span></div>' +
                '<div class="flex justify-between py-2 border-b"><span class="font-semibold text-gray-600">Amount Paid:</span><span class="text-gray-900">' + (job.amount_paid ? '$' + parseFloat(job.amount_paid).toFixed(2) : 'N/A') + '</span></div>' +
                '<div class="flex justify-between py-2 border-b"><span class="font-semibold text-gray-600">Payment Method:</span><span class="text-gray-900">' + (job.payment_method || 'N/A') + '</span></div>' +
                '<div class="flex justify-between py-2"><span class="font-semibold text-gray-600">Photos:</span><span class="text-gray-900">' + (job.photo_urls && job.photo_urls.length > 0 ? '<button onclick="event.stopPropagation(); openPhotoGallery(' + JSON.stringify(job.photo_urls).replace(/"/g, '&quot;') + ', 0)" class="text-blue-600 hover:text-blue-800 underline">View (' + job.photo_urls.length + ')</button>' : 'None') + '</span></div>' +
                (job.notes ? '<div class="py-2 border-t mt-2"><span class="font-semibold text-gray-600 block mb-1">Notes:</span><span class="text-gray-900 whitespace-pre-wrap bg-yellow-50 p-2 rounded">' + escapeHtml(job.notes) + '</span></div>' : '') +
                '</div>';

            // Update buttons based on job status
            const buttonsContainer = document.getElementById('mobileJobModalButtons');
            if (job.status === 'Completed') {
                buttonsContainer.innerHTML = '<button onclick="duplicateJobFromMobile()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-lg">Duplicate</button>' +
                    '<button onclick="editJobFromMobile()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg">Edit</button>' +
                    '<button onclick="closeMobileJobModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-medium py-3 px-6 rounded-lg">Cancel</button>';
            } else {
                buttonsContainer.innerHTML = '<button onclick="editJobFromMobile()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg">Edit</button>' +
                    '<button onclick="closeMobileJobModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-medium py-3 px-6 rounded-lg">Cancel</button>';
            }

            modal.classList.remove('hidden');
        }

        function closeMobileJobModal() {
            document.getElementById('mobileJobModal').classList.add('hidden');
            selectedMobileJob = null;
        }

        function editJobFromMobile() {
            if (selectedMobileJob) {
                const jobToEdit = selectedMobileJob;
                closeMobileJobModal();
                // Add small delay to ensure modal closes before opening edit modal
                setTimeout(() => {
                    openEditModal(jobToEdit);
                }, 100);
            } else {
                console.error('No job selected for editing');
                alert('No job selected for editing');
            }
        }

        function duplicateJobFromMobile() {
            if (selectedMobileJob) {
                const jobId = selectedMobileJob.id;
                closeMobileJobModal();
                duplicateJob(jobId);
            }
        }

        function openEditModal(job) {
            if (!job) {
                console.error('No job provided to openEditModal');
                alert('Error: Could not load job data');
                return;
            }

            if (!staff || staff.length === 0) {
                console.error('Staff array is empty');
                alert('Error: Staff data not loaded. Please refresh the page.');
                return;
            }

            // Show modal first
            document.getElementById('editJobModal').classList.remove('hidden');

            // Update modal title
            const modalTitle = document.querySelector('#editJobModal h2');
            if (job.id === 'DUPLICATE') {
                modalTitle.textContent = 'Duplicate Job';
            } else {
                modalTitle.textContent = 'Edit Job';
            }

            // Set basic fields
            document.getElementById('edit_job_id').value = job.id || '';
            document.getElementById('edit_date').value = job.date || '';

            // Set time dropdowns
            const startTimeSelect = document.getElementById('edit_start_time');
            const endTimeSelect = document.getElementById('edit_end_time');

            if (startTimeSelect && endTimeSelect) {
                startTimeSelect.innerHTML = '<option value="">Select...</option>' + generateTimeOptions(job.start_time);
                endTimeSelect.innerHTML = '<option value="">Select...</option>' + generateTimeOptions(job.end_time);
                
                // Update end time options based on start time and show duration
                updateEndTimeOptions('edit');
                updateDurationDisplay('edit');
            }

            // Set other fields
            document.getElementById('edit_status').value = job.status || 'Unassigned';
            document.getElementById('edit_client_name').value = job.client_name || '';
            document.getElementById('edit_client_phone').value = job.client_phone || '';
            document.getElementById('edit_client_email').value = job.client_email || '';
            document.getElementById('edit_contact_method').value = job.contact_method || '';
            document.getElementById('edit_address').value = job.address || '';
            document.getElementById('edit_suburb').value = job.suburb || '';
            document.getElementById('edit_job_description').value = job.job_description || '';
            document.getElementById('edit_price').value = job.price || '';

            // Set GST radio buttons
            const gstRadios = document.getElementsByName('edit_price_includes_gst');
            if (gstRadios && gstRadios.length > 0) {
                gstRadios.forEach(radio => {
                    radio.checked = (radio.value === String(job.price_includes_gst));
                });
            }

            document.getElementById('edit_priority').value = job.priority || 'Normal';
            document.getElementById('edit_amount_paid').value = job.amount_paid || '';
            document.getElementById('edit_payment_method').value = job.payment_method || '';

            // Display existing photos
            const photoPreview = document.getElementById('photoPreview');
            if (job.photo_urls && job.photo_urls.length > 0) {
                photoPreview.innerHTML = job.photo_urls.map((url, index) => `
                    <div class="relative group">
                        <img src="${url}" alt="Job Photo ${index + 1}" class="w-full h-24 object-cover rounded border border-gray-300">
                        <button type="button" onclick="removePhotoFromEdit(${index})" 
                            class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            Ã—
                        </button>
                    </div>
                `).join('');
            } else {
                photoPreview.innerHTML = '<p class="text-sm text-gray-500">No photos uploaded</p>';
            }

            document.getElementById('edit_notes').value = job.notes || '';

            // Set assigned to dropdown
            const assignedToSelect = document.getElementById('edit_assigned_to');
            if (assignedToSelect) {
                const staffOptions = staff.map(s =>
                    '<option value="' + s.id + '"' + (job.assigned_to === s.id ? ' selected' : '') + '>' +
                    s.full_name + '</option>'
                ).join('');
                assignedToSelect.innerHTML = '<option value="">Unassigned</option>' + staffOptions;
            }
        }

        function closeEditModal() {
            document.getElementById('editJobModal').classList.add('hidden');
        }

        async function handleEditSubmit(e) {
            e.preventDefault();
            const jobId = document.getElementById('edit_job_id').value;

            const job = jobs.find(j => j.id === jobId);
            const isDuplicate = jobId === 'DUPLICATE';
            const jobData = {
                date: document.getElementById('edit_date').value,
                start_time: document.getElementById('edit_start_time').value,
                end_time: document.getElementById('edit_end_time').value,
                status: document.getElementById('edit_status').value,
                client_name: document.getElementById('edit_client_name').value,
                client_phone: document.getElementById('edit_client_phone').value,
                client_email: document.getElementById('edit_client_email').value || null,
                address: document.getElementById('edit_address').value,
                suburb: document.getElementById('edit_suburb').value,
                job_description: document.getElementById('edit_job_description').value,
                price: parseFloat(document.getElementById('edit_price').value),
                price_includes_gst: document.querySelector('input[name="edit_price_includes_gst"]:checked').value === 'true',
                priority: document.getElementById('edit_priority').value,
                assigned_to: document.getElementById('edit_assigned_to').value || null,
                amount_paid: document.getElementById('edit_amount_paid').value ? parseFloat(document.getElementById('edit_amount_paid').value) : null,
                payment_method: document.getElementById('edit_payment_method').value || null,
                photo_urls: job ? job.photo_urls : null,
                notes: document.getElementById('edit_notes').value || null,
                contact_method: document.getElementById('edit_contact_method').value || null
            };
            if (jobData.end_time <= jobData.start_time) {alert('End time must be after start time.'); return;}

            // Check for conflicts if staff is assigned
            if (jobData.assigned_to) {
                const conflicts = checkTimeSlotConflict(jobData.assigned_to, jobData.date, jobData.start_time, jobData.end_time, jobId);
                if (conflicts) {
                    const staffMember = staff.find(s => s.id === jobData.assigned_to);
                    const conflictJob = conflicts[0];
                    alert('âŒ TIME SLOT CONFLICT!\n\n' +
                        'Staff: ' + (staffMember ? staffMember.full_name : 'Unknown') + '\n' +
                        'Date: ' + new Date(jobData.date).toLocaleDateString() + '\n' +
                        'Your time: ' + formatTime12Hour(jobData.start_time) + ' - ' + formatTime12Hour(jobData.end_time) + '\n\n' +
                        'CONFLICTS WITH:\n' +
                        'Client: ' + conflictJob.client_name + '\n' +
                        'Time: ' + formatTime12Hour(conflictJob.start_time) + ' - ' + formatTime12Hour(conflictJob.end_time) + '\n' +
                        'Status: ' + conflictJob.status + '\n\n' +
                        'Please choose a different time or staff member.');
                    return;
                }
            }

            // Intercept status change to "Completed" in edit modal
            if (jobData.status === 'Completed' && (!job || job.status !== 'Completed')) {
                closeEditModal();
                openManagerPaymentModal(jobId);
                return;
            }

            try {
                if (isDuplicate) {
                    // Create new job
                    const {error} = await supabaseClient.from('jobs').insert([jobData]).select();
                    if (error) throw error;
                    alert('Job duplicated and created successfully!');
                    closeEditModal();
                    await loadJobs();
                    currentView = 'all-jobs';
                    renderApp();
                } else {
                    // Update existing job

                    // If changing FROM "Completed" to another status, reset review fields
                    if (job && job.status === 'Completed' && jobData.status !== 'Completed') {
                        jobData.request_review = false;
                        jobData.review_sent = false;
                        jobData.review_received = false;
                        jobData.review_rating = null;
                        jobData.review_received_date = null;
                        jobData.amount_paid = null;
                        jobData.payment_method = null;
                    }

                    const {error} = await supabaseClient.from('jobs').update(jobData).eq('id', jobId);
                    if (error) throw error;
                    alert('Job updated successfully!');
                    closeEditModal();
                    await loadJobs();
                    renderApp();
                }
            } catch (error) {
                console.error('Error saving job:', error);
                alert('Failed to save job: ' + error.message);
            }
        }

        function generateTimeOptions(selectedTime) {
            const times = [];
            for (let hour = 0; hour < 24; hour++) {
                // Skip hours between 10pm (22:00) and 5am (05:00)
                if (hour >= 22 || hour < 5) {
                    continue;
                }

                // 15-minute increments for 7am-10am (hours 7, 8, 9)
                if (hour >= 7 && hour < 10) {
                    for (let min = 0; min < 60; min += 15) {
                        const timeStr = String(hour).padStart(2, '0') + ':' + String(min).padStart(2, '0') + ':00';
                        const displayTime = formatTime12Hour(timeStr);
                        times.push('<option value="' + timeStr + '"' + (selectedTime === timeStr ? ' selected' : '') + '>' + displayTime + '</option>');
                    }
                } else {
                    // 15-minute increments for all other hours
                    for (let min = 0; min < 60; min += 15) {
                        const timeStr = String(hour).padStart(2, '0') + ':' + String(min).padStart(2, '0') + ':00';
                        const displayTime = formatTime12Hour(timeStr);
                        times.push('<option value="' + timeStr + '"' + (selectedTime === timeStr ? ' selected' : '') + '>' + displayTime + '</option>');
                    }
                }
            }
            return times.join('');
        }

        function generateValidEndTimes(startTime) {
            if (!startTime) return generateTimeOptions();
            
            const [startHour, startMinute] = startTime.split(':').map(Number);
            const startTotalMinutes = startHour * 60 + startMinute;
            
            let options = '<option value="">Select End Time</option>';
            
            // Generate ALL 15-minute intervals from 5 AM to 9:45 PM
            for (let hour = 5; hour < 22; hour++) {
                for (let minute = 0; minute < 60; minute += 15) {
                    // Skip times after 9:30 PM (last slot should be 9:30 PM)
                    if (hour === 21 && minute > 30) continue;
                    
                    const endTotalMinutes = hour * 60 + minute;
                    const duration = endTotalMinutes - startTotalMinutes;
                    
                    // Only show times that are at least 45 minutes after start time
                    if (duration >= 45) {
                        const period = hour >= 12 ? 'PM' : 'AM';
                        const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
                        const displayMinute = minute.toString().padStart(2, '0');
                        const timeValue = `${hour.toString().padStart(2, '0')}:${displayMinute}:00`;
                        
                        const durationHours = Math.floor(duration / 60);
                        const durationMinutes = duration % 60;
                        let durationText = '';
                        if (durationHours > 0) {
                            durationText = `${durationHours}h ${durationMinutes}m`;
                        } else {
                            durationText = `${durationMinutes}m`;
                        }
                        
                        options += `<option value="${timeValue}">${displayHour}:${displayMinute} ${period} (${durationText})</option>`;
                    }
                }
            }
            
            return options;
        }

        function calculateDuration(startTime, endTime) {
            if (!startTime || !endTime) return '';
            
            const [startHour, startMinute] = startTime.split(':').map(Number);
            const [endHour, endMinute] = endTime.split(':').map(Number);
            
            const startTotalMinutes = startHour * 60 + startMinute;
            const endTotalMinutes = endHour * 60 + endMinute;
            const duration = endTotalMinutes - startTotalMinutes;
            
            if (duration <= 0) return '';
            
            const hours = Math.floor(duration / 60);
            const minutes = duration % 60;
            
            let durationText = '';
            if (hours > 0 && minutes > 0) {
                durationText = `${hours} hour${hours > 1 ? 's' : ''} ${minutes} minutes`;
            } else if (hours > 0) {
                durationText = `${hours} hour${hours > 1 ? 's' : ''}`;
            } else {
                durationText = `${minutes} minutes`;
            }
            
            return durationText;
        }

        function updateEndTimeOptions(prefix) {
            const startTimeSelect = document.getElementById(prefix + 'StartTime');
            const endTimeSelect = document.getElementById(prefix + 'EndTime');
            
            if (!startTimeSelect || !endTimeSelect) return;
            
            const startTime = startTimeSelect.value;
            endTimeSelect.innerHTML = generateValidEndTimes(startTime);
            
            // Reset duration display
            updateDurationDisplay(prefix);
        }

        function updateDurationDisplay(prefix) {
            const startTimeElement = document.getElementById(prefix + 'StartTime');
            const endTimeElement = document.getElementById(prefix + 'EndTime');
            const durationDisplay = document.getElementById(prefix + 'DurationDisplay');
            const durationText = document.getElementById(prefix + 'DurationText');
            
            if (!startTimeElement || !endTimeElement || !durationDisplay || !durationText) return;
            
            const startTime = startTimeElement.value;
            const endTime = endTimeElement.value;
            
            if (startTime && endTime) {
                const duration = calculateDuration(startTime, endTime);
                if (duration) {
                    durationText.textContent = duration;
                    durationDisplay.classList.remove('hidden');
                } else {
                    durationDisplay.classList.add('hidden');
                }
            } else {
                durationDisplay.classList.add('hidden');
            }
        }

        async function createJob(jobData) {
            try {
                const {data, error} = await supabaseClient.from('jobs').insert([jobData]).select();
                if (error) throw error;
                alert('Job created successfully!');
                await loadJobs();
                currentView = 'dashboard';
                renderApp();
                return true;
            } catch (error) {
                console.error('Error creating job:', error);
                alert('Failed to create job: ' + error.message);
                return false;
            }
        }

        async function deleteJob(jobId) {
            if (!confirm('Are you sure you want to delete this job?')) return;
            try {
                const {error} = await supabaseClient.from('jobs').delete().eq('id', jobId);
                if (error) throw error;
                alert('Job deleted successfully!');
                await loadJobs();
                renderApp();
            } catch (error) {
                console.error('Error deleting job:', error);
                alert('Failed to delete job: ' + error.message);
            }
        }

        async function markReviewSent(jobId) {
            if (!confirm('Mark this review request as sent?')) return;

            try {
                const {error} = await supabaseClient
                    .from('jobs')
                    .update({review_sent: true})
                    .eq('id', jobId);

                if (error) throw error;

                await loadJobs();
                renderApp();
            } catch (error) {
                console.error('Error marking review as sent:', error);
                alert('Failed to update: ' + error.message);
            }
        }

        async function markReviewReceived(jobId) {
            if (!confirm('Mark this review as received?')) return;

            try {
                const {error} = await supabaseClient
                    .from('jobs')
                    .update({
                        review_received: true,
                        review_received_date: new Date().toISOString()
                    })
                    .eq('id', jobId);

                if (error) throw error;

                await loadJobs();
                renderApp();
            } catch (error) {
                console.error('Error marking review as received:', error);
                alert('Failed to update: ' + error.message);
            }
        }

        function openRatingModal(jobId) {
            pendingRatingJobId = jobId;
            selectedRatingValue = 0;
            // Reset all stars
            for (let i = 1; i <= 5; i++) {
                document.getElementById('star-' + i).classList.remove('text-yellow-400');
                document.getElementById('star-' + i).classList.add('text-gray-300');
            }
            document.getElementById('rating-text').textContent = 'Select a rating';
            document.getElementById('ratingModal').classList.remove('hidden');
        }

        function closeRatingModal() {
            document.getElementById('ratingModal').classList.add('hidden');
            pendingRatingJobId = null;
            selectedRatingValue = 0;
        }

        function selectRating(rating) {
            selectedRatingValue = rating;

            // Update star display
            for (let i = 1; i <= 5; i++) {
                const star = document.getElementById('star-' + i);
                if (i <= rating) {
                    star.classList.remove('text-gray-300');
                    star.classList.add('text-yellow-400');
                } else {
                    star.classList.remove('text-yellow-400');
                    star.classList.add('text-gray-300');
                }
            }

            // Update text
            const ratingText = ['', 'Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
            document.getElementById('rating-text').textContent = ratingText[rating] + ' (' + rating + ' stars)';
        }

        async function submitRating() {
            if (selectedRatingValue === 0) {
                alert('Please select a rating');
                return;
            }

            if (!pendingRatingJobId) {
                alert('Error: No job selected. Please refresh and try again.');
                closeRatingModal();
                return;
            }

            try {
                const {error} = await supabaseClient
                    .from('jobs')
                    .update({review_rating: selectedRatingValue})
                    .eq('id', pendingRatingJobId);

                if (error) throw error;

                closeRatingModal();
                await loadJobs();
                renderApp();
            } catch (error) {
                console.error('Error saving rating:', error);
                alert('Failed to save rating: ' + error.message);
            }
        }

        function duplicateJob(jobId) {
            const job = jobs.find(j => j.id === jobId);
            if (!job) {
                alert('Job not found');
                return;
            }

            // Create a duplicate job object with reset fields
            const duplicateJobData = {
                id: 'DUPLICATE', // Special ID to indicate this is a new job being created
                date: job.date,
                start_time: job.start_time,
                end_time: job.end_time,
                client_name: job.client_name,
                client_phone: job.client_phone,
                client_email: job.client_email,
                address: job.address,
                suburb: job.suburb,
                job_description: job.job_description,
                price: job.price,
                price_includes_gst: job.price_includes_gst,
                priority: job.priority,
                assigned_to: job.assigned_to,
                status: 'Unassigned',
                amount_paid: null,
                payment_method: null,
                photo_urls: job.photo_urls ? job.photo_urls : null,
                notes: job.notes || null
            };

            // Open edit modal with duplicate data
            openEditModal(duplicateJobData);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Photo Gallery Functions
        let currentPhotoGallery = [];
        let currentPhotoIndex = 0;

        function openPhotoGallery(photoUrls, startIndex = 0) {
            if (!photoUrls || photoUrls.length === 0) return;

            currentPhotoGallery = photoUrls;
            currentPhotoIndex = startIndex;

            updateGalleryImage();
            document.getElementById('photoGalleryModal').classList.remove('hidden');

            // Keyboard navigation
            document.addEventListener('keydown', handleGalleryKeyboard);
        }

        function closePhotoGallery() {
            document.getElementById('photoGalleryModal').classList.add('hidden');
            document.removeEventListener('keydown', handleGalleryKeyboard);
        }

        function nextPhoto() {
            if (currentPhotoIndex < currentPhotoGallery.length - 1) {
                currentPhotoIndex++;
                updateGalleryImage();
            }
        }

        function previousPhoto() {
            if (currentPhotoIndex > 0) {
                currentPhotoIndex--;
                updateGalleryImage();
            }
        }

        function updateGalleryImage() {
            const img = document.getElementById('galleryImage');
            const counter = document.getElementById('galleryCounter');

            img.src = currentPhotoGallery[currentPhotoIndex];
            counter.textContent = (currentPhotoIndex + 1) + ' / ' + currentPhotoGallery.length;
        }

        function handleGalleryKeyboard(e) {
            if (e.key === 'ArrowLeft') {
                previousPhoto();
            } else if (e.key === 'ArrowRight') {
                nextPhoto();
            } else if (e.key === 'Escape') {
                closePhotoGallery();
            }
        }

        function getStatusClass(status) {
            if (status === 'Completed') return 'bg-green-100 text-green-800';
            if (status === 'In Progress') return 'bg-blue-100 text-blue-800';
            if (status === 'Assigned') return 'bg-purple-100 text-purple-800';
            if (status === 'Assigned/Fix') return 'bg-indigo-100 text-indigo-800';
            if (status === 'Reschedule') return 'bg-orange-100 text-orange-800';
            if (status === 'Cancelled') return 'bg-red-100 text-red-800';
            return 'bg-gray-100 text-gray-800';
        }

        function renderApp() {
            const app = document.getElementById('app');
            if (!currentUser) {
                app.innerHTML = renderLogin();
                return;
            }
            app.innerHTML = renderHeader() + '<div class="max-w-full mx-auto px-4 py-6">' + renderContent() + '</div>';
        }

        function renderLogin() {
            return '<div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-purple-600"><div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md"><h1 class="text-3xl font-bold text-gray-900 mb-6 text-center">Manager Login</h1><form onsubmit="handleLogin(event)" class="space-y-4"><div><label class="block text-sm font-medium text-gray-700 mb-2">Username</label><input type="text" id="username" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Password</label><input type="password" id="password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></div><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg">Login</button></form></div></div>';
        }

        function renderHeader() {
            const views = [
                {key: 'dashboard', label: 'Dashboard'},
                {key: 'create-job', label: 'Create'},
                {key: 'all-jobs', label: 'Active'},
                {key: 'completed-jobs', label: 'Completed'},
                {key: 'archived-jobs', label: 'Archived'},
                {key: 'review-requests', label: 'Reviews'},
                {key: 'staff-management', label: 'Staff'},
                {key: 'staff-schedule', label: 'Schedule'}
            ];
            const navButtons = views.map(v => '<button onclick="changeView(\'' + v.key + '\')" class="px-4 py-2 rounded-lg text-sm font-medium transition-colors ' + (currentView === v.key ? 'bg-blue-50 text-blue-700' : 'text-gray-600 hover:bg-gray-50') + '">' + v.label + '</button>').join('');
            return '<nav class="bg-white border-b border-gray-200 sticky top-0 z-30"><div class="max-w-full mx-auto px-4"><div class="flex justify-between items-center h-16"><div class="flex items-center space-x-4"><button onclick="toggleMobileMenu()" class="md:hidden text-gray-600 hover:text-gray-900"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button><div class="flex items-center gap-3 cursor-pointer" onclick="changeView(\'dashboard\')"><img src="https://scratchvanish.com.au/wp-content/uploads/2021/11/logo.png" alt="Company Logo" class="h-8 w-auto"><h1 class="text-xl font-semibold text-gray-900 hover:text-blue-600 transition-colors">Job Management</h1></div><div class="hidden md:flex space-x-1">' + navButtons + '</div></div><div class="flex items-center space-x-4"><span class="text-sm text-gray-600 hidden sm:inline">Hi, ' + escapeHtml(currentUser.full_name) + '</span><button onclick="logout()" class="text-sm text-red-600 hover:text-red-700 font-medium">Logout</button></div></div></div></nav>';
        }

        function renderContent() {
            if (currentView === 'dashboard') return renderDashboard();
            if (currentView === 'create-job') return renderJobForm();
            if (currentView === 'all-jobs') return renderJobsList(false);
            if (currentView === 'completed-jobs') return renderJobsList(true);
            if (currentView === 'archived-jobs') return renderJobsList('archived');
            if (currentView === 'staff-management') return renderStaffManagement();
            if (currentView === 'review-requests') return renderReviewRequests();
            if (currentView === 'staff-schedule') return renderStaffSchedule();
            return renderDashboard();
        }

        function getDateRangeForPeriod(period) {
            const today = new Date();
            today.setHours(23, 59, 59, 999); // End of today
            let startDate = new Date();

            switch (period) {
                case 'this_week':
                    // Get Monday of current week
                    const dayOfWeek = today.getDay();
                    const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Sunday is 0, Monday is 1
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - daysFromMonday);
                    startDate.setHours(0, 0, 0, 0);
                    break;
                case 'last_week':
                    // Get Monday of last week
                    const lastWeekMonday = new Date(today);
                    const currentDayOfWeek = today.getDay();
                    const daysToLastMonday = currentDayOfWeek === 0 ? 13 : currentDayOfWeek + 6; // If Sunday, go back 13 days, else go back to last Monday
                    lastWeekMonday.setDate(today.getDate() - daysToLastMonday);
                    lastWeekMonday.setHours(0, 0, 0, 0);

                    // Get Sunday of last week
                    const lastWeekSunday = new Date(lastWeekMonday);
                    lastWeekSunday.setDate(lastWeekMonday.getDate() + 6);
                    lastWeekSunday.setHours(23, 59, 59, 999);

                    return {startDate: lastWeekMonday, endDate: lastWeekSunday};
                case 'this_month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    startDate.setHours(0, 0, 0, 0);
                    break;
                case 'last_month':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    startDate.setHours(0, 0, 0, 0);
                    let lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
                    lastMonthEnd.setHours(23, 59, 59, 999);
                    return {startDate, endDate: lastMonthEnd};
                case 'last_3_months':
                    startDate = new Date(today);
                    startDate.setMonth(today.getMonth() - 3);
                    startDate.setHours(0, 0, 0, 0);
                    break;
                case 'last_6_months':
                    startDate = new Date(today);
                    startDate.setMonth(today.getMonth() - 6);
                    startDate.setHours(0, 0, 0, 0);
                    break;
                case 'this_year':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    startDate.setHours(0, 0, 0, 0);
                    break;
                case 'all_time':
                    startDate = new Date('2000-01-01');
                    startDate.setHours(0, 0, 0, 0);
                    break;
                default:
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    startDate.setHours(0, 0, 0, 0);
            }

            return {startDate, endDate: today};
        }
        function getStaffReviewStats(timePeriod) {
            const {startDate, endDate} = getDateRangeForPeriod(timePeriod);

            const staffStats = staff.map(s => {
                const staffReviews = jobs.filter(j => {
                    if (j.assigned_to !== s.id || !j.review_received) return false;

                    const reviewDate = new Date(j.review_received_date);
                    return reviewDate >= startDate && reviewDate <= endDate;
                });

                const avgRating = staffReviews.length > 0
                    ? (staffReviews.reduce((sum, j) => sum + (j.review_rating || 0), 0) / staffReviews.length).toFixed(1)
                    : 0;

                return {
                    name: s.full_name,
                    color: s.color_code,
                    reviewCount: staffReviews.length,
                    avgRating: avgRating,
                    ratings: staffReviews.filter(j => j.review_rating).length
                };
            }).sort((a, b) => b.reviewCount - a.reviewCount);

            return staffStats;
        }
        function getCompletedJobsForPeriod(period) {
            const {startDate, endDate} = getDateRangeForPeriod(period);

            return jobs.filter(j => {
                if (j.status !== 'Completed' || !j.amount_paid) return false;

                const jobDate = j.actual_end_time ? new Date(j.actual_end_time) : new Date(j.date);
                return jobDate >= startDate && jobDate <= endDate;
            });
        }

        function analyzeSuburbProfitability(completedJobs) {
            const suburbData = {};

            completedJobs.forEach(job => {
                const suburb = job.suburb || 'Unknown';
                if (!suburbData[suburb]) {
                    suburbData[suburb] = {
                        suburb: suburb,
                        totalRevenue: 0,
                        jobCount: 0
                    };
                }

                suburbData[suburb].totalRevenue += parseFloat(job.amount_paid) || 0;
                suburbData[suburb].jobCount += 1;
            });

            // Convert to array and calculate averages
            const suburbArray = Object.values(suburbData).map(s => ({
                ...s,
                avgRevenue: s.totalRevenue / s.jobCount
            }));

            // Sort by total revenue descending
            return suburbArray.sort((a, b) => b.totalRevenue - a.totalRevenue);
        }

        function analyzeStaffProfitability(completedJobs) {
            const staffData = {};

            completedJobs.forEach(job => {
                if (!job.assigned_to) return;

                if (!staffData[job.assigned_to]) {
                    const staffMember = staff.find(s => s.id === job.assigned_to);
                    staffData[job.assigned_to] = {
                        staffId: job.assigned_to,
                        staffName: staffMember ? staffMember.full_name : 'Unknown',
                        staffColor: staffMember ? staffMember.color_code : '#666',
                        totalRevenue: 0,
                        jobCount: 0
                    };
                }

                staffData[job.assigned_to].totalRevenue += parseFloat(job.amount_paid) || 0;
                staffData[job.assigned_to].jobCount += 1;
            });

            // Convert to array and calculate averages
            const staffArray = Object.values(staffData).map(s => ({
                ...s,
                avgRevenue: s.totalRevenue / s.jobCount
            }));

            // Sort by total revenue descending
            return staffArray.sort((a, b) => b.totalRevenue - a.totalRevenue);
        }


        function renderDashboard() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Active Jobs: All jobs that are NOT Completed AND NOT Cancelled
            const activeJobs = jobs.filter(j => {
                return j.status !== 'Completed' && j.status !== 'Cancelled';
            }).length;

            // DEBUG: To verify the count
            console.log('Active jobs (excluding Completed & Cancelled):', activeJobs);
            console.log('All jobs count:', jobs.length);

            const unassigned = jobs.filter(j => {
                const jobDate = new Date(j.date);
                jobDate.setHours(0, 0, 0, 0);
                return j.status === 'Unassigned' && jobDate.getTime() === today.getTime();
            }).length;

            const assigned = jobs.filter(j => {
                const jobDate = new Date(j.date);
                jobDate.setHours(0, 0, 0, 0);
                return j.status === 'Assigned' && jobDate.getTime() === today.getTime();
            }).length;

            const completedToday = jobs.filter(j => {
                if (j.status !== 'Completed') return false;
                const dateToCheck = j.actual_end_time ? new Date(j.actual_end_time) : new Date(j.date);
                return dateToCheck.toDateString() === new Date().toDateString();
            }).length;

            const todayRevenue = jobs.filter(j => {
                if (j.status !== 'Completed' || !j.amount_paid) return false;
                const dateToCheck = j.actual_end_time ? new Date(j.actual_end_time) : new Date(j.date);
                return dateToCheck.toDateString() === new Date().toDateString();
            }).reduce((sum, j) => sum + Number(j.amount_paid), 0);

            // ... rest of your dashboard code

            let cashTotal = 0;
            let bankTotal = 0;

            jobs.forEach(j => {
                if (j.status !== 'Completed' || !j.amount_paid) return;

                const dateToCheck = j.actual_end_time ? new Date(j.actual_end_time) : new Date(j.date);
                if (dateToCheck.toDateString() !== new Date().toDateString()) return;

                if (j.payment_method === 'Cash') {
                    cashTotal += Number(j.amount_paid);
                } else if (j.payment_method === 'Bank Transfer/Card') {
                    bankTotal += Number(j.amount_paid);
                } else if (j.payment_method === 'Split') {
                    cashTotal += Number(j.cash_amount || 0);
                    bankTotal += Number(j.bank_amount || 0);
                }
            });
            const workload = staff.map(s => ({
                id: s.id,
                name: s.full_name,
                color: s.color_code,
                count: jobs.filter(j => j.assigned_to === s.id && j.status !== 'Completed' && j.status !== 'Cancelled').length
            }));
            const workloadCards = workload.map(w => '<div onclick="filterByStaff(\'' + w.id + '\')" class="bg-white border border-gray-200 rounded-xl p-4 hover:shadow-md transition-all cursor-pointer transform hover:scale-105" style="border-left: 3px solid ' + w.color + '"><div class="text-sm font-medium text-gray-600 mb-1">' + w.name + '</div><div class="text-2xl font-semibold mt-2" style="color: ' + w.color + '">' + w.count + '</div></div>').join('');

            let html = '<div class="space-y-6">';
            html += '<h2 class="text-2xl font-semibold text-gray-900">Dashboard</h2>';
            html += '<div class="grid grid-cols-2 md:grid-cols-5 gap-4">';
            html += '<div onclick="changeView(\'all-jobs\')" class="bg-white rounded-xl border border-gray-200 p-5 hover:shadow-md transition-all cursor-pointer transform hover:scale-105"><div class="text-xs font-medium text-gray-500 uppercase tracking-wide">Active Jobs</div><div class="text-3xl font-semibold text-blue-600 mt-2">' + activeJobs + '</div></div>';
            html += '<div onclick="filterTodayUnassigned()" class="bg-white rounded-xl border border-gray-200 p-5 hover:shadow-md transition-all cursor-pointer transform hover:scale-105"><div class="text-xs font-medium text-gray-500 uppercase tracking-wide">Today\'s Unassigned</div><div class="text-3xl font-semibold text-yellow-600 mt-2">' + unassigned + '</div></div>';
            html += '<div onclick="filterTodayAssigned()" class="bg-white rounded-xl border border-gray-200 p-5 hover:shadow-md transition-all cursor-pointer transform hover:scale-105"><div class="text-xs font-medium text-gray-500 uppercase tracking-wide">Today\'s Assigned</div><div class="text-3xl font-semibold text-purple-600 mt-2">' + assigned + '</div></div>';
            html += '<div onclick="filterCompletedToday()" class="bg-white rounded-xl border border-gray-200 p-5 hover:shadow-md transition-all cursor-pointer transform hover:scale-105"><div class="text-xs font-medium text-gray-500 uppercase tracking-wide">Done Today</div><div class="text-3xl font-semibold text-green-600 mt-2">' + completedToday + '</div></div>';
            const reviewRequestsCount = jobs.filter(j => j.status === 'Completed' && j.request_review === true && j.review_sent !== true).length;
            html += '<div onclick="changeView(\'review-requests\')" class="bg-gradient-to-br from-yellow-400 to-yellow-500 rounded-xl border border-yellow-600 p-5 hover:shadow-md transition-all cursor-pointer transform hover:scale-105"><div class="text-xs font-medium text-yellow-900 uppercase tracking-wide">Review Requests</div><div class="text-3xl font-semibold text-white mt-2">' + reviewRequestsCount + '</div></div>';
            html += '<div onclick="changeView(\'create-job\')" class="bg-blue-600 rounded-xl border border-blue-700 p-5 hover:shadow-md transition-all cursor-pointer transform hover:scale-105"><div class="text-xs font-medium text-blue-100 uppercase tracking-wide">Quick Action</div><div class="text-2xl font-semibold text-white mt-2 flex items-center gap-2"><span class="material-icons">add_circle</span>Create Job</div></div>';
            html += '</div>';
            html += '<div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl p-6 text-white">';
            html += '<h3 class="text-sm font-medium mb-3 opacity-90">Today\'s Revenue</h3>';
            html += '<div class="text-4xl font-semibold mb-4">$' + todayRevenue.toFixed(2) + '</div>';
            html += '<div class="flex space-x-6 text-sm">';
            html += '<div><div class="opacity-80 mb-1">Cash</div><div class="text-xl font-medium">$' + cashTotal.toFixed(2) + '</div></div>';
            html += '<div><div class="opacity-80 mb-1">Bank</div><div class="text-xl font-medium">$' + bankTotal.toFixed(2) + '</div></div>';
            html += '</div></div>';
            // Review Stats Summary
            const totalReviewRequests = jobs.filter(j => j.request_review === true && j.status === 'Completed').length;
            const totalReviewsSent = jobs.filter(j => j.review_sent === true).length;
            const totalReviewsReceived = jobs.filter(j => j.review_received === true).length;
            const conversionRate = totalReviewsSent > 0 ? ((totalReviewsReceived / totalReviewsSent) * 100).toFixed(1) : 0;

            // Calculate overall average rating
            const allRatedReviews = jobs.filter(j => j.review_received === true && j.review_rating);
            const overallAvgRating = allRatedReviews.length > 0
                ? (allRatedReviews.reduce((sum, j) => sum + j.review_rating, 0) / allRatedReviews.length).toFixed(1)
                : 0;

            html += '<div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-6 text-white">';
            html += '<h3 class="text-sm font-medium mb-3 opacity-90">Review Statistics</h3>';
            html += '<div class="flex items-center gap-3 mb-4">';
            html += '<div class="text-4xl font-semibold">' + totalReviewsReceived + '</div>';
            if (overallAvgRating > 0) {
                html += '<div class="text-3xl text-yellow-300">' + 'â˜…'.repeat(Math.round(overallAvgRating)) + '</div>';
                html += '<div class="text-xl font-medium opacity-90">' + overallAvgRating + '/5</div>';
            }
            html += '</div>';
            html += '<div class="flex space-x-6 text-sm">';
            html += '<div><div class="opacity-80 mb-1">Sent</div><div class="text-xl font-medium">' + totalReviewsSent + '</div></div>';
            html += '<div><div class="opacity-80 mb-1">Rate</div><div class="text-xl font-medium">' + conversionRate + '%</div></div>';
            html += '<div><div class="opacity-80 mb-1">Rated</div><div class="text-xl font-medium">' + allRatedReviews.length + '</div></div>';
            html += '</div></div>';
            html += '<div class="bg-white rounded-xl border border-gray-200 p-6">';
            html += '<h3 class="text-lg font-semibold text-gray-900 mb-4">Staff Workload</h3>';
            html += '<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">' + workloadCards + '</div>';
            html += '</div>';

            // Staff Review Performance
            const reviewStats = staff.map(s => {
                const staffReviews = jobs.filter(j =>
                    j.assigned_to === s.id &&
                    j.review_received === true
                );

                // Calculate average rating
                const ratedReviews = staffReviews.filter(j => j.review_rating);
                const avgRating = ratedReviews.length > 0
                    ? (ratedReviews.reduce((sum, j) => sum + j.review_rating, 0) / ratedReviews.length).toFixed(1)
                    : 0;

                return {
                    id: s.id,
                    name: s.full_name,
                    color: s.color_code,
                    reviewCount: staffReviews.length,
                    ratedCount: ratedReviews.length,
                    avgRating: avgRating
                };
            }).sort((a, b) => b.reviewCount - a.reviewCount); // Sort by most reviews

            const reviewStatsCards = reviewStats.map(s => {
                // Create visual star rating
                let starsHtml = '';
                if (s.avgRating > 0) {
                    for (let i = 1; i <= 5; i++) {
                        if (i <= Math.round(s.avgRating)) {
                            starsHtml += '<span class="text-yellow-500">â˜…</span>';
                        } else {
                            starsHtml += '<span class="text-gray-300">â˜…</span>';
                        }
                    }
                }

                return '<div onclick="dashboardReviewStaff = \'' + s.id + '\'; window.scrollTo(0, document.body.scrollHeight);" class="bg-white border border-gray-200 rounded-xl p-4 hover:shadow-md transition-all cursor-pointer transform hover:scale-105" style="border-left: 3px solid ' + s.color + '">' +
                    '<div class="text-sm font-medium text-gray-600 mb-1">' + s.name + '</div>' +
                    '<div class="flex items-center justify-between">' +
                    '<div class="flex items-center gap-2">' +
                    '<span class="text-2xl font-semibold" style="color: ' + s.color + '">' + s.reviewCount + '</span>' +
                    '<span class="text-xs text-gray-500">reviews</span>' +
                    '</div>' +
                    (s.avgRating > 0 ?
                        '<div class="text-right">' +
                        '<div class="flex gap-0.5">' + starsHtml + '</div>' +
                        '<div class="text-xs text-gray-500 mt-1">' + s.avgRating + '/5 (' + s.ratedCount + ')</div>' +
                        '</div>'
                        : '<div class="text-xs text-gray-400">No ratings</div>') +
                    '</div>' +
                    '</div>';
            }).join('');

            html += '<div class="bg-white rounded-xl border border-gray-200 p-6">';
            html += '<div class="flex justify-between items-center mb-4">';
            html += '<h3 class="text-lg font-semibold text-gray-900">Staff Review Performance</h3>';
            html += '<button onclick="changeView(\'review-requests\'); currentReviewTab = \'received\';" class="text-sm text-blue-600 hover:text-blue-800 font-medium">View All â†’</button>';
            html += '</div>';
            html += '<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">' + reviewStatsCards + '</div>';
            html += '</div>';

            // Profitability Analysis Section
            const completedJobs = getCompletedJobsForPeriod(dashboardTimePeriod);
            const suburbAnalysis = analyzeSuburbProfitability(completedJobs);
            const staffAnalysis = analyzeStaffProfitability(completedJobs);

            const totalRevenue = completedJobs.reduce((sum, j) => sum + (parseFloat(j.amount_paid) || 0), 0);
            const totalJobs = completedJobs.length;
            const avgRevenuePerJob = totalJobs > 0 ? totalRevenue / totalJobs : 0;

            html += '<div class="bg-white rounded-xl border border-gray-200 p-6 mt-6">';
            html += '<div class="flex justify-between items-center mb-6">';
            html += '<h3 class="text-xl font-semibold text-gray-900">Profitability Analysis</h3>';
            html += '<select onchange="dashboardTimePeriod = this.value; renderApp();" class="px-4 py-2 border rounded-lg text-sm">';
            html += '<option value="this_week"' + (dashboardTimePeriod === 'this_week' ? ' selected' : '') + '>This Week</option>';
            html += '<option value="last_week"' + (dashboardTimePeriod === 'last_week' ? ' selected' : '') + '>Last Week</option>';
            html += '<option value="this_month"' + (dashboardTimePeriod === 'this_month' ? ' selected' : '') + '>This Month</option>';
            html += '<option value="last_month"' + (dashboardTimePeriod === 'last_month' ? ' selected' : '') + '>Last Month</option>';
            html += '<option value="last_3_months"' + (dashboardTimePeriod === 'last_3_months' ? ' selected' : '') + '>Last 3 Months</option>';
            html += '<option value="last_6_months"' + (dashboardTimePeriod === 'last_6_months' ? ' selected' : '') + '>Last 6 Months</option>';
            html += '<option value="this_year"' + (dashboardTimePeriod === 'this_year' ? ' selected' : '') + '>This Year</option>';
            html += '<option value="all_time"' + (dashboardTimePeriod === 'all_time' ? ' selected' : '') + '>All Time</option>';
            html += '</select>';
            html += '</div>'; // Close flex container

            // Summary Cards
            html += '<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">';
            html += '<div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-4 text-white">';
            html += '<div class="text-sm opacity-90 mb-1">Total Revenue</div>';
            html += '<div class="text-3xl font-bold">$' + totalRevenue.toFixed(2) + '</div>';
            html += '</div>';
            html += '<div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg p-4 text-white">';
            html += '<div class="text-sm opacity-90 mb-1">Jobs Completed</div>';
            html += '<div class="text-3xl font-bold">' + totalJobs + '</div>';
            html += '</div>';
            html += '<div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg p-4 text-white">';
            html += '<div class="text-sm opacity-90 mb-1">Avg Revenue/Job</div>';
            html += '<div class="text-3xl font-bold">$' + avgRevenuePerJob.toFixed(2) + '</div>';
            html += '</div>';
            html += '</div>';

            // Top 5 Suburbs Table
            html += '<div class="mb-6">';
            html += '<h4 class="text-lg font-semibold text-gray-900 mb-3">Top Profitable Suburbs</h4>';
            if (suburbAnalysis.length > 0) {
                html += '<div class="overflow-x-auto">';
                html += '<table class="min-w-full">';
                html += '<thead class="bg-gray-50">';
                html += '<tr>';
                html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Suburb</th>';
                html += '<th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Revenue</th>';
                html += '<th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Jobs</th>';
                html += '<th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Avg/Job</th>';
                html += '</tr>';
                html += '</thead>';
                html += '<tbody class="bg-white divide-y divide-gray-200">';

                suburbAnalysis.slice(0, 5).forEach((suburb, index) => {
                    html += '<tr class="hover:bg-gray-50">';
                    html += '<td class="px-4 py-3 text-sm font-medium text-gray-900">' + (index + 1) + '. ' + escapeHtml(suburb.suburb) + '</td>';
                    html += '<td class="px-4 py-3 text-sm text-right text-green-600 font-semibold">$' + suburb.totalRevenue.toFixed(2) + '</td>';
                    html += '<td class="px-4 py-3 text-sm text-right text-gray-600">' + suburb.jobCount + '</td>';
                    html += '<td class="px-4 py-3 text-sm text-right text-gray-600">$' + suburb.avgRevenue.toFixed(2) + '</td>';
                    html += '</tr>';
                });

                html += '</tbody>';
                html += '</table>';
                html += '</div>';
            } else {
                html += '<p class="text-gray-500 text-center py-4">No completed jobs in this period</p>';
            }
            html += '</div>';

            // Staff Performance Table
            html += '<div>';
            html += '<h4 class="text-lg font-semibold text-gray-900 mb-3">Staff Revenue Performance</h4>';
            if (staffAnalysis.length > 0) {
                html += '<div class="overflow-x-auto">';
                html += '<table class="min-w-full">';
                html += '<thead class="bg-gray-50">';
                html += '<tr>';
                html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Staff Member</th>';
                html += '<th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Revenue</th>';
                html += '<th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Jobs</th>';
                html += '<th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Avg/Job</th>';
                html += '</tr>';
                html += '</thead>';
                html += '<tbody class="bg-white divide-y divide-gray-200">';

                staffAnalysis.forEach((staffMember, index) => {
                    html += '<tr class="hover:bg-gray-50">';
                    html += '<td class="px-4 py-3 text-sm"><span class="font-medium" style="color: ' + staffMember.staffColor + '">' + (index + 1) + '. ' + escapeHtml(staffMember.staffName) + '</span></td>';
                    html += '<td class="px-4 py-3 text-sm text-right text-green-600 font-semibold">$' + staffMember.totalRevenue.toFixed(2) + '</td>';
                    html += '<td class="px-4 py-3 text-sm text-right text-gray-600">' + staffMember.jobCount + '</td>';
                    html += '<td class="px-4 py-3 text-sm text-right text-gray-600">$' + staffMember.avgRevenue.toFixed(2) + '</td>';
                    html += '</tr>';
                });

                html += '</tbody>';
                html += '</table>';
                html += '</div>';
            } else {
                html += '<p class="text-gray-500 text-center py-4">No staff performance data in this period</p>';
            }
            html += '</div>';

            html += '</div>'; // Close profitability section

            // Add Review Analytics Section
            html += renderReviewAnalytics();

            html += '</div>'; // Close main dashboard container
            return html;
        }

        function renderReviewAnalytics() {
            let html = '<div class="bg-white rounded-lg shadow p-6 mt-6">';

            // Header with filters
            html += '<div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-6">';
            html += '<h3 class="text-xl font-semibold text-gray-900">Review Analytics</h3>';
            html += '<div class="flex flex-wrap gap-3">';

            // Time period filter
            html += '<select onchange="dashboardReviewPeriod = this.value; renderApp();" class="px-4 py-2 border rounded-lg text-sm">';
            html += '<option value="this_week"' + (typeof dashboardReviewPeriod === 'undefined' || dashboardReviewPeriod === 'this_week' ? ' selected' : '') + '>This Week</option>';
            html += '<option value="last_week"' + (dashboardReviewPeriod === 'last_week' ? ' selected' : '') + '>Last Week</option>';
            html += '<option value="this_month"' + (dashboardReviewPeriod === 'this_month' ? ' selected' : '') + '>This Month</option>';
            html += '<option value="last_month"' + (dashboardReviewPeriod === 'last_month' ? ' selected' : '') + '>Last Month</option>';
            html += '<option value="last_3_months"' + (dashboardReviewPeriod === 'last_3_months' ? ' selected' : '') + '>Last 3 Months</option>';
            html += '<option value="this_year"' + (dashboardReviewPeriod === 'this_year' ? ' selected' : '') + '>This Year</option>';
            html += '<option value="all_time"' + (dashboardReviewPeriod === 'all_time' ? ' selected' : '') + '>All Time</option>';
            html += '</select>';

            // Staff filter
            html += '<select onchange="dashboardReviewStaff = this.value; renderApp();" class="px-4 py-2 border rounded-lg text-sm">';
            html += '<option value="">All Staff</option>';
            staff.forEach(s => {
                html += '<option value="' + s.id + '"' + (typeof dashboardReviewStaff !== 'undefined' && dashboardReviewStaff === s.id ? ' selected' : '') + '>' + s.full_name + '</option>';
            });
            html += '</select>';

            html += '</div>';
            html += '</div>';

            // Get filtered reviews
            const period = typeof dashboardReviewPeriod === 'undefined' ? 'this_week' : dashboardReviewPeriod;
            const {startDate, endDate} = getDateRangeForPeriod(period);

            let filteredReviews = jobs.filter(j => {
                if (!j.review_received || !j.review_received_date) return false;

                const reviewDate = new Date(j.review_received_date);
                const matchesDate = reviewDate >= startDate && reviewDate <= endDate;
                const matchesStaff = !dashboardReviewStaff || j.assigned_to === dashboardReviewStaff;

                return matchesDate && matchesStaff;
            });

            // Calculate statistics
            const totalReviews = filteredReviews.length;
            const ratedReviews = filteredReviews.filter(j => j.review_rating);
            const avgRating = ratedReviews.length > 0
                ? (ratedReviews.reduce((sum, j) => sum + j.review_rating, 0) / ratedReviews.length)
                : 0;

            // Rating distribution
            const ratingDistribution = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0};
            ratedReviews.forEach(j => {
                if (j.review_rating) {
                    ratingDistribution[j.review_rating]++;
                }
            });

            // Summary Cards
            html += '<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">';

            // Total Reviews
            html += '<div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-6 text-white">';
            html += '<div class="text-sm opacity-90 mb-1">Total Reviews</div>';
            html += '<div class="text-3xl font-bold">' + totalReviews + '</div>';
            html += '<div class="text-sm opacity-80 mt-1">' + ratedReviews.length + ' rated</div>';
            html += '</div>';

            // Average Rating
            html += '<div class="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-lg p-6 text-white">';
            html += '<div class="text-sm opacity-90 mb-1">Average Rating</div>';
            html += '<div class="text-3xl font-bold flex items-center gap-2">';
            if (avgRating > 0) {
                html += avgRating.toFixed(1) + ' <span class="text-2xl">â˜…</span>';
            } else {
                html += 'N/A';
            }
            html += '</div>';
            html += '<div class="text-sm opacity-80 mt-1">out of 5.0</div>';
            html += '</div>';

            // 5-Star Reviews
            html += '<div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg p-6 text-white">';
            html += '<div class="text-sm opacity-90 mb-1">5-Star Reviews</div>';
            html += '<div class="text-3xl font-bold">' + ratingDistribution[5] + '</div>';
            html += '<div class="text-sm opacity-80 mt-1">' + (ratedReviews.length > 0 ? ((ratingDistribution[5] / ratedReviews.length) * 100).toFixed(1) : 0) + '% of rated</div>';
            html += '</div>';

            // Below 4-Star Reviews (needs attention)
            const below4Star = ratingDistribution[1] + ratingDistribution[2] + ratingDistribution[3];
            html += '<div class="bg-gradient-to-br from-red-500 to-red-600 rounded-lg p-6 text-white">';
            html += '<div class="text-sm opacity-90 mb-1">Needs Attention</div>';
            html += '<div class="text-3xl font-bold">' + below4Star + '</div>';
            html += '<div class="text-sm opacity-80 mt-1">Reviews below 4â˜…</div>';
            html += '</div>';

            html += '</div>';

            if (totalReviews === 0) {
                html += '<div class="text-center py-12 text-gray-500">';
                html += '<span class="material-icons text-gray-300" style="font-size: 64px;">rate_review</span>';
                html += '<p class="mt-4">No reviews for selected period</p>';
                html += '</div>';
                html += '</div>';
                return html;
            }

            // Rating Distribution Chart
            html += '<div class="mb-6">';
            html += '<h4 class="text-lg font-semibold text-gray-900 mb-4">Rating Distribution</h4>';
            html += '<div class="space-y-3">';

            for (let rating = 5; rating >= 1; rating--) {
                const count = ratingDistribution[rating];
                const percentage = ratedReviews.length > 0 ? (count / ratedReviews.length) * 100 : 0;

                html += '<div class="flex items-center gap-4">';
                html += '<div class="flex items-center gap-1 w-24">';
                html += '<span class="text-sm font-medium text-gray-700">' + rating + '</span>';
                html += '<span class="text-yellow-500">â˜…</span>';
                html += '</div>';
                html += '<div class="flex-1">';
                html += '<div class="flex items-center gap-3">';
                html += '<div class="flex-1 bg-gray-200 rounded-full h-6">';

                let barColor = 'bg-gray-400';
                if (rating === 5) barColor = 'bg-green-500';
                else if (rating === 4) barColor = 'bg-blue-500';
                else if (rating === 3) barColor = 'bg-yellow-500';
                else if (rating === 2) barColor = 'bg-orange-500';
                else if (rating === 1) barColor = 'bg-red-500';

                html += '<div class="' + barColor + ' h-6 rounded-full flex items-center justify-end pr-2 transition-all" style="width: ' + percentage + '%">';
                if (count > 0) {
                    html += '<span class="text-xs text-white font-medium">' + count + '</span>';
                }
                html += '</div>';
                html += '</div>';
                html += '<span class="text-sm text-gray-600 font-medium w-12 text-right">' + percentage.toFixed(1) + '%</span>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
            }

            html += '</div>';
            html += '</div>';

            // Individual Reviews Table
            html += '<div class="mb-6">';
            html += '<h4 class="text-lg font-semibold text-gray-900 mb-4">Recent Reviews</h4>';
            html += '<div class="overflow-x-auto">';
            html += '<table class="min-w-full">';
            html += '<thead class="bg-gray-50">';
            html += '<tr>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Client</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Staff</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rating</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Job Details</th>';
            html += '</tr>';
            html += '</thead>';
            html += '<tbody class="bg-white divide-y divide-gray-200">';

            // Sort by date, most recent first
            const sortedReviews = [...filteredReviews].sort((a, b) => {
                return new Date(b.review_received_date) - new Date(a.review_received_date);
            });

            // Show max 20 most recent
            sortedReviews.slice(0, 20).forEach(job => {
                const staffMember = job.staff || staff.find(s => s.id === job.assigned_to);
                const staffName = staffMember ? staffMember.full_name : 'Unknown';
                const staffColor = staffMember ? staffMember.color_code : '#666';

                html += '<tr class="hover:bg-gray-50">';

                // Date
                html += '<td class="px-4 py-3 text-sm whitespace-nowrap">';
                html += new Date(job.review_received_date).toLocaleDateString();
                html += '</td>';

                // Client
                html += '<td class="px-4 py-3 text-sm font-medium">';
                html += escapeHtml(job.client_name);
                html += '<div class="text-xs text-gray-500">' + escapeHtml(job.suburb || '') + '</div>';
                html += '</td>';

                // Staff
                html += '<td class="px-4 py-3 text-sm">';
                html += '<span style="color: ' + staffColor + '" class="font-medium">' + escapeHtml(staffName) + '</span>';
                html += '</td>';

                // Rating
                html += '<td class="px-4 py-3 text-sm">';
                if (job.review_rating) {
                    html += '<div class="flex items-center gap-2">';
                    html += '<div class="flex">';
                    for (let i = 1; i <= 5; i++) {
                        if (i <= job.review_rating) {
                            html += '<span class="text-yellow-500 text-lg">â˜…</span>';
                        } else {
                            html += '<span class="text-gray-300 text-lg">â˜…</span>';
                        }
                    }
                    html += '</div>';
                    html += '<span class="text-gray-600 font-medium">(' + job.review_rating + '/5)</span>';
                    html += '</div>';
                } else {
                    html += '<span class="text-gray-400 text-xs">Not rated</span>';
                }
                html += '</td>';

                // Job Details
                html += '<td class="px-4 py-3 text-sm text-gray-600">';
                html += '<div class="max-w-xs truncate" title="' + escapeHtml(job.job_description) + '">';
                html += escapeHtml(job.job_description);
                html += '</div>';
                html += '<div class="text-xs text-gray-500 mt-1">Job Date: ' + new Date(job.date).toLocaleDateString() + '</div>';
                html += '</td>';

                html += '</tr>';
            });

            html += '</tbody>';
            html += '</table>';
            html += '</div>';

            if (sortedReviews.length > 20) {
                html += '<div class="text-center mt-4 text-sm text-gray-500">';
                html += 'Showing 20 of ' + sortedReviews.length + ' reviews';
                html += '</div>';
            }

            html += '</div>';

            html += '</div>';
            return html;
        }

        function renderJobForm() {
            const staffOptions = staff.map(s => '<option value="' + s.id + '">' + s.full_name + '</option>').join('');

            let html = '<div class="max-w-3xl mx-auto"><div class="bg-white rounded-lg shadow p-4 md:p-6">';
            html += '<h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-4 md:mb-6">Create New Job</h2>';
            html += '<form onsubmit="handleJobSubmit(event)" class="space-y-4 md:space-y-6">';
            html += '<div class="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4">';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Date *</label><input type="date" name="date" required class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"></div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Start Time *</label><select name="start_time" id="jobStartTime" onchange="updateEndTimeOptions(\'job\')" required class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"><option value="">Select...</option>' + generateTimeOptions() + '</select></div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">End Time *</label><select name="end_time" id="jobEndTime" onchange="updateDurationDisplay(\'job\')" required class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"><option value="">Select...</option>' + generateTimeOptions() + '</select></div>';
            html += '<div id="jobDurationDisplay" class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg hidden"><div class="flex items-center gap-2"><span class="material-icons text-blue-600">schedule</span><span class="text-sm font-semibold text-blue-900">Job Duration: <span id="jobDurationText"></span></span></div></div>';
            html += '</div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Assign To</label><select name="assigned_to" class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"><option value="">-- Leave Unassigned --</option>' + staffOptions + '</select></div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Status</label><select name="status" class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"><option value="Unassigned">Unassigned</option><option value="Assigned">Assigned</option><option value="Assigned/Fix">Assigned/Fix</option><option value="In Progress">In Progress</option><option value="Reschedule">Reschedule</option></select></div>';
            html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Client Name *</label><input type="text" name="client_name" required class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"></div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Phone *</label><input type="tel" name="client_phone" required class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"></div>';
            html += '</div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Address *</label><textarea name="address" required rows="2" class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"></textarea></div>' +
                '<div><label class="block text-sm font-medium text-gray-700 mb-2">Suburb *</label><input type="text" name="suburb" list="suburbList" required class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"><datalist id="suburbList"></datalist></div>'
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Job Description *</label><textarea name="job_description" required rows="3" class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"></textarea></div>';
            html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Price ($) *</label><input type="number" step="0.01" name="price" required class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"></div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">GST *</label><div class="space-y-2"><label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50"><input type="radio" name="price_includes_gst" value="false" checked class="w-4 h-4 text-green-600"><span class="ml-3 text-sm md:text-base">Price +GST</span></label><label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50"><input type="radio" name="price_includes_gst" value="true" class="w-4 h-4 text-gray-600"><span class="ml-3 text-sm md:text-base">Price excl GST</span></label></div></div>';
            html += '</div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Email</label><input type="email" name="client_email" class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"></div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Contact Method</label><select name="contact_method" class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"><option value="">Not specified</option><option value="Phone Call">Phone Call</option><option value="Email">Email</option><option value="Whatsapp">Whatsapp</option><option value="SMS">SMS</option><option value="Referral">Referral</option><option value="Other">Other</option></select></div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Photos</label><div class="flex gap-2"><input type="file" id="createJobPhotoUpload" accept="image/*" multiple class="hidden"><button type="button" onclick="document.getElementById(\'createJobPhotoUpload\').click()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-2"><span class="material-icons text-sm">add_photo_alternate</span>Select Photos</button><span id="createJobPhotoCount" class="text-sm text-gray-600 self-center">No photos selected</span></div><div id="createJobPhotoPreview" class="grid grid-cols-3 gap-2 mt-2"></div></div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Priority</label><select name="priority" class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base"><option value="Normal">Normal</option><option value="High">High</option><option value="Urgent">Urgent</option></select></div>';
            html += '<div class="flex flex-col md:flex-row gap-3 md:gap-4">';
            html += '<button type="submit" class="w-full md:flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg text-sm md:text-base">Create Job</button>';
            html += '<button type="button" onclick="changeView(&#39;dashboard&#39;)" class="w-full md:flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-3 px-6 rounded-lg text-sm md:text-base">Cancel</button>';
            html += '</div></form></div></div>';
            // Initialize photo upload preview after form renders
            setTimeout(() => {
                const fileInput = document.getElementById('createJobPhotoUpload');
                const photoCount = document.getElementById('createJobPhotoCount');
                const photoPreview = document.getElementById('createJobPhotoPreview');
                
                if (fileInput) {
                    fileInput.addEventListener('change', function(e) {
                        const files = e.target.files;
                        if (files && files.length > 0) {
                            photoCount.textContent = files.length + ' photo(s) selected';
                            
                            // Show preview thumbnails
                            photoPreview.innerHTML = '';
                            Array.from(files).forEach((file, index) => {
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    const div = document.createElement('div');
                                    div.className = 'relative group';
                                    div.innerHTML = '<img src="' + e.target.result + '" alt="Preview ' + (index + 1) + '" class="w-full h-24 object-cover rounded border border-gray-300"><div class="absolute inset-0 bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 transition-opacity rounded flex items-center justify-center text-white text-xs">Photo ' + (index + 1) + '</div>';
                                    photoPreview.appendChild(div);
                                };
                                reader.readAsDataURL(file);
                            });
                        } else {
                            photoCount.textContent = 'No photos selected';
                            photoPreview.innerHTML = '';
                        }
                    });
                }
            }, 100);
            return html;
        }

        function renderJobsList(showCompleted) {
            let filteredJobs;
            let title;
            let emptyMsg;

            if (showCompleted === 'archived') {
                filteredJobs = jobs.filter(j => j.status === 'Cancelled');
                title = 'Archived Jobs';
                emptyMsg = 'No archived jobs yet.';
            } else if (showCompleted) {
                filteredJobs = jobs.filter(j => j.status === 'Completed');
                title = 'Completed Jobs';
                emptyMsg = 'No completed jobs yet.';
            } else {
                filteredJobs = jobs.filter(j => j.status !== 'Completed' && j.status !== 'Cancelled');
                title = 'Active Jobs';
                emptyMsg = 'No active jobs.';
            }

            if (currentDateFilter) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                filteredJobs = filteredJobs.filter(j => {
                    // For completed jobs, use actual_end_time if available, otherwise use job date
                    let jobDate;
                    if (showCompleted === true && j.actual_end_time) {
                        jobDate = new Date(j.actual_end_time);
                    } else {
                        jobDate = new Date(j.date);
                    }
                    jobDate.setHours(0, 0, 0, 0);

                    if (currentDateFilter === 'today') {
                        return jobDate.getTime() === today.getTime();
                    } else if (currentDateFilter === 'yesterday') {
                        const yesterday = new Date(today);
                        yesterday.setDate(today.getDate() - 1);
                        return jobDate.getTime() === yesterday.getTime();
                    } else if (currentDateFilter === 'this_week') {
                        // Current week: Monday to Sunday
                        const weekStart = new Date(today);
                        weekStart.setDate(today.getDate() - today.getDay());
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekStart.getDate() + 6);
                        return jobDate >= weekStart && jobDate <= weekEnd;
                    } else if (currentDateFilter === 'last_week') {
                        // Previous Monday to Sunday
                        const lastWeekEnd = new Date(today);
                        lastWeekEnd.setDate(today.getDate() - today.getDay() - 1); // Last Sunday
                        const lastWeekStart = new Date(lastWeekEnd);
                        lastWeekStart.setDate(lastWeekEnd.getDate() - 6); // Previous Monday
                        return jobDate >= lastWeekStart && jobDate <= lastWeekEnd;
                    } else if (currentDateFilter === 'last_month') {
                        const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                        const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
                        return jobDate >= lastMonth && jobDate <= lastMonthEnd;
                    } else if (currentDateFilter === 'last_3_months') {
                        const threeMonthsAgo = new Date(today);
                        threeMonthsAgo.setMonth(today.getMonth() - 3);
                        return jobDate >= threeMonthsAgo && jobDate <= today;
                    } else if (currentDateFilter === 'last_6_months') {
                        const sixMonthsAgo = new Date(today);
                        sixMonthsAgo.setMonth(today.getMonth() - 6);
                        return jobDate >= sixMonthsAgo && jobDate <= today;
                    } else if (currentDateFilter === 'this_year') {
                        return jobDate.getFullYear() === today.getFullYear();
                    } else if (currentDateFilter === 'tomorrow') {
                        const tomorrow = new Date(today);
                        tomorrow.setDate(today.getDate() + 1);
                        return jobDate.getTime() === tomorrow.getTime();
                    } else if (currentDateFilter === 'next_week') {
                        const nextWeekStart = new Date(today);
                        nextWeekStart.setDate(today.getDate() - today.getDay() + 7);
                        const nextWeekEnd = new Date(nextWeekStart);
                        nextWeekEnd.setDate(nextWeekStart.getDate() + 6);
                        return jobDate >= nextWeekStart && jobDate <= nextWeekEnd;
                    } else if (currentDateFilter === 'this_month') {
                        return jobDate.getMonth() === today.getMonth() && jobDate.getFullYear() === today.getFullYear();
                    }
                    return true;
                });
            }

            if (currentStaffFilter) {
                filteredJobs = filteredJobs.filter(j => j.assigned_to === currentStaffFilter);
            }
            if (window.statusFilter) {
                filteredJobs = filteredJobs.filter(j => j.status === window.statusFilter);
            }
            const staffOptions = staff.map(s => '<option value="' + s.id + '"' + (currentStaffFilter === s.id ? ' selected' : '') + '>' + s.full_name + '</option>').join('');
            const staffFilterDropdown = '<select onchange="currentStaffFilter = this.value; renderApp();" class="px-4 py-2 border rounded-lg text-sm md:text-base"><option value="">All Staff</option>' + staffOptions + '</select>';
            // Different filters for active vs completed jobs
            let dateFilterDropdown;
            if (showCompleted === true) {
                // Historical filters for completed jobs
                dateFilterDropdown = '<select onchange="currentDateFilter = this.value; renderApp();" class="px-4 py-2 border rounded-lg text-sm md:text-base">' +
                    '<option value="">All Time</option>' +
                    '<option value="today"' + (currentDateFilter === 'today' ? ' selected' : '') + '>Today</option>' +
                    '<option value="yesterday"' + (currentDateFilter === 'yesterday' ? ' selected' : '') + '>Yesterday</option>' +
                    '<option value="this_week"' + (currentDateFilter === 'this_week' ? ' selected' : '') + '>This Week</option>' +
                    '<option value="last_week"' + (currentDateFilter === 'last_week' ? ' selected' : '') + '>Last Week</option>' +
                    '<option value="last_month"' + (currentDateFilter === 'last_month' ? ' selected' : '') + '>Last Month</option>' +
                    '<option value="last_3_months"' + (currentDateFilter === 'last_3_months' ? ' selected' : '') + '>Last 3 Months</option>' +
                    '<option value="last_6_months"' + (currentDateFilter === 'last_6_months' ? ' selected' : '') + '>Last 6 Months</option>' +
                    '<option value="this_year"' + (currentDateFilter === 'this_year' ? ' selected' : '') + '>This Year</option>' +
                    '</select>';
            } else {
                // Future-focused filters for active jobs
                dateFilterDropdown = '<select onchange="currentDateFilter = this.value; renderApp();" class="px-4 py-2 border rounded-lg text-sm md:text-base">' +
                    '<option value="">All Dates</option>' +
                    '<option value="today"' + (currentDateFilter === 'today' ? ' selected' : '') + '>Today</option>' +
                    '<option value="tomorrow"' + (currentDateFilter === 'tomorrow' ? ' selected' : '') + '>Tomorrow</option>' +
                    '<option value="this_week"' + (currentDateFilter === 'this_week' ? ' selected' : '') + '>This Week</option>' +
                    '<option value="next_week"' + (currentDateFilter === 'next_week' ? ' selected' : '') + '>Next Week</option>' +
                    '<option value="this_month"' + (currentDateFilter === 'this_month' ? ' selected' : '') + '>This Month</option>' +
                    '</select>';
            }
            const columnSelector = `
                <div class="relative">
                    <button onclick="toggleColumnSelector()" class="px-4 py-2 border rounded-lg text-sm md:text-base bg-white hover:bg-gray-50 flex items-center gap-2">
                        <span class="material-icons md-18">view_column</span>
                        Columns
                        <span class="material-icons md-18">${columnSelectorOpen ? 'expand_less' : 'expand_more'}</span>
                    </button>
                    ${columnSelectorOpen ? `
                        <div class="absolute right-0 md:right-0 left-0 md:left-auto mt-2 w-full md:w-64 bg-white border border-gray-200 rounded-lg shadow-lg z-50 p-3">
                            <div class="flex justify-between items-center mb-3 pb-2 border-b">
                                <span class="text-sm font-semibold text-gray-700">Select Columns</span>
                                <div class="flex gap-2">
                                    <button onclick="event.stopPropagation(); selectAllColumns();" class="text-xs text-blue-600 hover:text-blue-800">All</button>
                                    <button onclick="event.stopPropagation(); deselectAllColumns();" class="text-xs text-gray-600 hover:text-gray-800">Reset</button>
                                </div>
                            </div>
                            <div class="space-y-2 max-h-80 overflow-y-auto">
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.date ? 'checked' : ''} onchange="toggleColumn('date')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Date</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.start_time ? 'checked' : ''} onchange="toggleColumn('start_time')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Start Time</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.end_time ? 'checked' : ''} onchange="toggleColumn('end_time')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">End Time</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.assigned_to ? 'checked' : ''} onchange="toggleColumn('assigned_to')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Assigned To</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.status ? 'checked' : ''} onchange="toggleColumn('status')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Status</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.client_name ? 'checked' : ''} onchange="toggleColumn('client_name')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Client Name</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.address ? 'checked' : ''} onchange="toggleColumn('address')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Address</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.suburb ? 'checked' : ''} onchange="toggleColumn('suburb')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Suburb</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.phone ? 'checked' : ''} onchange="toggleColumn('phone')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Phone</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.description ? 'checked' : ''} onchange="toggleColumn('description')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Description</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.price ? 'checked' : ''} onchange="toggleColumn('price')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Price</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.email ? 'checked' : ''} onchange="toggleColumn('email')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Email</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.amount_paid ? 'checked' : ''} onchange="toggleColumn('amount_paid')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Amount Paid</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.payment_method ? 'checked' : ''} onchange="toggleColumn('payment_method')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Payment Method</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.photos ? 'checked' : ''} onchange="toggleColumn('photos')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Photos</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.notes ? 'checked' : ''} onchange="toggleColumn('notes')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Notes</span>
                                </label>
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" ${visibleColumns.contact_method ? 'checked' : ''} onchange="toggleColumn('contact_method')" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-3 text-sm text-gray-700">Contact Method</span>
                                </label>
                            </div>
                        </div>
                    ` : ''
                }
                </div >
            `;
            const exportButton = `
                <button onclick="openAdvancedExportModal()" class="px-4 py-2 border border-green-600 text-green-600 hover:bg-green-50 rounded-lg text-sm md:text-base font-medium flex items-center gap-2">
                    <span class="material-icons md-18">download</span>
                    Export
                </button>
                `;
            const summaryButton = `
                <button onclick="generateSummaryReport()" class="px-4 py-2 border border-purple-600 text-purple-600 hover:bg-purple-50 rounded-lg text-sm md:text-base font-medium flex items-center gap-2">
                    <span class="material-icons md-18">summarize</span>
                    Summary
                </button>
            `;
            if (filteredJobs.length === 0) {
                return '<div class="space-y-4"><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3"><h2 class="text-xl md:text-2xl font-bold text-gray-900">' + title + '</h2><div class="flex gap-3 flex-wrap">' + dateFilterDropdown + staffFilterDropdown + columnSelector + exportButton + summaryButton + '<button onclick="changeView(\'create-job\')" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg text-sm md:text-base">+ Create Job</button></div></div><div class="bg-white rounded-lg shadow p-8 md:p-12 text-center"><p class="text-gray-500">' + emptyMsg + '</p></div></div>';
            }
            const jobsByDate = {};
            filteredJobs.forEach(job => {
                if (!jobsByDate[job.date]) jobsByDate[job.date] = [];
                jobsByDate[job.date].push(job);
            });
            const mobileCards = Object.keys(jobsByDate).sort().map(date => {
                const dateJobs = jobsByDate[date];
                const dateHeader = '<div class="date-header px-4 py-2 border-b border-gray-300"><h3 class="text-sm font-bold text-gray-700">' + new Date(date).toLocaleDateString('en-US', {weekday: 'short', month: 'short', day: 'numeric', year: 'numeric'}) + '</h3></div>';
                const cards = dateJobs.map(job => renderMobileJobCard(job)).join('');
                return dateHeader + cards;
            }).join('');
            return '<div class="space-y-4"><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3"><h2 class="text-xl md:text-2xl font-bold text-gray-900">' + title + '</h2><div class="flex gap-3 w-full sm:w-auto flex-wrap">' + dateFilterDropdown + staffFilterDropdown + columnSelector + exportButton + summaryButton + '<button onclick="changeView(\'create-job\')" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg text-sm md:text-base whitespace-nowrap">+ Create Job</button></div></div><div class="bg-white rounded-lg shadow overflow-x-auto">' + renderDesktopTable(filteredJobs) + '</div></div>';
        }

        function renderMobileJobCard(job) {
            const gstBadge = job.price_includes_gst ? '<span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded ml-1">incl. GST</span>' : '<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded font-medium ml-1">+GST</span>';
            const borderColor = job.priority === 'Urgent' ? 'border-red-500' : job.priority === 'High' ? 'border-yellow-500' : 'border-gray-300';
            const statusBg = getStatusClass(job.status);
            const staffDisplay = job.staff ? '<span style="color: ' + job.staff.color_code + '">' + job.staff.full_name + '</span>' : 'Unassigned';
            return '<div class="job-card bg-white border-l-4 ' + borderColor + ' p-4 border-b hover:bg-gray-50" onclick="openMobileJobModal(\'' + job.id + '\')"><div class="flex justify-between items-start mb-2"><div class="flex-1"><div class="font-semibold text-gray-900">' + escapeHtml(job.client_name) + '</div><div class="text-xs text-gray-500 mt-1 flex items-center gap-1"><span class="material-icons md-18">schedule</span>' + formatTime12Hour(job.start_time) + ' - ' + formatTime12Hour(job.end_time) + '</div></div><span class="px-2 py-1 rounded-full text-xs font-medium ' + statusBg + '">' + job.status + '</span></div><div class="space-y-1 text-sm text-gray-600"><div class="flex items-center gap-1"><span class="material-icons md-18">person</span>' + staffDisplay + '</div><div class="flex items-center gap-1"><span class="material-icons md-18">attach_money</span>$' + parseFloat(job.price).toFixed(2) + gstBadge + '</div></div></div>';
        }

        function renderDesktopTable(filteredJobs) {
            const tableRows = filteredJobs.map(job => {
                const gstBadge = job.price_includes_gst
                    ? '<span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded ml-1">excl</span>'
                    : '<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded font-medium ml-1">+GST</span>';
                const photoUrl = (job.photo_urls && job.photo_urls.length > 0) ? job.photo_urls[0] : '';
                const statusBg = getStatusClass(job.status);
                const staffDisplay = job.staff
                    ? '<span style="color: ' + job.staff.color_code + '">' + job.staff.full_name + '</span>'
                    : '<span class="text-gray-400">Unassigned</span>';

                let row = '<tr class="' + (job.status === 'In Progress' ? 'in-progress-row' : 'hover:bg-gray-50') + '">';


                if (visibleColumns.date) {
                    row += '<td id="cell-' + job.id + '-date" class="editable-cell text-sm whitespace-nowrap" onclick="makeEditable(\'' + job.id + '\', \'date\', \'' + job.date + '\', \'date\')"><span class="px-2 py-1 rounded font-medium" style="background-color: ' + getDateColor(job.date) + '; color: ' + getDateTextColor(job.date) + '">' + formatDateWithDay(job.date) + '</span></td>';
                }
                const reviewBadge = job.request_review ? '<span class="text-yellow-500 text-lg mr-2" title="Review requested">â­</span>' : '';
                row += '<td class="px-4 py-2 text-sm whitespace-nowrap">' + reviewBadge + '<button onclick="duplicateJob(\'' + job.id + '\')" class="text-green-600 hover:text-green-800 mr-3" title="Duplicate"><span class="material-icons md-18">content_copy</span></button><button onclick="openEditModalById(\'' + job.id + '\')" class="text-blue-600 hover:text-blue-800 mr-3" title="Edit"><span class="material-icons md-18">edit</span></button><button onclick="deleteJob(\'' + job.id + '\')" class="text-red-600 hover:text-red-800" title="Delete"><span class="material-icons md-18">delete</span></button></td>';
                if (visibleColumns.start_time) {
                    row += '<td id="cell-' + job.id + '-start_time" class="editable-cell text-sm whitespace-nowrap" onclick="makeEditable(\'' + job.id + '\', \'start_time\', \'' + job.start_time + '\', \'time\')"><span class="px-2 py-1 bg-blue-600 text-white rounded font-semibold">' + formatTime12Hour(job.start_time) + '</span></td>';
                }
                if (visibleColumns.end_time) {
                    row += '<td id="cell-' + job.id + '-end_time" class="editable-cell text-sm whitespace-nowrap" onclick="makeEditable(\'' + job.id + '\', \'end_time\', \'' + job.end_time + '\', \'time\')"><span class="px-2 py-1 bg-blue-600 text-white rounded font-semibold">' + formatTime12Hour(job.end_time) + '</span></td>';
                }
                if (visibleColumns.assigned_to) {
                    row += '<td id="cell-' + job.id + '-assigned_to" class="editable-cell text-sm whitespace-nowrap" onclick="makeEditable(\'' + job.id + '\', \'assigned_to\', \'' + (job.assigned_to || '') + '\', \'select-staff\')">' + staffDisplay + '</td>';
                }
                if (visibleColumns.status) {
                    row += '<td id="cell-' + job.id + '-status" class="editable-cell text-sm whitespace-nowrap" onclick="makeEditable(\'' + job.id + '\', \'status\', \'' + job.status + '\', \'select-status\')"><span class="px-2 py-1 rounded-full text-xs font-medium ' + statusBg + '">' + job.status + '</span></td>';
                }
                if (visibleColumns.client_name) {
                    row += '<td id="cell-' + job.id + '-client_name" class="editable-cell text-sm min-w-[120px]" onclick="makeEditable(\'' + job.id + '\', \'client_name\', \'' + escapeHtml(job.client_name).replace(/'/g, "\\'") + '\', \'text\')">' + escapeHtml(job.client_name) + '</td>';
                }
                if (visibleColumns.address) {
                    row += '<td id="cell-' + job.id + '-address" class="editable-cell text-sm min-w-[150px] max-w-[200px] truncate" title="' + escapeHtml(job.address) + '" onclick="makeEditable(\'' + job.id + '\', \'address\', \'' + escapeHtml(job.address).replace(/'/g, "\\'").replace(/\n/g, ' ') + '\', \'textarea\')">' + escapeHtml(job.address) + '</td>';
                }
                if (visibleColumns.suburb) {
                    row += '<td id="cell-' + job.id + '-suburb" class="editable-cell text-sm min-w-[120px]" onclick="makeEditable(\'' + job.id + '\', \'suburb\', \'' + escapeHtml(job.suburb || '').replace(/'/g, "\\'") + '\', \'text\')"><span class="px-2 py-1 bg-blue-600 text-white rounded font-semibold">' + escapeHtml(job.suburb || 'N/A') + '</span></td>';
                }
                if (visibleColumns.phone) {
                    row += '<td id="cell-' + job.id + '-client_phone" class="editable-cell text-sm whitespace-nowrap" onclick="makeEditable(\'' + job.id + '\', \'client_phone\', \'' + escapeHtml(job.client_phone).replace(/'/g, "\\'") + '\', \'text\')">' + escapeHtml(job.client_phone) + '</td>';
                }
                if (visibleColumns.description) {
                    row += '<td id="cell-' + job.id + '-job_description" class="editable-cell text-sm min-w-[150px] max-w-[250px] truncate" title="' + escapeHtml(job.job_description) + '" onclick="makeEditable(\'' + job.id + '\', \'job_description\', \'' + escapeHtml(job.job_description).replace(/'/g, "\\'").replace(/\n/g, ' ') + '\', \'textarea\')">' + escapeHtml(job.job_description) + '</td>';
                }
                if (visibleColumns.price) {
                    row += '<td id="cell-' + job.id + '-price" class="editable-cell text-sm whitespace-nowrap" onclick="makeEditable(\'' + job.id + '\', \'price\', \'' + job.price + '\', \'number\')">$' + parseFloat(job.price).toFixed(2) + gstBadge + '</td>';
                }
                if (visibleColumns.email) {
                    row += '<td id="cell-' + job.id + '-client_email" class="editable-cell text-sm min-w-[150px]">' + (job.client_email || '<span class="text-gray-400">N/A</span>') + '</td>';
                }
                if (visibleColumns.amount_paid) {
                    row += '<td id="cell-' + job.id + '-amount_paid" class="editable-cell text-sm whitespace-nowrap" onclick="makeEditable(\'' + job.id + '\', \'amount_paid\', \'' + (job.amount_paid || '') + '\', \'number\')">' + (job.amount_paid ? '$' + parseFloat(job.amount_paid).toFixed(2) : '<span class="text-gray-400">N/A</span>') + '</td>';
                }
                if (visibleColumns.payment_method) {
                    row += '<td id="cell-' + job.id + '-payment_method" class="editable-cell text-sm whitespace-nowrap" onclick="makeEditable(\'' + job.id + '\', \'payment_method\', \'' + (job.payment_method || '') + '\', \'select-payment\')">' + (job.payment_method || '<span class="text-gray-400">N/A</span>') + '</td>';
                }
                if (visibleColumns.photos) {
                    if (job.photo_urls && job.photo_urls.length > 0) {
                        const photoCount = job.photo_urls.length > 1 ? ' (' + job.photo_urls.length + ')' : '';
                        row += '<td class="text-sm whitespace-nowrap"><button onclick="event.stopPropagation(); openPhotoGallery(' + JSON.stringify(job.photo_urls).replace(/"/g, '&quot;') + ', 0)" class="text-blue-600 hover:text-blue-800 underline">View' + photoCount + '</button></td>';
                    } else {
                        row += '<td class="text-sm whitespace-nowrap"><span class="text-gray-400">None</span></td>';
                    }
                }
                if (visibleColumns.notes) {
                    row += '<td id="cell-' + job.id + '-notes" class="editable-cell text-sm min-w-[150px] max-w-[250px]" onclick="makeEditable(\'' + job.id + '\', \'notes\', \'' + escapeHtml(job.notes || '').replace(/'/g, "\\'").replace(/\n/g, ' ') + '\', \'textarea\')">' + (job.notes ? '<span class="bg-yellow-50 px-2 py-1 rounded text-xs">' + escapeHtml(job.notes.substring(0, 50)) + (job.notes.length > 50 ? '...' : '') + '</span>' : '<span class="text-gray-400">No notes</span>') + '</td>';
                }
                if (visibleColumns.contact_method) {
                    row += '<td id="cell-' + job.id + '-contact_method" class="editable-cell text-sm whitespace-nowrap" onclick="makeEditable(\'' + job.id + '\', \'contact_method\', \'' + (job.contact_method || '') + '\', \'select-contact\')">' + (job.contact_method || '<span class="text-gray-400">N/A</span>') + '</td>';
                }

                return row;
            }).join('');

            let headers = '<thead class="bg-gray-50"><tr>';
            if (visibleColumns.date) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="min-width: 140px;">Date</th>';
            headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>';
            if (visibleColumns.start_time) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start</th>';
            if (visibleColumns.end_time) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">End</th>';
            if (visibleColumns.assigned_to) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Staff</th>';
            if (visibleColumns.status) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>';
            if (visibleColumns.client_name) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client</th>';
            if (visibleColumns.address) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>';
            if (visibleColumns.suburb) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Suburb</th>';
            if (visibleColumns.phone) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>';
            if (visibleColumns.description) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>';
            if (visibleColumns.price) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>';
            if (visibleColumns.email) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>';
            if (visibleColumns.amount_paid) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Paid</th>';
            if (visibleColumns.payment_method) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment</th>';
            if (visibleColumns.photos) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Photos</th>';
            if (visibleColumns.notes) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>';
            if (visibleColumns.contact_method) headers += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">Contact Method</th>';
            headers += '</tr></thead>';

            return '<div class="overflow-x-auto -mx-4 md:mx-0" style="max-height: calc(100vh - 200px); overflow-y: auto;"><table class="min-w-full border-collapse">' +
                headers +
                '<tbody class="bg-white">' + tableRows + '</tbody></table></div>';
        }

        function openEditModalById(jobId) {
            const job = jobs.find(j => j.id === jobId);
            if (job) openEditModal(job);
        }

        function renderStaffManagement() {
            const staffCards = staff.map(s => '<div class="bg-white rounded-lg shadow p-4 md:p-6 border-l-4" style="border-color: ' + s.color_code + '"><div class="flex items-start justify-between mb-3 md:mb-4"><div><h3 class="text-base md:text-lg font-bold text-gray-900">' + s.full_name + '</h3><p class="text-xs md:text-sm text-gray-500">@' + s.username + '</p></div><div class="w-8 h-8 md:w-10 md:h-10 rounded-full" style="background-color: ' + s.color_code + '"></div></div><div class="space-y-2 text-xs md:text-sm"><div><span class="font-medium">Phone:</span> ' + (s.phone || 'Not set') + '</div><div><span class="font-medium">Status:</span> <span class="px-2 py-1 rounded-full text-xs ' + (s.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800') + '">' + (s.active ? 'Active' : 'Inactive') + '</span></div></div></div>').join('');
            return '<div class="space-y-4 md:space-y-6"><h2 class="text-xl md:text-2xl font-bold text-gray-900">Staff Management</h2><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">' + staffCards + '</div><div class="bg-blue-50 border border-blue-200 rounded-lg p-3 md:p-4"><p class="text-xs md:text-sm text-blue-800"><strong>Note:</strong> To add or edit staff, access Supabase Table Editor.</p></div></div>';
        }

        function renderStaffSchedule() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Get selected date (default to today)
            const selectedDate = window.scheduleSelectedDate || today.toISOString().split('T')[0];
            const scheduleDate = new Date(selectedDate);
            scheduleDate.setHours(0, 0, 0, 0);

            // Filter jobs for the selected date
            const dayJobs = jobs.filter(j => {
                if (j.status === 'Completed' || j.status === 'Cancelled') return false;
                const jobDate = new Date(j.date);
                jobDate.setHours(0, 0, 0, 0);
                return jobDate.getTime() === scheduleDate.getTime();
            });

            let html = '<div class="space-y-6">';
            
            // Header with date picker and view toggle
            html += '<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">';
            html += '<h2 class="text-2xl font-bold text-gray-900">Staff Schedule Grid</h2>';
            html += '<div class="flex gap-3 items-center flex-wrap">';

            // View mode toggle
            html += '<div class="flex bg-gray-100 rounded-lg p-1">';
            html += '<button onclick="scheduleViewMode = \'daily\'; renderApp();" class="px-4 py-2 rounded ' + (scheduleViewMode === 'daily' ? 'bg-white shadow text-blue-600 font-medium' : 'text-gray-600') + '">Daily</button>';
            html += '<button onclick="scheduleViewMode = \'weekly\'; renderApp();" class="px-4 py-2 rounded ' + (scheduleViewMode === 'weekly' ? 'bg-white shadow text-blue-600 font-medium' : 'text-gray-600') + '">Weekly</button>';
            html += '</div>';

            html += '<input type="date" id="scheduleDatePicker" value="' + selectedDate + '" onchange="window.scheduleSelectedDate = this.value; renderApp();" class="px-4 py-2 border rounded-lg">';
            html += '<button onclick="window.scheduleSelectedDate = new Date().toISOString().split(\'T\')[0]; renderApp();" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Today</button>';
            html += '</div>';
            html += '</div>';

            // Render based on view mode
            if (scheduleViewMode === 'weekly') {
                html += renderWeeklyScheduleView(scheduleDate);
            } else {
                html += renderDailyScheduleView(scheduleDate, dayJobs);
            }

            html += '</div>';
            return html;

            // Build the schedule grid
            html += '<div class="bg-white rounded-lg shadow overflow-x-auto">';
            html += '<table class="min-w-full border-collapse">';
            
            // Header row with staff names
            html += '<thead class="bg-gray-50 sticky top-0">';
            html += '<tr>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase sticky left-0 bg-gray-50 z-10 border-r-2 border-gray-300">Time</th>';
            
            staff.forEach(s => {
                html += '<th class="px-4 py-3 text-center text-xs font-medium uppercase border" style="color: ' + s.color_code + '">' + s.full_name + '</th>';
            });
            
            html += '</tr>';
            html += '</thead>';
            html += '<tbody class="bg-white">';

            // Generate time slots (5 AM to 9:30 PM in 15-minute intervals)
            for (let hour = 5; hour < 22; hour++) {
                for (let minute = 0; minute < 60; minute += 15) {
                    if (hour === 21 && minute > 30) break; // Stop at 9:30 PM

                    const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}:00`;
                    const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
                    const period = hour >= 12 ? 'PM' : 'AM';
                    const displayTime = `${displayHour}:${minute.toString().padStart(2, '0')} ${period}`;

                    html += '<tr class="border-t">';
                    html += '<td class="px-4 py-2 text-sm font-semibold text-gray-700 whitespace-nowrap sticky left-0 bg-gray-50 border-r-2 border-gray-300">' + displayTime + '</td>';

                    // For each staff member, check if they have a job at this time
                    staff.forEach(s => {
                        const staffJob = dayJobs.find(j => {
                            if (j.assigned_to !== s.id) return false;
                            if (!j.start_time || !j.end_time) return false;

                            const jobStartMinutes = convertTimeToMinutes(j.start_time);
                            const jobEndMinutes = convertTimeToMinutes(j.end_time);
                            const currentMinutes = hour * 60 + minute;

                            return currentMinutes >= jobStartMinutes && currentMinutes < jobEndMinutes;
                        });

                        if (staffJob) {
                            // Check if this is the first slot of the job (to display info)
                            const jobStartMinutes = convertTimeToMinutes(staffJob.start_time);
                            const currentMinutes = hour * 60 + minute;

                            if (currentMinutes === jobStartMinutes) {
                                // Calculate rowspan (how many 15-min slots this job takes)
                                const jobEndMinutes = convertTimeToMinutes(staffJob.end_time);
                                const duration = jobEndMinutes - jobStartMinutes;
                                const rowspan = Math.ceil(duration / 15);

                                html += '<td rowspan="' + rowspan + '" class="px-2 py-2 text-xs border" style="background-color: ' + s.color_code + '20; border-left: 3px solid ' + s.color_code + '">';
                                html += '<div class="font-semibold" style="color: ' + s.color_code + '">' + escapeHtml(staffJob.client_name) + '</div>';
                                html += '<div class="text-gray-600 text-xs">' + formatTime12Hour(staffJob.start_time) + ' - ' + formatTime12Hour(staffJob.end_time) + '</div>';
                                html += '<div class="text-gray-500 text-xs mt-1">' + escapeHtml(staffJob.suburb || 'N/A') + '</div>';
                                const statusColors = {
                                    'Assigned': 'bg-purple-100 text-purple-800',
                                    'In Progress': 'bg-blue-100 text-blue-800',
                                    'Unassigned': 'bg-gray-100 text-gray-800'
                                };
                                html += '<div class="mt-1"><span class="px-2 py-1 rounded text-xs ' + (statusColors[staffJob.status] || 'bg-gray-100 text-gray-800') + '">' + staffJob.status + '</span></div>';
                                html += '</td>';
                            }
                            // If not the first slot, the rowspan handles it (no td needed)
                        } else {
                            // Available slot
                            html += '<td class="px-2 py-2 text-center text-xs text-green-600 bg-green-50 border hover:bg-green-100 cursor-pointer" onclick="quickCreateJob(\'' + s.id + '\', \'' + selectedDate + '\', \'' + timeStr + '\')">âœ“</td>';
                        }
                    });

                    html += '</tr>';
                }
            }

            html += '</tbody>';
            html += '</table>';
            html += '</div>';

            // Legend
            html += '<div class="bg-white rounded-lg shadow p-4">';
            html += '<div class="text-sm font-semibold text-gray-700 mb-2">Legend:</div>';
            html += '<div class="flex flex-wrap gap-4 text-xs">';
            html += '<div class="flex items-center gap-2"><div class="w-4 h-4 bg-green-50 border border-green-300"></div><span class="text-gray-600">Available - Click to create job</span></div>';
            html += '<div class="flex items-center gap-2"><div class="w-4 h-4 bg-purple-100 border-l-4 border-purple-600"></div><span class="text-gray-600">Booked</span></div>';
            html += '</div>';
            html += '</div>';

            html += '</div>';
            return html;
        }

        function renderDailyScheduleView(scheduleDate, dayJobs) {
            let html = '';
            
            // Date display
            html += '<div class="bg-white rounded-lg shadow p-4">';
            html += '<div class="text-center">';
            html += '<div class="text-sm text-gray-500">Viewing Schedule For</div>';
            html += '<div class="text-2xl font-bold text-gray-900">' + scheduleDate.toLocaleDateString('en-US', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'}) + '</div>';
            html += '<div class="text-sm text-gray-600 mt-1">' + dayJobs.length + ' job(s) scheduled</div>';
            html += '</div>';
            html += '</div>';

            // Build the schedule grid
            html += '<div class="bg-white rounded-lg shadow overflow-x-auto">';
            html += '<table class="min-w-full border-collapse">';
            
            // Header row with staff names
            html += '<thead class="bg-gray-50 sticky top-0">';
            html += '<tr>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase sticky left-0 bg-gray-50 z-10 border-r-2 border-gray-300">Time</th>';
            
            staff.forEach(s => {
                html += '<th class="px-4 py-3 text-center text-xs font-medium uppercase border" style="color: ' + s.color_code + '">' + s.full_name + '</th>';
            });
            
            html += '</tr>';
            html += '</thead>';
            html += '<tbody class="bg-white">';

            // Generate time slots (5 AM to 9:30 PM in 15-minute intervals)
            for (let hour = 5; hour < 22; hour++) {
                for (let minute = 0; minute < 60; minute += 15) {
                    if (hour === 21 && minute > 30) break;

                    const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}:00`;
                    const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
                    const period = hour >= 12 ? 'PM' : 'AM';
                    const displayTime = `${displayHour}:${minute.toString().padStart(2, '0')} ${period}`;

                    html += '<tr class="border-t">';
                    html += '<td class="px-4 py-2 text-sm font-semibold text-gray-700 whitespace-nowrap sticky left-0 bg-gray-50 border-r-2 border-gray-300">' + displayTime + '</td>';

                    staff.forEach(s => {
                        const staffJob = dayJobs.find(j => {
                            if (j.assigned_to !== s.id) return false;
                            if (!j.start_time || !j.end_time) return false;

                            const jobStartMinutes = convertTimeToMinutes(j.start_time);
                            const jobEndMinutes = convertTimeToMinutes(j.end_time);
                            const currentMinutes = hour * 60 + minute;

                            return currentMinutes >= jobStartMinutes && currentMinutes < jobEndMinutes;
                        });

                        if (staffJob) {
                            const jobStartMinutes = convertTimeToMinutes(staffJob.start_time);
                            const currentMinutes = hour * 60 + minute;

                            if (currentMinutes === jobStartMinutes) {
                                const jobEndMinutes = convertTimeToMinutes(staffJob.end_time);
                                const duration = jobEndMinutes - jobStartMinutes;
                                const rowspan = Math.ceil(duration / 15);

                                html += '<td rowspan="' + rowspan + '" class="px-2 py-2 text-xs border" style="background-color: ' + s.color_code + '20; border-left: 3px solid ' + s.color_code + '">';
                                html += '<div class="font-semibold" style="color: ' + s.color_code + '">' + escapeHtml(staffJob.client_name) + '</div>';
                                html += '<div class="text-gray-600 text-xs">' + formatTime12Hour(staffJob.start_time) + ' - ' + formatTime12Hour(staffJob.end_time) + '</div>';
                                html += '<div class="text-gray-500 text-xs mt-1">' + escapeHtml(staffJob.suburb || 'N/A') + '</div>';
                                const statusColors = {
                                    'Assigned': 'bg-purple-100 text-purple-800',
                                    'In Progress': 'bg-blue-100 text-blue-800',
                                    'Unassigned': 'bg-gray-100 text-gray-800'
                                };
                                html += '<div class="mt-1"><span class="px-2 py-1 rounded text-xs ' + (statusColors[staffJob.status] || 'bg-gray-100 text-gray-800') + '">' + staffJob.status + '</span></div>';
                                html += '</td>';
                            }
                        } else {
                            const selectedDate = window.scheduleSelectedDate || new Date().toISOString().split('T')[0];
                            html += '<td class="px-2 py-2 text-center text-xs text-green-600 bg-green-50 border hover:bg-green-100 cursor-pointer" onclick="quickCreateJob(\'' + s.id + '\', \'' + selectedDate + '\', \'' + timeStr + '\')">âœ“</td>';
                        }
                    });

                    html += '</tr>';
                }
            }

            html += '</tbody>';
            html += '</table>';
            html += '</div>';

            // Legend
            html += '<div class="bg-white rounded-lg shadow p-4">';
            html += '<div class="text-sm font-semibold text-gray-700 mb-2">Legend:</div>';
            html += '<div class="flex flex-wrap gap-4 text-xs">';
            html += '<div class="flex items-center gap-2"><div class="w-4 h-4 bg-green-50 border border-green-300"></div><span class="text-gray-600">Available - Click to create job</span></div>';
            html += '<div class="flex items-center gap-2"><div class="w-4 h-4 bg-purple-100 border-l-4 border-purple-600"></div><span class="text-gray-600">Booked</span></div>';
            html += '</div>';
            html += '</div>';

            return html;
        }

        function renderWeeklyScheduleView(selectedDate) {
            let html = '';
            
            // Calculate week range (Monday to Sunday)
            const date = new Date(selectedDate);
            const dayOfWeek = date.getDay();
            const diff = date.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Adjust for Sunday
            const monday = new Date(date.setDate(diff));
            
            // Generate array of 7 days (Monday to Sunday)
            const weekDays = [];
            for (let i = 0; i < 7; i++) {
                const day = new Date(monday);
                day.setDate(monday.getDate() + i);
                weekDays.push(day);
            }
            
            // Get jobs for the entire week
            const weekJobs = jobs.filter(j => {
                if (j.status === 'Completed' || j.status === 'Cancelled') return false;
                const jobDate = new Date(j.date);
                jobDate.setHours(0, 0, 0, 0);
                return jobDate >= weekDays[0] && jobDate <= weekDays[6];
            });
            
            // Week display
            html += '<div class="bg-white rounded-lg shadow p-4 mb-4">';
            html += '<div class="text-center">';
            html += '<div class="text-sm text-gray-500">Viewing Week</div>';
            html += '<div class="text-xl font-bold text-gray-900">' + 
                    weekDays[0].toLocaleDateString('en-US', {month: 'short', day: 'numeric'}) + ' - ' + 
                    weekDays[6].toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'}) + '</div>';
            html += '<div class="text-sm text-gray-600 mt-1">' + weekJobs.length + ' job(s) this week</div>';
            html += '</div>';
            html += '</div>';
            
            // Navigation buttons
            html += '<div class="flex justify-between items-center mb-4">';
            html += '<button onclick="navigateWeek(-1)" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg flex items-center gap-2">';
            html += '<span class="material-icons md-18">chevron_left</span> Previous Week';
            html += '</button>';
            html += '<button onclick="navigateWeek(1)" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg flex items-center gap-2">';
            html += 'Next Week <span class="material-icons md-18">chevron_right</span>';
            html += '</button>';
            html += '</div>';
            
            // Staff availability summary cards
            html += '<div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-' + Math.min(staff.length, 6) + ' gap-3 mb-4">';
            staff.forEach(s => {
                const staffWeekJobs = weekJobs.filter(j => j.assigned_to === s.id);
                html += '<div class="bg-white rounded-lg shadow p-3 border-l-4" style="border-color: ' + s.color_code + '">';
                html += '<div class="text-sm font-semibold" style="color: ' + s.color_code + '">' + s.full_name + '</div>';
                html += '<div class="text-2xl font-bold text-gray-900 mt-1">' + staffWeekJobs.length + '</div>';
                html += '<div class="text-xs text-gray-500">jobs this week</div>';
                html += '</div>';
            });
            html += '</div>';
            
            // Weekly grid - simplified view showing job count per day per staff
            html += '<div class="bg-white rounded-lg shadow overflow-x-auto">';
            html += '<table class="min-w-full border-collapse">';
            html += '<thead class="bg-gray-50">';
            html += '<tr>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase sticky left-0 bg-gray-50 z-10 border-r-2 border-gray-300">Staff</th>';
            
            weekDays.forEach(day => {
                const isToday = day.toDateString() === new Date().toDateString();
                html += '<th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase border ' + (isToday ? 'bg-blue-50' : '') + '">';
                html += '<div>' + day.toLocaleDateString('en-US', {weekday: 'short'}) + '</div>';
                html += '<div class="font-bold text-gray-900">' + day.toLocaleDateString('en-US', {month: 'short', day: 'numeric'}) + '</div>';
                html += '</th>';
            });
            
            html += '</tr>';
            html += '</thead>';
            html += '<tbody class="bg-white">';
            
            staff.forEach(s => {
                html += '<tr class="border-t hover:bg-gray-50">';
                html += '<td class="px-4 py-3 font-medium sticky left-0 bg-white border-r-2 border-gray-300" style="color: ' + s.color_code + '">' + s.full_name + '</td>';
                
                weekDays.forEach(day => {
                    const dayStr = day.toISOString().split('T')[0];
                    const isToday = day.toDateString() === new Date().toDateString();
                    const dayJobsForStaff = weekJobs.filter(j => {
                        const jobDate = new Date(j.date);
                        return j.assigned_to === s.id && jobDate.toDateString() === day.toDateString();
                    });
                    
                    html += '<td class="px-2 py-2 border text-center ' + (isToday ? 'bg-blue-50' : '') + '" style="min-width: 120px;">';
                    
                    if (dayJobsForStaff.length > 0) {
                        // Show job summary
                        html += '<div class="space-y-1">';
                        dayJobsForStaff.forEach(job => {
                            html += '<div class="text-xs p-2 rounded cursor-pointer hover:shadow" style="background-color: ' + s.color_code + '20; border-left: 2px solid ' + s.color_code + '" onclick="openEditModalById(\'' + job.id + '\')">';
                            html += '<div class="font-semibold truncate" style="color: ' + s.color_code + '">' + escapeHtml(job.client_name) + '</div>';
                            html += '<div class="text-gray-600">' + formatTime12Hour(job.start_time) + '</div>';
                            html += '</div>';
                        });
                        html += '</div>';
                    } else {
                        // Available - click to view day
                        html += '<button onclick="viewDaySchedule(\'' + dayStr + '\')" class="w-full py-4 text-green-600 hover:bg-green-50 rounded text-sm font-medium">';
                        html += 'âœ“ Available';
                        html += '</button>';
                    }
                    
                    html += '</td>';
                });
                
                html += '</tr>';
            });
            
            html += '</tbody>';
            html += '</table>';
            html += '</div>';
            
            // Legend
            html += '<div class="bg-white rounded-lg shadow p-4 mt-4">';
            html += '<div class="text-sm font-semibold text-gray-700 mb-2">Legend:</div>';
            html += '<div class="flex flex-wrap gap-4 text-xs">';
            html += '<div class="flex items-center gap-2"><div class="w-4 h-4 bg-green-50 border border-green-300"></div><span class="text-gray-600">Available - Click to view day</span></div>';
            html += '<div class="flex items-center gap-2"><div class="w-4 h-4 bg-blue-50 border border-blue-300"></div><span class="text-gray-600">Today</span></div>';
            html += '<div class="flex items-center gap-2"><div class="w-4 h-4 bg-purple-100 border-l-4 border-purple-600"></div><span class="text-gray-600">Booked - Click job to view details</span></div>';
            html += '</div>';
            html += '</div>';
            
            return html;
        }

        function navigateWeek(direction) {
            const currentDate = window.scheduleSelectedDate ? new Date(window.scheduleSelectedDate) : new Date();
            currentDate.setDate(currentDate.getDate() + (direction * 7));
            window.scheduleSelectedDate = currentDate.toISOString().split('T')[0];
            renderApp();
        }

        function viewDaySchedule(dateStr) {
            window.scheduleSelectedDate = dateStr;
            scheduleViewMode = 'daily';
            renderApp();
        }

        function convertTimeToMinutes(timeStr) {
            if (!timeStr) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function checkTimeSlotConflict(staffId, date, startTime, endTime, excludeJobId = null) {
            if (!staffId || !date || !startTime || !endTime) return null;
            
            const startMinutes = convertTimeToMinutes(startTime);
            const endMinutes = convertTimeToMinutes(endTime);
            
            // Find conflicting jobs for this staff member on this date
            const conflicts = jobs.filter(j => {
                // Skip the job being edited
                if (excludeJobId && j.id === excludeJobId) return false;
                
                // Skip completed/cancelled jobs
                if (j.status === 'Completed' || j.status === 'Cancelled') return false;
                
                // Must be same staff and same date
                if (j.assigned_to !== staffId) return false;
                if (j.date !== date) return false;
                
                // Check for time overlap
                if (!j.start_time || !j.end_time) return false;
                
                const jobStartMinutes = convertTimeToMinutes(j.start_time);
                const jobEndMinutes = convertTimeToMinutes(j.end_time);
                
                // Check if times overlap
                // Overlap occurs if: new start < existing end AND new end > existing start
                return (startMinutes < jobEndMinutes && endMinutes > jobStartMinutes);
            });
            
            return conflicts.length > 0 ? conflicts : null;
        }

        function quickCreateJob(staffId, date, time) {
            if (confirm('Create a new job for this time slot?\n\nStaff: ' + staff.find(s => s.id === staffId).full_name + '\nDate: ' + date + '\nTime: ' + formatTime12Hour(time))) {
                // Store the prefilled data and switch to create job view
                window.prefillJobData = {
                    staff: staffId,
                    date: date,
                    startTime: time
                };
                changeView('create-job');
            }
        }

        function renderWeeklyReviewReport() {
            const staffStats = getStaffReviewStats(reviewReportPeriod);

            // Calculate totals
            const totalReviews = staffStats.reduce((sum, s) => sum + s.reviewCount, 0);
            const totalRatings = staffStats.reduce((sum, s) => sum + s.ratings, 0);
            const avgRating = totalRatings > 0
                ? (staffStats.reduce((sum, s) => sum + (parseFloat(s.avgRating) * s.ratings), 0) / totalRatings).toFixed(1)
                : 0;

            let html = '<div class="bg-white rounded-lg shadow p-6 mt-6">';
            html += '<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-6">';
            html += '<h3 class="text-xl font-semibold text-gray-900">Weekly Review Performance</h3>';
            html += '<div class="flex gap-2">';
            html += '<select onchange="reviewReportPeriod = this.value; renderApp();" class="px-4 py-2 border rounded-lg text-sm">';
            html += '<option value="this_week"' + (reviewReportPeriod === 'this_week' ? ' selected' : '') + '>This Week</option>';
            html += '<option value="last_week"' + (reviewReportPeriod === 'last_week' ? ' selected' : '') + '>Last Week</option>';
            html += '<option value="this_month"' + (reviewReportPeriod === 'this_month' ? ' selected' : '') + '>This Month</option>';
            html += '<option value="last_month"' + (reviewReportPeriod === 'last_month' ? ' selected' : '') + '>Last Month</option>';
            html += '<option value="last_3_months"' + (reviewReportPeriod === 'last_3_months' ? ' selected' : '') + '>Last 3 Months</option>';
            html += '</select>';
            html += '<button onclick="exportWeeklyReviewReport()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2 text-sm">';
            html += '<span class="material-icons md-18">download</span> Export';
            html += '</button>';
            html += '</div>';
            html += '</div>';

            // Summary cards
            html += '<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">';
            html += '<div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-6 text-white">';
            html += '<div class="text-sm opacity-90 mb-1">Total Reviews</div>';
            html += '<div class="text-3xl font-bold">' + totalReviews + '</div>';
            html += '<div class="text-sm opacity-80 mt-1">' + totalRatings + ' rated</div>';
            html += '</div>';
            html += '<div class="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-lg p-6 text-white">';
            html += '<div class="text-sm opacity-90 mb-1">Average Rating</div>';
            html += '<div class="text-3xl font-bold">' + (avgRating > 0 ? avgRating + ' â˜…' : 'N/A') + '</div>';
            html += '</div>';
            html += '<div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg p-6 text-white">';
            html += '<div class="text-sm opacity-90 mb-1">Top Performer</div>';
            html += '<div class="text-xl font-bold">' + (staffStats[0] && staffStats[0].reviewCount > 0 ? staffStats[0].name : 'N/A') + '</div>';
            html += '<div class="text-sm opacity-80">' + (staffStats[0] && staffStats[0].reviewCount > 0 ? staffStats[0].reviewCount + ' reviews' : '') + '</div>';
            html += '</div>';
            html += '</div>';

            if (totalReviews === 0) {
                html += '<div class="text-center py-8 text-gray-500">No reviews for this period</div>';
                html += '</div>';
                return html;
            }

            // Staff breakdown table
            html += '<div class="overflow-x-auto">';
            html += '<table class="min-w-full">';
            html += '<thead class="bg-gray-50">';
            html += '<tr>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rank</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Staff</th>';
            html += '<th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Reviews</th>';
            html += '<th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Rated</th>';
            html += '<th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Avg Rating</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Performance</th>';
            html += '</tr>';
            html += '</thead>';
            html += '<tbody class="bg-white divide-y divide-gray-200">';

            staffStats.forEach((s, idx) => {
                if (s.reviewCount === 0) return;

                const performanceBar = s.avgRating > 0 ? ((parseFloat(s.avgRating) / 5) * 100) : 0;
                const medalEmoji = idx === 0 ? 'ðŸ¥‡ ' : idx === 1 ? 'ðŸ¥ˆ ' : idx === 2 ? 'ðŸ¥‰ ' : '';

                html += '<tr class="hover:bg-gray-50">';
                html += '<td class="px-4 py-3 text-sm font-bold text-gray-500">' + medalEmoji + (idx + 1) + '</td>';
                html += '<td class="px-4 py-3"><span style="color: ' + s.color + '" class="font-medium text-sm">' + escapeHtml(s.name) + '</span></td>';
                html += '<td class="px-4 py-3 text-right font-semibold text-sm">' + s.reviewCount + '</td>';
                html += '<td class="px-4 py-3 text-right text-sm">' + s.ratings + '</td>';
                html += '<td class="px-4 py-3 text-right text-sm">';
                if (s.avgRating > 0) {
                    html += '<div class="flex flex-col items-end">';
                    html += '<span class="text-yellow-500 text-lg">' + 'â˜…'.repeat(Math.round(parseFloat(s.avgRating))) + '</span>';
                    html += '<span class="text-gray-600 text-xs">' + s.avgRating + '/5</span>';
                    html += '</div>';
                } else {
                    html += '<span class="text-gray-400">Not rated</span>';
                }
                html += '</td>';
                html += '<td class="px-4 py-3">';
                html += '<div class="flex items-center gap-2">';
                html += '<div class="flex-1 bg-gray-200 rounded-full h-3">';
                html += '<div class="bg-green-600 h-3 rounded-full transition-all" style="width: ' + performanceBar.toFixed(1) + '%"></div>';
                html += '</div>';
                html += '<span class="text-xs text-gray-600 font-medium min-w-[45px]">' + performanceBar.toFixed(1) + '%</span>';
                html += '</div>';
                html += '</td>';
                html += '</tr>';
            });

            html += '</tbody>';
            html += '</table>';
            html += '</div>';
            html += '</div>';

            return html;
        }
        function exportWeeklyReviewReport() {
            const {startDate, endDate} = getDateRangeForPeriod(reviewReportPeriod);
            const staffStats = getStaffReviewStats(reviewReportPeriod);

            const periodLabels = {
                'this_week': 'This Week',
                'last_week': 'Last Week',
                'this_month': 'This Month',
                'last_month': 'Last Month',
                'last_3_months': 'Last 3 Months'
            };

            let csv = 'WEEKLY REVIEW PERFORMANCE REPORT\n';
            csv += 'Period: ' + periodLabels[reviewReportPeriod] + '\n';
            csv += 'Date Range: ' + startDate.toLocaleDateString() + ' to ' + endDate.toLocaleDateString() + '\n';
            csv += 'Generated: ' + new Date().toLocaleString() + '\n\n';

            // Calculate totals
            const totalReviews = staffStats.reduce((sum, s) => sum + s.reviewCount, 0);
            const totalRatings = staffStats.reduce((sum, s) => sum + s.ratings, 0);
            const avgRating = totalRatings > 0
                ? (staffStats.reduce((sum, s) => sum + (parseFloat(s.avgRating) * s.ratings), 0) / totalRatings).toFixed(1)
                : 0;

            csv += 'SUMMARY\n';
            csv += 'Total Reviews,' + totalReviews + '\n';
            csv += 'Total Rated Reviews,' + totalRatings + '\n';
            csv += 'Overall Average Rating,' + avgRating + '\n\n';

            csv += 'STAFF BREAKDOWN\n';
            csv += 'Rank,Staff Member,Total Reviews,Rated Reviews,Average Rating,Performance %\n';

            staffStats.forEach((s, idx) => {
                if (s.reviewCount === 0) return;

                const performance = s.avgRating > 0 ? ((parseFloat(s.avgRating) / 5) * 100).toFixed(1) : 0;
                csv += [
                    idx + 1,
                    s.name,
                    s.reviewCount,
                    s.ratings,
                    s.avgRating > 0 ? s.avgRating : 'Not rated',
                    performance + '%'
                ].join(',') + '\n';
            });

            // Download CSV
            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const timestamp = new Date().toISOString().split('T')[0];
            const filename = 'review_report_' + reviewReportPeriod + '_' + timestamp + '.csv';

            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function renderReviewRequests() {
            // Filter jobs by status
            const pendingJobs = jobs.filter(j =>
                j.status === 'Completed' &&
                j.request_review === true &&
                j.review_sent !== true
            );

            const sentJobs = jobs.filter(j =>
                j.status === 'Completed' &&
                j.review_sent === true &&
                j.review_received !== true
            );

            const receivedJobs = jobs.filter(j =>
                j.status === 'Completed' &&
                j.review_received === true
            );

            let html = '<div class="space-y-6">';

            // Header with tabs
            html += '<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4">';
            html += '<h2 class="text-2xl font-bold text-gray-900">Review Management</h2>';
            html += '</div>';

            // Tab buttons
            html += '<div class="bg-white rounded-lg shadow p-2 flex gap-2 mb-4">';
            html += '<button onclick="currentReviewTab = \'pending\'; renderApp();" class="flex-1 px-4 py-2 rounded ' + (typeof currentReviewTab === 'undefined' || currentReviewTab === 'pending' ? 'bg-yellow-500 text-white' : 'bg-gray-100 text-gray-700') + ' font-medium text-sm">Pending (' + pendingJobs.length + ')</button>';
            html += '<button onclick="currentReviewTab = \'sent\'; renderApp();" class="flex-1 px-4 py-2 rounded ' + (currentReviewTab === 'sent' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-700') + ' font-medium text-sm">Sent (' + sentJobs.length + ')</button>';
            html += '<button onclick="currentReviewTab = \'received\'; renderApp();" class="flex-1 px-4 py-2 rounded ' + (currentReviewTab === 'received' ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-700') + ' font-medium text-sm">Received (' + receivedJobs.length + ')</button>';
            html += '</div>';

            // Staff filter dropdown
            const staffOptions = staff.map(s => '<option value="' + s.id + '"' + (currentStaffFilter === s.id ? ' selected' : '') + '>' + s.full_name + '</option>').join('');
            html += '<div class="flex justify-between items-center mb-4">';
            html += '<select onchange="currentStaffFilter = this.value; renderApp();" class="px-4 py-2 border rounded-lg text-sm">';
            html += '<option value="">All Staff</option>' + staffOptions;
            html += '</select>';
            html += '<div class="text-sm text-gray-600">Showing: <span class="font-bold">' + (currentStaffFilter ? staff.find(s => s.id === currentStaffFilter).full_name : 'All Staff') + '</span></div>';
            html += '</div>';

            // Determine which jobs to show based on tab
            let displayJobs = pendingJobs;

            // Apply staff filter if selected
            if (currentStaffFilter) {
                displayJobs = displayJobs.filter(j => j.assigned_to === currentStaffFilter);
            }

            let emptyMessage = 'No pending review requests';
            let showSentButton = true;
            let showReceivedButton = false;

            if (currentReviewTab === 'sent') {
                displayJobs = sentJobs;
                emptyMessage = 'No sent review requests awaiting response';
                showSentButton = false;
                showReceivedButton = true;
                // Apply staff filter
                if (currentStaffFilter) {
                    displayJobs = displayJobs.filter(j => j.assigned_to === currentStaffFilter);
                }
            } else if (currentReviewTab === 'received') {
                displayJobs = receivedJobs;
                emptyMessage = 'No reviews received yet';
                showSentButton = false;
                showReceivedButton = false;
                // Apply staff filter
                if (currentStaffFilter) {
                    displayJobs = displayJobs.filter(j => j.assigned_to === currentStaffFilter);
                }
            }

            if (displayJobs.length === 0) {
                html += '<div class="bg-white rounded-lg shadow p-12 text-center">';
                html += '<span class="material-icons text-gray-300" style="font-size: 64px;">rate_review</span>';
                html += '<p class="text-gray-500 mt-4">' + emptyMessage + '</p>';
                html += '</div>';
                html += '</div>';
                return html;
            }

            html += '<div class="bg-white rounded-lg shadow overflow-x-auto">';
            html += '<table class="min-w-full">';
            html += '<thead class="bg-gray-50">';
            html += '<tr>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Client</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Suburb</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Phone</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Staff</th>';
            if (currentReviewTab === 'received') {
                html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Received</th>';
            }
            if (currentReviewTab === 'received') {
                html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rating</th>';
            }
            if (showSentButton || showReceivedButton) {
                html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>';
            }
            html += '</tr>';
            html += '</thead>';
            html += '<tbody class="bg-white divide-y divide-gray-200">';

            displayJobs.forEach(job => {
                const staffName = job.staff ? job.staff.full_name : 'Unassigned';
                const staffColor = job.staff ? job.staff.color_code : '#666';

                html += '<tr class="hover:bg-gray-50">';
                html += '<td class="px-4 py-3 text-sm whitespace-nowrap">' + new Date(job.date).toLocaleDateString() + '</td>';
                html += '<td class="px-4 py-3 text-sm font-medium">' + escapeHtml(job.client_name) + '</td>';
                html += '<td class="px-4 py-3 text-sm">' + escapeHtml(job.suburb || 'N/A') + '</td>';
                html += '<td class="px-4 py-3 text-sm">' + escapeHtml(job.client_phone) + '</td>';
                html += '<td class="px-4 py-3 text-sm">' + (job.client_email ? escapeHtml(job.client_email) : '<span class="text-gray-400">No email</span>') + '</td>';
                html += '<td class="px-4 py-3 text-sm"><span style="color: ' + staffColor + '">' + staffName + '</span></td>';

                if (currentReviewTab === 'received') {
                    const receivedDate = job.review_received_date ? new Date(job.review_received_date).toLocaleDateString() : 'N/A';
                    html += '<td class="px-4 py-3 text-sm">' + receivedDate + '</td>';
                }

                if (currentReviewTab === 'received') {
                    const ratingDisplay = job.review_rating
                        ? '<span class="text-yellow-500">' + 'â˜…'.repeat(job.review_rating) + '</span>'
                        : '<button onclick="openRatingModal(\'' + job.id + '\')" class="text-blue-600 hover:text-blue-800 text-xs">Add Rating</button>';
                    html += '<td class="px-4 py-3 text-sm">' + ratingDisplay + '</td>';
                }

                if (showSentButton || showReceivedButton) {
                    html += '<td class="px-4 py-3 text-sm whitespace-nowrap">';
                    if (showSentButton) {
                        html += '<button onclick="markReviewSent(\'' + job.id + '\')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs font-medium">Mark as Sent</button>';
                    }
                    if (showReceivedButton) {
                        html += '<button onclick="markReviewReceived(\'' + job.id + '\')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs font-medium">Review Received</button>';
                    }
                    html += '</td>';
                }

                html += '</tr>';
            });

            html += '</tbody>';
            html += '</table>';
            html += '</div>';
            html += '</div>'; // Close the reviews table section

            // Add weekly report
            html += renderWeeklyReviewReport();

            html += '</div>'; // Close main container
            return html;
        }

        async function handleLogin(e) {
            e.preventDefault();
            await login(document.getElementById('username').value, document.getElementById('password').value);
        }

        async function handleJobSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const assignedTo = formData.get('assigned_to') || null;
            const date = formData.get('date');
            const startTime = formData.get('start_time');
            const endTime = formData.get('end_time');
            
            if (endTime <= startTime) {
                alert('End time must be after start time.');
                return;
            }

            // Check for conflicts if staff is assigned
        if (assignedTo) {
            const conflicts = checkTimeSlotConflict(assignedTo, date, startTime, endTime);
            if (conflicts) {
                const staffMember = staff.find(s => s.id === assignedTo);
                const conflictJob = conflicts[0];
                alert('âŒ TIME SLOT CONFLICT!\n\n' +
                    'Staff: ' + (staffMember ? staffMember.full_name : 'Unknown') + '\n' +
                    'Date: ' + new Date(date).toLocaleDateString() + '\n' +
                    'Your time: ' + formatTime12Hour(startTime) + ' - ' + formatTime12Hour(endTime) + '\n\n' +
                    'CONFLICTS WITH:\n' +
                    'Client: ' + conflictJob.client_name + '\n' +
                    'Time: ' + formatTime12Hour(conflictJob.start_time) + ' - ' + formatTime12Hour(conflictJob.end_time) + '\n' +
                    'Status: ' + conflictJob.status + '\n\n' +
                    'Please choose a different time or staff member.');
                return;
            }
        }

            const jobData = {
                date: date,
                start_time: startTime,
                end_time: endTime,
                client_name: formData.get('client_name'),
                client_phone: formData.get('client_phone'),
                client_email: formData.get('client_email') || null,
                address: formData.get('address'),
                suburb: formData.get('suburb'),
                job_description: formData.get('job_description'),
                price: parseFloat(formData.get('price')),
                price_includes_gst: formData.get('price_includes_gst') === 'true',
                priority: formData.get('priority'),
                status: formData.get('status') || 'Unassigned',
                assigned_to: assignedTo,
                contact_method: formData.get('contact_method') || null,
                photo_urls: null
            };

            try {
                // Step 1: Create the job first
                const {data: newJob, error: createError} = await supabaseClient
                    .from('jobs')
                    .insert([jobData])
                    .select()
                    .single();

                if (createError) throw createError;

                // Step 2: Check if user selected photos to upload
                const fileInput = document.getElementById('createJobPhotoUpload');
                const files = fileInput ? fileInput.files : null;

                if (files && files.length > 0 && newJob && newJob.id) {
                    // Show uploading message
                    const submitButton = e.target.querySelector('button[type="submit"]');
                    const originalButtonText = submitButton.innerHTML;
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<span class="flex items-center justify-center"><svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Uploading photos...</span>';

                    try {
                        // Upload all photos
                        const uploadPromises = Array.from(files).map(file => 
                            uploadImageToSupabase(file, newJob.id)
                        );
                        
                        const photoUrls = await Promise.all(uploadPromises);

                        // Update job with photo URLs
                        const {error: updateError} = await supabaseClient
                            .from('jobs')
                            .update({photo_urls: photoUrls})
                            .eq('id', newJob.id);

                        if (updateError) throw updateError;

                        alert('Job created successfully with ' + files.length + ' photo(s)!');
                    } catch (uploadError) {
                        console.error('Error uploading photos:', uploadError);
                        alert('Job created, but failed to upload photos: ' + uploadError.message);
                    }
                } else {
                    alert('Job created successfully!');
                }

                await loadJobs();
                currentView = 'dashboard';
                renderApp();
            } catch (error) {
                console.error('Error creating job:', error);
                alert('Failed to create job: ' + error.message);
            }
        }

        function filterByStaff(staffId) {
            currentView = 'all-jobs';
            currentStaffFilter = staffId;
            currentDateFilter = '';
            renderApp();
        }

        function changeView(view) {
            currentView = view;
            currentStaffFilter = '';
            currentDateFilter = '';
            window.statusFilter = '';
            currentReviewTab = 'pending';

            // Set default columns for Completed Jobs
            if (view === 'completed-jobs') {
                visibleColumns = {
                    date: true,
                    start_time: false,
                    end_time: false,
                    assigned_to: true,
                    status: false,
                    client_name: false,
                    address: false,
                    suburb: true,
                    phone: false,
                    description: false,
                    price: true,
                    email: false,
                    amount_paid: true,
                    payment_method: true,
                    photos: false,
                    notes: false,
                    contact_method: false
                };
            } else {
                // Reset to default columns for other views
                visibleColumns = {
                    date: true,
                    start_time: true,
                    end_time: true,
                    assigned_to: true,
                    status: true,
                    client_name: true,
                    address: true,
                    suburb: true,
                    phone: true,
                    description: true,
                    price: true,
                    email: false,
                    amount_paid: false,
                    payment_method: false,
                    photos: false,
                    notes: false,
                    contact_method: false
                };
            }

            renderApp();
        }

        async function initialize() {
            checkAuth();
            if (currentUser) {
                await loadStaff();
                await loadJobs();
            }
            renderApp();
            if (currentUser) {
                setInterval(async () => {
                    await loadJobs();
                    if (currentView === 'dashboard' || currentView === 'all-jobs' || currentView === 'completed-jobs') renderApp();
                }, 120000);
            }

            // Photo upload handler
            const photoUploadInput = document.getElementById('photoUpload');
            if (photoUploadInput) {
                photoUploadInput.addEventListener('change', async function (e) {
                    const files = e.target.files;
                    if (!files || files.length === 0) return;

                    const jobId = document.getElementById('edit_job_id').value;
                    if (!jobId) {
                        alert('Please save the job first before uploading photos.');
                        return;
                    }

                    const statusSpan = document.getElementById('uploadStatus');
                    statusSpan.textContent = 'Uploading...';

                    try {
                        // Get current photo URLs
                        const {data: job, error: fetchError} = await supabaseClient
                            .from('jobs')
                            .select('photo_urls')
                            .eq('id', jobId)
                            .single();

                        if (fetchError) throw fetchError;

                        const currentUrls = job.photo_urls || [];

                        // Upload all selected files
                        const uploadPromises = Array.from(files).map(file =>
                            uploadImageToSupabase(file, jobId)
                        );

                        const newUrls = await Promise.all(uploadPromises);

                        // Combine with existing URLs
                        const allUrls = [...currentUrls, ...newUrls];

                        // Update database
                        const {error: updateError} = await supabaseClient
                            .from('jobs')
                            .update({photo_urls: allUrls})
                            .eq('id', jobId);

                        if (updateError) throw updateError;

                        // CRITICAL: Refresh jobs data RIGHT AFTER database update
                        await loadJobs();

                        statusSpan.textContent = `âœ“ ${files.length} photo(s) uploaded`;

                        // Refresh the photo preview
                        const photoPreview = document.getElementById('photoPreview');
                        photoPreview.innerHTML = allUrls.map((url, index) => `
                        <div class="relative group">
                            <img src="${url}" alt="Job Photo ${index + 1}" class="w-full h-24 object-cover rounded border border-gray-300">
                            <button type="button" onclick="removePhotoFromEdit(${index})" 
                                class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                Ã—
                            </button>
                        </div>
                    `).join('');

                        setTimeout(() => {
                            statusSpan.textContent = '';
                        }, 3000);

                    } catch (error) {
                        console.error('Error uploading photos:', error);
                        statusSpan.textContent = 'âœ— Upload failed';
                        alert('Failed to upload photos: ' + error.message);
                    }

                    // Clear the input
                    e.target.value = '';
                });
            }
        }

        function filterCompletedToday() {
            currentView = 'completed-jobs';
            currentDateFilter = 'today';
            currentStaffFilter = '';
            renderApp();
        }

        function filterTodayUnassigned() {
            currentView = 'all-jobs';
            currentDateFilter = 'today';
            currentStaffFilter = '';
            // Store the status filter
            window.statusFilter = 'Unassigned';
            renderApp();
        }

        function filterTodayAssigned() {
            currentView = 'all-jobs';
            currentDateFilter = 'today';
            currentStaffFilter = '';
            // Store the status filter
            window.statusFilter = 'Assigned';
            renderApp();
        }

        initialize();

        // Close dropdowns when clicking outside
        document.addEventListener('click', function (event) {
            const clickedElement = event.target;
            const isColumnSelector = clickedElement.closest('.relative');

            if (columnSelectorOpen && !isColumnSelector) {
                columnSelectorOpen = false;
                renderApp();
            }
        })
    </script>
</body>

</html>
